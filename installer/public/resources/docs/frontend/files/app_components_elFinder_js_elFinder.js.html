<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app\components\elFinder\js\elFinder.js - umi-cms-3</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="umi-cms-3"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ApplicationRoute.html">ApplicationRoute</a></li>
            
                <li><a href="../classes/ComponentController.html">ComponentController</a></li>
            
                <li><a href="../classes/dialogelfinder - open elFinder in dialog window.html">dialogelfinder - open elFinder in dialog window</a></li>
            
                <li><a href="../classes/DS.ManyArray.html">DS.ManyArray</a></li>
            
                <li><a href="../classes/elFinder - file manager for web.html">elFinder - file manager for web</a></li>
            
                <li><a href="../classes/elFinder command &quot;archive&quot;
Archive selected files.html">elFinder command &quot;archive&quot;
Archive selected files</a></li>
            
                <li><a href="../classes/elFinder command &quot;back&quot;
Open last visited folder.html">elFinder command &quot;back&quot;
Open last visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;copy&quot;.
Put files in filemanager clipboard..html">elFinder command &quot;copy&quot;.
Put files in filemanager clipboard.</a></li>
            
                <li><a href="../classes/elFinder command &quot;download&quot;. 
Download selected files.
Only for new api.html">elFinder command &quot;download&quot;. 
Download selected files.
Only for new api</a></li>
            
                <li><a href="../classes/elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;.html">elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;</a></li>
            
                <li><a href="../classes/elFinder command &quot;edit&quot;. 
Edit text file in dialog window.html">elFinder command &quot;edit&quot;. 
Edit text file in dialog window</a></li>
            
                <li><a href="../classes/elFinder command &quot;extract&quot;
Extract files from archive.html">elFinder command &quot;extract&quot;
Extract files from archive</a></li>
            
                <li><a href="../classes/elFinder command &quot;forward&quot;
Open next visited folder.html">elFinder command &quot;forward&quot;
Open next visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc..html">elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc.</a></li>
            
                <li><a href="../classes/elFinder command &quot;help&quot;
&quot;About&quot; dialog.html">elFinder command &quot;help&quot;
&quot;About&quot; dialog</a></li>
            
                <li><a href="../classes/elFinder command &quot;info&quot;. 
Display dialog with file properties..html">elFinder command &quot;info&quot;. 
Display dialog with file properties.</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkdir&quot;
Create new folder.html">elFinder command &quot;mkdir&quot;
Create new folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkfile&quot;
Create new empty file.html">elFinder command &quot;mkfile&quot;
Create new empty file</a></li>
            
                <li><a href="../classes/elFinder command &quot;netmount&quot;
Mount network volume with user credentials..html">elFinder command &quot;netmount&quot;
Mount network volume with user credentials.</a></li>
            
                <li><a href="../classes/elFinder command &quot;open&quot;
Enter folder or open files in new windows.html">elFinder command &quot;open&quot;
Enter folder or open files in new windows</a></li>
            
                <li><a href="../classes/elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created.html">elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created</a></li>
            
                <li><a href="../classes/elFinder command &quot;quicklook&quot;
Fast preview for some files types.html">elFinder command &quot;quicklook&quot;
Fast preview for some files types</a></li>
            
                <li><a href="../classes/elFinder command &quot;reload&quot;
Sync files and folders.html">elFinder command &quot;reload&quot;
Sync files and folders</a></li>
            
                <li><a href="../classes/elFinder command &quot;rename&quot;. 
Rename selected file..html">elFinder command &quot;rename&quot;. 
Rename selected file.</a></li>
            
                <li><a href="../classes/elFinder command &quot;resize&quot;
Open dialog to resize image.html">elFinder command &quot;resize&quot;
Open dialog to resize image</a></li>
            
                <li><a href="../classes/elFinder command &quot;rm&quot;
Delete files.html">elFinder command &quot;rm&quot;
Delete files</a></li>
            
                <li><a href="../classes/elFinder command &quot;search&quot;
Find files.html">elFinder command &quot;search&quot;
Find files</a></li>
            
                <li><a href="../classes/elFinder command &quot;sort&quot;
Change sort files rule.html">elFinder command &quot;sort&quot;
Change sort files rule</a></li>
            
                <li><a href="../classes/elFinder command &quot;up&quot;
Go into parent directory.html">elFinder command &quot;up&quot;
Go into parent directory</a></li>
            
                <li><a href="../classes/elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop.html">elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop</a></li>
            
                <li><a href="../classes/elFinder command &quot;view&quot;
Change current directory view (icons/list).html">elFinder command &quot;view&quot;
Change current directory view (icons/list)</a></li>
            
                <li><a href="../classes/elFinder contextmenu.html">elFinder contextmenu</a></li>
            
                <li><a href="../classes/elFinder dialog.html">elFinder dialog</a></li>
            
                <li><a href="../classes/elFinder folders tree.html">elFinder folders tree</a></li>
            
                <li><a href="../classes/elFinder places/favorites ui.html">elFinder places/favorites ui</a></li>
            
                <li><a href="../classes/elFinder toolbar.html">elFinder toolbar</a></li>
            
                <li><a href="../classes/elFinder toolbar button menu with sort variants..html">elFinder toolbar button menu with sort variants.</a></li>
            
                <li><a href="../classes/elFinder toolbar button to switch current directory view..html">elFinder toolbar button to switch current directory view.</a></li>
            
                <li><a href="../classes/elFinder toolbar button widget.
If command has variants - create menu.html">elFinder toolbar button widget.
If command has variants - create menu</a></li>
            
                <li><a href="../classes/elFinder toolbar search button widget..html">elFinder toolbar search button widget.</a></li>
            
                <li><a href="../classes/elFinder toolbar&#x27;s button tor upload file.html">elFinder toolbar&#x27;s button tor upload file</a></li>
            
                <li><a href="../classes/elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder.html">elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder</a></li>
            
                <li><a href="../classes/elFinder ui
Display number of files/selected files and its size in statusbar.html">elFinder ui
Display number of files/selected files and its size in statusbar</a></li>
            
                <li><a href="../classes/elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods.html">elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods</a></li>
            
                <li><a href="../classes/elfindernav - elFinder container for diretories tree and places.html">elfindernav - elFinder container for diretories tree and places</a></li>
            
                <li><a href="../classes/elfinderworkzone - elFinder container for nav and current directory.html">elfinderworkzone - elFinder container for nav and current directory</a></li>
            
                <li><a href="../classes/IndexRoute.html">IndexRoute</a></li>
            
                <li><a href="../classes/Inflector.inflector.html">Inflector.inflector</a></li>
            
                <li><a href="../classes/map.html">map</a></li>
            
                <li><a href="../classes/UmiRESTAdapter.html">UmiRESTAdapter</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Router.html">Router</a></li>
            
                <li><a href="../modules/UMI.html">UMI</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app\components\elFinder\js\elFinder.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&quot;use strict&quot;;
/**
 * @class elFinder - file manager for web
 *
 * @author Dmitry (dio) Levashov
 **/
window.elFinder = function(node, opts) {
	this.time(&#x27;load&#x27;);

	var self = this,
		
		/**
		 * Node on which elfinder creating
		 *
		 * @type jQuery
		 **/
		node = $(node),
		
		/**
		 * Store node contents.
		 *
		 * @see this.destroy
		 * @type jQuery
		 **/
		prevContent = $(&#x27;&lt;div/&gt;&#x27;).append(node.contents()),
		
		/**
		 * Store node inline styles
		 *
		 * @see this.destroy
		 * @type String
		 **/
		prevStyle = node.attr(&#x27;style&#x27;),
		
		/**
		 * Instance ID. Required to get/set cookie
		 *
		 * @type String
		 **/
		id = node.attr(&#x27;id&#x27;) || &#x27;&#x27;,
		
		/**
		 * Events namespace
		 *
		 * @type String
		 **/
		namespace = &#x27;elfinder-&#x27;+(id || Math.random().toString().substr(2, 7)),
		
		/**
		 * Mousedown event
		 *
		 * @type String
		 **/
		mousedown = &#x27;mousedown.&#x27;+namespace,
		
		/**
		 * Keydown event
		 *
		 * @type String
		 **/
		keydown = &#x27;keydown.&#x27;+namespace,
		
		/**
		 * Keypress event
		 *
		 * @type String
		 **/
		keypress = &#x27;keypress.&#x27;+namespace,
		
		/**
		 * Is shortcuts/commands enabled
		 *
		 * @type Boolean
		 **/
		enabled = true,
		
		/**
		 * Store enabled value before ajax requiest
		 *
		 * @type Boolean
		 **/
		prevEnabled = true,
		
		/**
		 * List of build-in events which mapped into methods with same names
		 *
		 * @type Array
		 **/
		events = [&#x27;enable&#x27;, &#x27;disable&#x27;, &#x27;load&#x27;, &#x27;open&#x27;, &#x27;reload&#x27;, &#x27;select&#x27;,  &#x27;add&#x27;, &#x27;remove&#x27;, &#x27;change&#x27;, &#x27;dblclick&#x27;, &#x27;getfile&#x27;, &#x27;lockfiles&#x27;, &#x27;unlockfiles&#x27;, &#x27;dragstart&#x27;, &#x27;dragstop&#x27;],
		
		/**
		 * Rules to validate data from backend
		 *
		 * @type Object
		 **/
		rules = {},
		
		/**
		 * Current working directory hash
		 *
		 * @type String
		 **/
		cwd = &#x27;&#x27;,
		
		/**
		 * Current working directory options
		 *
		 * @type Object
		 **/
		cwdOptions = {
			path          : &#x27;&#x27;,
			url           : &#x27;&#x27;,
			tmbUrl        : &#x27;&#x27;,
			disabled      : [],
			separator     : &#x27;/&#x27;,
			archives      : [],
			extract       : [],
			copyOverwrite : true,
			uploadMaxSize : 0,
			tmb           : false // old API
		},
		
		/**
		 * Files/dirs cache
		 *
		 * @type Object
		 **/
		files = {},
		
		/**
		 * Selected files hashes
		 *
		 * @type Array
		 **/
		selected = [],
		
		/**
		 * Events listeners
		 *
		 * @type Object
		 **/
		listeners = {},
		
		/**
		 * Shortcuts
		 *
		 * @type Object
		 **/
		shortcuts = {},
		
		/**
		 * Buffer for copied files
		 *
		 * @type Array
		 **/
		clipboard = [],
		
		/**
		 * Copied/cuted files hashes
		 * Prevent from remove its from cache.
		 * Required for dispaly correct files names in error messages
		 *
		 * @type Array
		 **/
		remember = [],
		
		/**
		 * Queue for &#x27;open&#x27; requests
		 *
		 * @type Array
		 **/
		queue = [],
		
		/**
		 * Net drivers names
		 *
		 * @type Array
		 **/
		netDrivers = [],
		
		/**
		 * Commands prototype
		 *
		 * @type Object
		 **/
		base = new self.command(self),
		
		/**
		 * elFinder node width
		 *
		 * @type String
		 * @default &quot;auto&quot;
		 **/
		width  = &#x27;auto&#x27;,
		
		/**
		 * elFinder node height
		 *
		 * @type Number
		 * @default 400
		 **/
		height = 400,
				
		beeper = $(document.createElement(&#x27;audio&#x27;)).hide().appendTo(&#x27;body&#x27;)[0],
			
		syncInterval,
		
		open = function(data) {
			if (data.init) {
				// init - reset cache
				files = {};
			} else {
				// remove only files from prev cwd
				for (var i in files) {
					if (files.hasOwnProperty(i) 
					&amp;&amp; files[i].mime != &#x27;directory&#x27; 
					&amp;&amp; files[i].phash == cwd
					&amp;&amp; $.inArray(i, remember) === -1) {
						delete files[i];
					}
				}
			}

			cwd = data.cwd.hash;
			cache(data.files);
			if (!files[cwd]) {
				cache([data.cwd]);
			}
			self.lastDir(cwd);
		},
		
		/**
		 * Store info about files/dirs in &quot;files&quot; object.
		 *
		 * @param  Array  files
		 * @return void
		 **/
		cache = function(data) {
			var l = data.length, f;

			while (l--) {
				f = data[l];
				if (f.name &amp;&amp; f.hash &amp;&amp; f.mime) {
					if (!f.phash) {
						var name = &#x27;volume_&#x27;+f.name,
							i18 = self.i18n(name);

						if (name != i18) {
							f.i18 = i18;
						}
					}
					files[f.hash] = f;
				} 
			}
		},
		
		/**
		 * Exec shortcut
		 *
		 * @param  jQuery.Event  keydown/keypress event
		 * @return void
		 */
		execShortcut = function(e) {
			var code    = e.keyCode,
				ctrlKey = !!(e.ctrlKey || e.metaKey);

			if (enabled) {

				$.each(shortcuts, function(i, shortcut) {
					if (shortcut.type    == e.type 
					&amp;&amp; shortcut.keyCode  == code 
					&amp;&amp; shortcut.shiftKey == e.shiftKey 
					&amp;&amp; shortcut.ctrlKey  == ctrlKey 
					&amp;&amp; shortcut.altKey   == e.altKey) {
						e.preventDefault()
						e.stopPropagation();
						shortcut.callback(e, self);
						self.debug(&#x27;shortcut-exec&#x27;, i+&#x27; : &#x27;+shortcut.description);
					}
				});
				
				// prevent tab out of elfinder
				if (code == 9 &amp;&amp; !$(e.target).is(&#x27;:input&#x27;)) {
					e.preventDefault();
				}

			}
		},
		date = new Date(),
		utc,
		i18n
		;


	/**
	 * Protocol version
	 *
	 * @type String
	 **/
	this.api = null;
	
	/**
	 * elFinder use new api
	 *
	 * @type Boolean
	 **/
	this.newAPI = false;
	
	/**
	 * elFinder use old api
	 *
	 * @type Boolean
	 **/
	this.oldAPI = false;
	
	/**
	 * User os. Required to bind native shortcuts for open/rename
	 *
	 * @type String
	 **/
	this.OS = navigator.userAgent.indexOf(&#x27;Mac&#x27;) !== -1 ? &#x27;mac&#x27; : navigator.userAgent.indexOf(&#x27;Win&#x27;) !== -1  ? &#x27;win&#x27; : &#x27;other&#x27;;
	
	/**
	 * User browser UA.
	 * jQuery.browser: version deprecated: 1.3, removed: 1.9
	 *
	 * @type Object
	 **/
	this.UA = (function(){
		var webkit = !document.uniqueID &amp;&amp; !window.opera &amp;&amp; !window.sidebar &amp;&amp; window.localStorage &amp;&amp; typeof window.orientation == &quot;undefined&quot;;
		return {
			// Browser IE &lt;= IE 6
			ltIE6:typeof window.addEventListener == &quot;undefined&quot; &amp;&amp; typeof document.documentElement.style.maxHeight == &quot;undefined&quot;,
			// Browser IE &lt;= IE 7
			ltIE7:typeof window.addEventListener == &quot;undefined&quot; &amp;&amp; typeof document.querySelectorAll == &quot;undefined&quot;,
			// Browser IE &lt;= IE 8
			ltIE8:typeof window.addEventListener == &quot;undefined&quot; &amp;&amp; typeof document.getElementsByClassName == &quot;undefined&quot;,
			IE:document.uniqueID,
			Firefox:window.sidebar,
			Opera:window.opera,
			Webkit:webkit,
			Chrome:webkit &amp;&amp; window.chrome,
			Safari:webkit &amp;&amp; !window.chrome,
			Mobile:typeof window.orientation != &quot;undefined&quot;
		}
	})();
	
	/**
	 * Configuration options
	 *
	 * @type Object
	 **/
	this.options = $.extend(true, {}, this._options, opts||{});
	
	if (opts.ui) {
		this.options.ui = opts.ui;
	}
	
	if (opts.commands) {
		this.options.commands = opts.commands;
	}
	
	if (opts.uiOptions &amp;&amp; opts.uiOptions.toolbar) {
		this.options.uiOptions.toolbar = opts.uiOptions.toolbar;
	}

	$.extend(this.options.contextmenu, opts.contextmenu);

	
	/**
	 * Ajax request type
	 *
	 * @type String
	 * @default &quot;get&quot;
	 **/
	this.requestType = /^(get|post)$/i.test(this.options.requestType) ? this.options.requestType.toLowerCase() : &#x27;get&#x27;,
	
	/**
	 * Any data to send across every ajax request
	 *
	 * @type Object
	 * @default {}
	 **/
	this.customData = $.isPlainObject(this.options.customData) ? this.options.customData : {};

	/**
	 * Any custom headers to send across every ajax request
	 *
	 * @type Object
	 * @default {}
	*/
	this.customHeaders = $.isPlainObject(this.options.customHeaders) ? this.options.customHeaders : {};

	/**
	 * Any custom xhrFields to send across every ajax request
	 *
	 * @type Object
	 * @default {}
	 */
	this.xhrFields = $.isPlainObject(this.options.xhrFields) ? this.options.xhrFields : {};

	/**
	 * ID. Required to create unique cookie name
	 *
	 * @type String
	 **/
	this.id = id;
	
	/**
	 * URL to upload files
	 *
	 * @type String
	 **/
	this.uploadURL = opts.urlUpload || opts.url;
	
	/**
	 * Events namespace
	 *
	 * @type String
	 **/
	this.namespace = namespace;

	/**
	 * Interface language
	 *
	 * @type String
	 * @default &quot;en&quot;
	 **/
	this.lang = this.i18[this.options.lang] &amp;&amp; this.i18[this.options.lang].messages ? this.options.lang : &#x27;en&#x27;;
	
	i18n = this.lang == &#x27;en&#x27; 
		? this.i18[&#x27;en&#x27;] 
		: $.extend(true, {}, this.i18[&#x27;en&#x27;], this.i18[this.lang]);
	
	/**
	 * Interface direction
	 *
	 * @type String
	 * @default &quot;ltr&quot;
	 **/
	this.direction = i18n.direction;
	
	/**
	 * i18 messages
	 *
	 * @type Object
	 **/
	this.messages = i18n.messages;
	
	/**
	 * Date/time format
	 *
	 * @type String
	 * @default &quot;m.d.Y&quot;
	 **/
	this.dateFormat = this.options.dateFormat || i18n.dateFormat;
	
	/**
	 * Date format like &quot;Yesterday 10:20:12&quot;
	 *
	 * @type String
	 * @default &quot;{day} {time}&quot;
	 **/
	this.fancyFormat = this.options.fancyDateFormat || i18n.fancyDateFormat;

	/**
	 * Today timestamp
	 *
	 * @type Number
	 **/
	this.today = (new Date(date.getFullYear(), date.getMonth(), date.getDate())).getTime()/1000;
	
	/**
	 * Yesterday timestamp
	 *
	 * @type Number
	 **/
	this.yesterday = this.today - 86400;
	
	utc = this.options.UTCDate ? &#x27;UTC&#x27; : &#x27;&#x27;;
	
	this.getHours    = &#x27;get&#x27;+utc+&#x27;Hours&#x27;;
	this.getMinutes  = &#x27;get&#x27;+utc+&#x27;Minutes&#x27;;
	this.getSeconds  = &#x27;get&#x27;+utc+&#x27;Seconds&#x27;;
	this.getDate     = &#x27;get&#x27;+utc+&#x27;Date&#x27;;
	this.getDay      = &#x27;get&#x27;+utc+&#x27;Day&#x27;;
	this.getMonth    = &#x27;get&#x27;+utc+&#x27;Month&#x27;;
	this.getFullYear = &#x27;get&#x27;+utc+&#x27;FullYear&#x27;;
	
	/**
	 * Css classes 
	 *
	 * @type String
	 **/
	this.cssClass = &#x27;ui-helper-reset ui-helper-clearfix ui-widget ui-widget-content ui-corner-all elfinder elfinder-&#x27;+(this.direction == &#x27;rtl&#x27; ? &#x27;rtl&#x27; : &#x27;ltr&#x27;)+&#x27; &#x27;+this.options.cssClass;

	/**
	 * Method to store/fetch data
	 *
	 * @type Function
	 **/
	this.storage = (function() {
		try {
			return &#x27;localStorage&#x27; in window &amp;&amp; window[&#x27;localStorage&#x27;] !== null ? self.localStorage : self.cookie;
		} catch (e) {
			return self.cookie;
		}
	})();

	this.viewType = this.storage(&#x27;view&#x27;) || this.options.defaultView || &#x27;icons&#x27;;

	this.sortType = this.storage(&#x27;sortType&#x27;) || this.options.sortType || &#x27;name&#x27;;
	
	this.sortOrder = this.storage(&#x27;sortOrder&#x27;) || this.options.sortOrder || &#x27;asc&#x27;;

	this.sortStickFolders = this.storage(&#x27;sortStickFolders&#x27;);

	if (this.sortStickFolders === null) {
		this.sortStickFolders = !!this.options.sortStickFolders;
	} else {
		this.sortStickFolders = !!this.sortStickFolders
	}

	this.sortRules = $.extend(true, {}, this._sortRules, this.options.sortsRules);
	
	$.each(this.sortRules, function(name, method) {
		if (typeof method != &#x27;function&#x27;) {
			delete self.sortRules[name];
		} 
	});
	
	this.compare = $.proxy(this.compare, this);
	
	/**
	 * Delay in ms before open notification dialog
	 *
	 * @type Number
	 * @default 500
	 **/
	this.notifyDelay = this.options.notifyDelay &gt; 0 ? parseInt(this.options.notifyDelay) : 500;
	
	/**
	 * Base draggable options
	 *
	 * @type Object
	 **/
	this.draggable = {
		appendTo   : &#x27;body&#x27;,
		addClasses : true,
		delay      : 30,
		distance   : 8,
		revert     : true,
		refreshPositions : true,
		cursor     : &#x27;move&#x27;,
		cursorAt   : {left : 50, top : 47},
		drag       : function(e, ui) {
			if (! ui.helper.data(&#x27;locked&#x27;)) {
				ui.helper.toggleClass(&#x27;elfinder-drag-helper-plus&#x27;, e.shiftKey||e.ctrlKey||e.metaKey);
			}
		},
		start      : function(e, ui) {
			var targets = $.map(ui.helper.data(&#x27;files&#x27;)||[], function(h) { return h || null ;}),
			cnt, h;
			cnt = targets.length;
			while (cnt--) {
				h = targets[cnt];
				if (files[h].locked) {
					ui.helper.addClass(&#x27;elfinder-drag-helper-plus&#x27;).data(&#x27;locked&#x27;, true);
					break;
				}
			}
		},
		stop       : function() { self.trigger(&#x27;focus&#x27;).trigger(&#x27;dragstop&#x27;); },
		helper     : function(e, ui) {
			var element = this.id ? $(this) : $(this).parents(&#x27;[id]:first&#x27;),
				helper  = $(&#x27;&lt;div class=&quot;elfinder-drag-helper&quot;&gt;&lt;span class=&quot;elfinder-drag-helper-icon-plus&quot;/&gt;&lt;/div&gt;&#x27;),
				icon    = function(mime) { return &#x27;&lt;div class=&quot;elfinder-cwd-icon &#x27;+self.mime2class(mime)+&#x27; ui-corner-all&quot;/&gt;&#x27;; },
				hashes, l;
			
			self.trigger(&#x27;dragstart&#x27;, {target : element[0], originalEvent : e});
			
			hashes = element.is(&#x27;.&#x27;+self.res(&#x27;class&#x27;, &#x27;cwdfile&#x27;)) 
				? self.selected() 
				: [self.navId2Hash(element.attr(&#x27;id&#x27;))];
			
			helper.append(icon(files[hashes[0]].mime)).data(&#x27;files&#x27;, hashes).data(&#x27;locked&#x27;, false);

			if ((l = hashes.length) &gt; 1) {
				helper.append(icon(files[hashes[l-1]].mime) + &#x27;&lt;span class=&quot;elfinder-drag-num&quot;&gt;&#x27;+l+&#x27;&lt;/span&gt;&#x27;);
			}
			
			return helper;
		}
	};
	
	/**
	 * Base droppable options
	 *
	 * @type Object
	 **/
	this.droppable = {
			// greedy     : true,
			tolerance  : &#x27;pointer&#x27;,
			accept     : &#x27;.elfinder-cwd-file-wrapper,.elfinder-navbar-dir,.elfinder-cwd-file&#x27;,
			hoverClass : this.res(&#x27;class&#x27;, &#x27;adroppable&#x27;),
			drop : function(e, ui) {
				var dst     = $(this),
					targets = $.map(ui.helper.data(&#x27;files&#x27;)||[], function(h) { return h || null }),
					result  = [],
					c       = &#x27;class&#x27;,
					cnt, hash, i, h;
				
				if (dst.is(&#x27;.&#x27;+self.res(c, &#x27;cwd&#x27;))) {
					hash = cwd;
				} else if (dst.is(&#x27;.&#x27;+self.res(c, &#x27;cwdfile&#x27;))) {
					hash = dst.attr(&#x27;id&#x27;);
				} else if (dst.is(&#x27;.&#x27;+self.res(c, &#x27;navdir&#x27;))) {
					hash = self.navId2Hash(dst.attr(&#x27;id&#x27;));
				}

				cnt = targets.length;
				
				while (cnt--) {
					h = targets[cnt];
					// ignore drop into itself or in own location
					h != hash &amp;&amp; files[h].phash != hash &amp;&amp; result.push(h);
				}
				
				if (result.length) {
					ui.helper.hide();
					self.clipboard(result, !(e.ctrlKey||e.shiftKey||e.metaKey||ui.helper.data(&#x27;locked&#x27;)));
					self.exec(&#x27;paste&#x27;, hash);
					self.trigger(&#x27;drop&#x27;, {files : targets});

				}
			}
		};
	
	/**
	 * Return true if filemanager is active
	 *
	 * @return Boolean
	 **/
	this.enabled = function() {
		return node.is(&#x27;:visible&#x27;) &amp;&amp; enabled;
	}
	
	/**
	 * Return true if filemanager is visible
	 *
	 * @return Boolean
	 **/
	this.visible = function() {
		return node.is(&#x27;:visible&#x27;);
	}
	
	/**
	 * Return root dir hash for current working directory
	 * 
	 * @return String
	 */
	this.root = function(hash) {
		var dir = files[hash || cwd], i;
		
		while (dir &amp;&amp; dir.phash) {
			dir = files[dir.phash]
		}
		if (dir) {
			return dir.hash;
		}
		
		while (i in files &amp;&amp; files.hasOwnProperty(i)) {
			dir = files[i]
			if (!dir.phash &amp;&amp; !dir.mime == &#x27;directory&#x27; &amp;&amp; dir.read) {
				return dir.hash
			}
		}
		
		return &#x27;&#x27;;
	}
	
	/**
	 * Return current working directory info
	 * 
	 * @return Object
	 */
	this.cwd = function() {
		return files[cwd] || {};
	}
	
	/**
	 * Return required cwd option
	 * 
	 * @param  String  option name
	 * @return mixed
	 */
	this.option = function(name) {
		return cwdOptions[name]||&#x27;&#x27;;
	}
	
	/**
	 * Return file data from current dir or tree by it&#x27;s hash
	 * 
	 * @param  String  file hash
	 * @return Object
	 */
	this.file = function(hash) { 
		return files[hash]; 
	};
	
	/**
	 * Return all cached files
	 * 
	 * @return Array
	 */
	this.files = function() {
		return $.extend(true, {}, files);
	}
	
	/**
	 * Return list of file parents hashes include file hash
	 * 
	 * @param  String  file hash
	 * @return Array
	 */
	this.parents = function(hash) {
		var parents = [],
			dir;
		
		while ((dir = this.file(hash))) {
			parents.unshift(dir.hash);
			hash = dir.phash;
		}
		return parents;
	}
	
	this.path2array = function(hash, i18) {
		var file, 
			path = [];
			
		while (hash &amp;&amp; (file = files[hash]) &amp;&amp; file.hash) {
			path.unshift(i18 &amp;&amp; file.i18 ? file.i18 : file.name);
			hash = file.phash;
		}
			
		return path;
	}
	
	/**
	 * Return file path
	 * 
	 * @param  Object  file
	 * @return String
	 */
	this.path = function(hash, i18) { 
		return files[hash] &amp;&amp; files[hash].path
			? files[hash].path
			: this.path2array(hash, i18).join(cwdOptions.separator);
	}
	
	/**
	 * Return file url if set
	 * 
	 * @param  Object  file
	 * @return String
	 */
	this.url = function(hash) {
		var file = files[hash];
		
		if (!file || !file.read) {
			return &#x27;&#x27;;
		}
		
		if (file.url) {
			return file.url;
		}
		
		if (cwdOptions.url) {
			return cwdOptions.url + $.map(this.path2array(hash), function(n) { return encodeURIComponent(n); }).slice(1).join(&#x27;/&#x27;)
		}

		var params = $.extend({}, this.customData, {
			cmd: &#x27;file&#x27;,
			target: file.hash
		});
		if (this.oldAPI) {
			params.cmd = &#x27;open&#x27;;
			params.current = file.phash;
		}
		return this.options.url + (this.options.url.indexOf(&#x27;?&#x27;) === -1 ? &#x27;?&#x27; : &#x27;&amp;&#x27;) + $.param(params, true);
	}
	
	/**
	 * Return thumbnail url
	 * 
	 * @param  String  file hash
	 * @return String
	 */
	this.tmb = function(hash) {
		var file = files[hash],
			url = file &amp;&amp; file.tmb &amp;&amp; file.tmb != 1 ? cwdOptions[&#x27;tmbUrl&#x27;] + file.tmb : &#x27;&#x27;;
		
		if (url &amp;&amp; (this.UA.Opera || this.UA.IE)) {
			url += &#x27;?_=&#x27; + new Date().getTime();
		}
		return url;
	}
	
	/**
	 * Return selected files hashes
	 *
	 * @return Array
	 **/
	this.selected = function() {
		return selected.slice(0);
	}
	
	/**
	 * Return selected files info
	 * 
	 * @return Array
	 */
	this.selectedFiles = function() {
		return $.map(selected, function(hash) { return files[hash] ? $.extend({}, files[hash]) : null });
	};
	
	/**
	 * Return true if file with required name existsin required folder
	 * 
	 * @param  String  file name
	 * @param  String  parent folder hash
	 * @return Boolean
	 */
	this.fileByName = function(name, phash) {
		var hash;
	
		for (hash in files) {
			if (files.hasOwnProperty(hash) &amp;&amp; files[hash].phash == phash &amp;&amp; files[hash].name == name) {
				return files[hash];
			}
		}
	};
	
	/**
	 * Valid data for required command based on rules
	 * 
	 * @param  String  command name
	 * @param  Object  cammand&#x27;s data
	 * @return Boolean
	 */
	this.validResponse = function(cmd, data) {
		return data.error || this.rules[this.rules[cmd] ? cmd : &#x27;defaults&#x27;](data);
	}
	
	/**
	 * Return bytes from ini formated size
	 * 
	 * @param  String  ini formated size
	 * @return Integer
	 */
	this.returnBytes = function(val) {
		if (val == &#x27;-1&#x27;) val = 0;
		if (val) {
			// for ex. 1mb, 1KB
			val = val.replace(/b$/i, &#x27;&#x27;);
			var last = val.charAt(val.length - 1).toLowerCase();
			val = val.replace(/[gmk]$/i, &#x27;&#x27;);
			if (last == &#x27;g&#x27;) {
				val = val * 1024 * 1024 * 1024;
			} else if (last == &#x27;m&#x27;) {
				val = val * 1024 * 1024;
			} else if (last == &#x27;k&#x27;) {
				val = val * 1024;
			}
		}
		return val;
	};
	
	/**
	 * Proccess ajax request.
	 * Fired events :
	 * @todo
	 * @example
	 * @todo
	 * @return $.Deferred
	 */
	this.request = function(options) { 
		var self     = this,
			o        = this.options,
			dfrd     = $.Deferred(),
			// request data
			data     = $.extend({}, o.customData, {mimes : o.onlyMimes}, options.data || options),
			// command name
			cmd      = data.cmd,
			// call default fail callback (display error dialog) ?
			deffail  = !(options.preventDefault || options.preventFail),
			// call default success callback ?
			defdone  = !(options.preventDefault || options.preventDone),
			// options for notify dialog
			notify   = $.extend({}, options.notify),
			// do not normalize data - return as is
			raw      = !!options.raw,
			// sync files on request fail
			syncOnFail = options.syncOnFail,
			// open notify dialog timeout		
			timeout, 
			// request options
			options = $.extend({
				url      : o.url,
				async    : true,
				type     : this.requestType,
				dataType : &#x27;json&#x27;,
				cache    : false,
				// timeout  : 100,
				data     : data,
				headers  : this.customHeaders,
				xhrFields: this.xhrFields
			}, options.options || {}),
			/**
			 * Default success handler. 
			 * Call default data handlers and fire event with command name.
			 *
			 * @param Object  normalized response data
			 * @return void
			 **/
			done = function(data) {
				data.warning &amp;&amp; self.error(data.warning);
				
				cmd == &#x27;open&#x27; &amp;&amp; open($.extend(true, {}, data));

				// fire some event to update cache/ui
				data.removed &amp;&amp; data.removed.length &amp;&amp; self.remove(data);
				data.added   &amp;&amp; data.added.length   &amp;&amp; self.add(data);
				data.changed &amp;&amp; data.changed.length &amp;&amp; self.change(data);
				
				// fire event with command name
				self.trigger(cmd, data);
				
				// force update content
				data.sync &amp;&amp; self.sync();
			},
			/**
			 * Request error handler. Reject dfrd with correct error message.
			 *
			 * @param jqxhr  request object
			 * @param String request status
			 * @return void
			 **/
			error = function(xhr, status) {
				var error;
				
				switch (status) {
					case &#x27;abort&#x27;:
						error = xhr.quiet ? &#x27;&#x27; : [&#x27;errConnect&#x27;, &#x27;errAbort&#x27;];
						break;
					case &#x27;timeout&#x27;:	    
						error = [&#x27;errConnect&#x27;, &#x27;errTimeout&#x27;];
						break;
					case &#x27;parsererror&#x27;: 
						error = [&#x27;errResponse&#x27;, &#x27;errDataNotJSON&#x27;];
						break;
					default:
						if (xhr.status == 403) {
							error = [&#x27;errConnect&#x27;, &#x27;errAccess&#x27;];
						} else if (xhr.status == 404) {
							error = [&#x27;errConnect&#x27;, &#x27;errNotFound&#x27;];
						} else {
							error = &#x27;errConnect&#x27;;
						} 
				}
				
				dfrd.reject(error, xhr, status);
			},
			/**
			 * Request success handler. Valid response data and reject/resolve dfrd.
			 *
			 * @param Object  response data
			 * @param String request status
			 * @return void
			 **/
			success = function(response) {
				if (raw) {
					return dfrd.resolve(response);
				}
				
				if (!response) {
					return dfrd.reject([&#x27;errResponse&#x27;, &#x27;errDataEmpty&#x27;], xhr);
				} else if (!$.isPlainObject(response)) {
					return dfrd.reject([&#x27;errResponse&#x27;, &#x27;errDataNotJSON&#x27;], xhr);
				} else if (response.error) {
					return dfrd.reject(response.error, xhr);
				} else if (!self.validResponse(cmd, response)) {
					return dfrd.reject(&#x27;errResponse&#x27;, xhr);
				}

				response = self.normalize(response);

				if (!self.api) {
					self.api    = response.api || 1;
					self.newAPI = self.api &gt;= 2;
					self.oldAPI = !self.newAPI;
				}
				
				if (response.options) {
					cwdOptions = $.extend({}, cwdOptions, response.options);
				}

				if (response.netDrivers) {
					self.netDrivers = response.netDrivers;
				}

				if (cmd == &#x27;open&#x27; &amp;&amp; !!data.init) {
					self.uplMaxSize = self.returnBytes(response.uplMaxSize);
					self.uplMaxFile = !!response.uplMaxFile? parseInt(response.uplMaxFile) : 20;
				}

				dfrd.resolve(response);
				response.debug &amp;&amp; self.debug(&#x27;backend-debug&#x27;, response.debug);
			},
			xhr, _xhr
			;

		defdone &amp;&amp; dfrd.done(done);
		dfrd.fail(function(error) {
			if (error) {
				deffail ? self.error(error) : self.debug(&#x27;error&#x27;, self.i18n(error));
			}
		})
		
		if (!cmd) {
			return dfrd.reject(&#x27;errCmdReq&#x27;);
		}	

		if (syncOnFail) {
			dfrd.fail(function(error) {
				error &amp;&amp; self.sync();
			});
		}

		if (notify.type &amp;&amp; notify.cnt) {
			timeout = setTimeout(function() {
				self.notify(notify);
				dfrd.always(function() {
					notify.cnt = -(parseInt(notify.cnt)||0);
					self.notify(notify);
				})
			}, self.notifyDelay)
			
			dfrd.always(function() {
				clearTimeout(timeout);
			});
		}
		
		// quiet abort not completed &quot;open&quot; requests
		if (cmd == &#x27;open&#x27;) {
			while ((_xhr = queue.pop())) {
				if (_xhr.state() == &#x27;pending&#x27;) {
					_xhr.quiet = true;
					_xhr.abort();
				}
			}
		}

		delete options.preventFail

		xhr = this.transport.send(options).fail(error).done(success);
		
		// this.transport.send(options)
		
		// add &quot;open&quot; xhr into queue
		if (cmd == &#x27;open&#x27;) {
			queue.unshift(xhr);
			dfrd.always(function() {
				var ndx = $.inArray(xhr, queue);
				
				ndx !== -1 &amp;&amp; queue.splice(ndx, 1);
			});
		}
		
		return dfrd;
	};
	
	/**
	 * Compare current files cache with new files and return diff
	 * 
	 * @param  Array  new files
	 * @return Object
	 */
	this.diff = function(incoming) {
		var raw       = {},
			added     = [],
			removed   = [],
			changed   = [],
			isChanged = function(hash) {
				var l = changed.length;

				while (l--) {
					if (changed[l].hash == hash) {
						return true;
					}
				}
			};
			
		$.each(incoming, function(i, f) {
			raw[f.hash] = f;
		});
			
		// find removed
		$.each(files, function(hash, f) {
			!raw[hash] &amp;&amp; removed.push(hash);
		});
		
		// compare files
		$.each(raw, function(hash, file) {
			var origin = files[hash];

			if (!origin) {
				added.push(file);
			} else {
				$.each(file, function(prop) {
					if (file[prop] != origin[prop]) {
						changed.push(file)
						return false;
					}
				});
			}
		});
		
		// parents of removed dirs mark as changed (required for tree correct work)
		$.each(removed, function(i, hash) {
			var file  = files[hash], 
				phash = file.phash;

			if (phash 
			&amp;&amp; file.mime == &#x27;directory&#x27; 
			&amp;&amp; $.inArray(phash, removed) === -1 
			&amp;&amp; raw[phash] 
			&amp;&amp; !isChanged(phash)) {
				changed.push(raw[phash]);
			}
		});
		
		return {
			added   : added,
			removed : removed,
			changed : changed
		};
	}
	
	/**
	 * Sync content
	 * 
	 * @return jQuery.Deferred
	 */
	this.sync = function() {
		var self  = this,
			dfrd  = $.Deferred().done(function() { self.trigger(&#x27;sync&#x27;); }),
			opts1 = {
				data           : {cmd : &#x27;open&#x27;, init : 1, target : cwd, tree : this.ui.tree ? 1 : 0},
				preventDefault : true
			},
			opts2 = {
				data           : {cmd : &#x27;tree&#x27;, target : (cwd == this.root())? cwd : this.file(cwd).phash},
				preventDefault : true
			};
		
		$.when(
			this.request(opts1),
			this.request(opts2)
		)
		.fail(function(error) {
			dfrd.reject(error);
			error &amp;&amp; self.request({
				data   : {cmd : &#x27;open&#x27;, target : self.lastDir(&#x27;&#x27;), tree : 1, init : 1},
				notify : {type : &#x27;open&#x27;, cnt : 1, hideCnt : true},
				preventDefault : true
			});
		})
		.done(function(odata, pdata) {
			var diff = self.diff(odata.files.concat(pdata &amp;&amp; pdata.tree ? pdata.tree : []));

			diff.added.push(odata.cwd)
			diff.removed.length &amp;&amp; self.remove(diff);
			diff.added.length   &amp;&amp; self.add(diff);
			diff.changed.length &amp;&amp; self.change(diff);
			return dfrd.resolve(diff);
		});
		
		return dfrd;
	}
	
	this.upload = function(files) {
		return this.transport.upload(files, this);
	}
	
	/**
	 * Attach listener to events
	 * To bind to multiply events at once, separate events names by space
	 * 
	 * @param  String  event(s) name(s)
	 * @param  Object  event handler
	 * @return elFinder
	 */
	this.bind = function(event, callback) {
		var i;
		
		if (typeof(callback) == &#x27;function&#x27;) {
			event = (&#x27;&#x27; + event).toLowerCase().split(/\s+/);
			
			for (i = 0; i &lt; event.length; i++) {
				if (listeners[event[i]] === void(0)) {
					listeners[event[i]] = [];
				}
				listeners[event[i]].push(callback);
			}
		}
		return this;
	};
	
	/**
	 * Remove event listener if exists
	 *
	 * @param  String    event name
	 * @param  Function  callback
	 * @return elFinder
	 */
	this.unbind = function(event, callback) {
		var l = listeners[(&#x27;&#x27; + event).toLowerCase()] || [],
			i = l.indexOf(callback);

		i &gt; -1 &amp;&amp; l.splice(i, 1);
		//delete callback; // need this?
		callback = null
		return this;
	};
	
	/**
	 * Fire event - send notification to all event listeners
	 *
	 * @param  String   event type
	 * @param  Object   data to send across event
	 * @return elFinder
	 */
	this.trigger = function(event, data) {
		var event    = event.toLowerCase(),
			handlers = listeners[event] || [], i, j;
		
		this.debug(&#x27;event-&#x27;+event, data)
		
		if (handlers.length) {
			event = $.Event(event);

			for (i = 0; i &lt; handlers.length; i++) {
				// to avoid data modifications. remember about &quot;sharing&quot; passing arguments in js :) 
				event.data = $.extend(true, {}, data);

				try {
					if (handlers[i](event, this) === false 
					|| event.isDefaultPrevented()) {
						this.debug(&#x27;event-stoped&#x27;, event.type);
						break;
					}
				} catch (ex) {
					window.console &amp;&amp; window.console.log &amp;&amp; window.console.log(ex);
				}
				
			}
		}
		return this;
	}
	
	/**
	 * Bind keybord shortcut to keydown event
	 *
	 * @example
	 *    elfinder.shortcut({ 
	 *       pattern : &#x27;ctrl+a&#x27;, 
	 *       description : &#x27;Select all files&#x27;, 
	 *       callback : function(e) { ... }, 
	 *       keypress : true|false (bind to keypress instead of keydown) 
	 *    })
	 *
	 * @param  Object  shortcut config
	 * @return elFinder
	 */
	this.shortcut = function(s) {
		var patterns, pattern, code, i, parts;
		
		if (this.options.allowShortcuts &amp;&amp; s.pattern &amp;&amp; $.isFunction(s.callback)) {
			patterns = s.pattern.toUpperCase().split(/\s+/);
			
			for (i= 0; i &lt; patterns.length; i++) {
				pattern = patterns[i]
				parts   = pattern.split(&#x27;+&#x27;);
				code    = (code = parts.pop()).length == 1 
					? code &gt; 0 ? code : code.charCodeAt(0) 
					: $.ui.keyCode[code];

				if (code &amp;&amp; !shortcuts[pattern]) {
					shortcuts[pattern] = {
						keyCode     : code,
						altKey      : $.inArray(&#x27;ALT&#x27;, parts)   != -1,
						ctrlKey     : $.inArray(&#x27;CTRL&#x27;, parts)  != -1,
						shiftKey    : $.inArray(&#x27;SHIFT&#x27;, parts) != -1,
						type        : s.type || &#x27;keydown&#x27;,
						callback    : s.callback,
						description : s.description,
						pattern     : pattern
					};
				}
			}
		}
		return this;
	}
	
	/**
	 * Registered shortcuts
	 *
	 * @type Object
	 **/
	this.shortcuts = function() {
		var ret = [];
		
		$.each(shortcuts, function(i, s) {
			ret.push([s.pattern, self.i18n(s.description)]);
		});
		return ret;
	};
	
	/**
	 * Get/set clipboard content.
	 * Return new clipboard content.
	 *
	 * @example
	 *   this.clipboard([]) - clean clipboard
	 *   this.clipboard([{...}, {...}], true) - put 2 files in clipboard and mark it as cutted
	 * 
	 * @param  Array    new files hashes
	 * @param  Boolean  cut files?
	 * @return Array
	 */
	this.clipboard = function(hashes, cut) {
		var map = function() { return $.map(clipboard, function(f) { return f.hash }); }

		if (hashes !== void(0)) {
			clipboard.length &amp;&amp; this.trigger(&#x27;unlockfiles&#x27;, {files : map()});
			remember = [];
			
			clipboard = $.map(hashes||[], function(hash) {
				var file = files[hash];
				if (file) {
					
					remember.push(hash);
					
					return {
						hash   : hash,
						phash  : file.phash,
						name   : file.name,
						mime   : file.mime,
						read   : file.read,
						locked : file.locked,
						cut    : !!cut
					}
				}
				return null;
			});
			this.trigger(&#x27;changeclipboard&#x27;, {clipboard : clipboard.slice(0, clipboard.length)});
			cut &amp;&amp; this.trigger(&#x27;lockfiles&#x27;, {files : map()});
		}

		// return copy of clipboard instead of refrence
		return clipboard.slice(0, clipboard.length);
	}
	
	/**
	 * Return true if command enabled
	 * 
	 * @param  String  command name
	 * @return Boolean
	 */
	this.isCommandEnabled = function(name) {
		return this._commands[name] ? $.inArray(name, cwdOptions.disabled) === -1 : false;
	}
	
	/**
	 * Exec command and return result;
	 *
	 * @param  String         command name
	 * @param  String|Array   usualy files hashes
	 * @param  String|Array   command options
	 * @return $.Deferred
	 */		
	this.exec = function(cmd, files, opts) {
		return this._commands[cmd] &amp;&amp; this.isCommandEnabled(cmd) 
			? this._commands[cmd].exec(files, opts) 
			: $.Deferred().reject(&#x27;No such command&#x27;);
	}
	
	/**
	 * Create and return dialog.
	 *
	 * @param  String|DOMElement  dialog content
	 * @param  Object             dialog options
	 * @return jQuery
	 */
	this.dialog = function(content, options) {
		return $(&#x27;&lt;div/&gt;&#x27;).append(content).appendTo(node).elfinderdialog(options);
	}
	
	/**
	 * Return UI widget or node
	 *
	 * @param  String  ui name
	 * @return jQuery
	 */
	this.getUI = function(ui) {
		return this.ui[ui] || node;
	}
	
	this.command = function(name) {
		return name === void(0) ? this._commands : this._commands[name];
	}
	
	/**
	 * Resize elfinder node
	 * 
	 * @param  String|Number  width
	 * @param  Number         height
	 * @return void
	 */
	this.resize = function(w, h) {
		node.css(&#x27;width&#x27;, w).height(h).trigger(&#x27;resize&#x27;);
		this.trigger(&#x27;resize&#x27;, {width : node.width(), height : node.height()});
	}
	
	/**
	 * Restore elfinder node size
	 * 
	 * @return elFinder
	 */
	this.restoreSize = function() {
		this.resize(width, height);
	}
	
	this.show = function() {
		node.show();
		this.enable().trigger(&#x27;show&#x27;);
	}
	
	this.hide = function() {
		this.disable().trigger(&#x27;hide&#x27;);
		node.hide();
	}
	
	/**
	 * Destroy this elFinder instance
	 *
	 * @return void
	 **/
	this.destroy = function() {
		if (node &amp;&amp; node[0].elfinder) {
			this.trigger(&#x27;destroy&#x27;).disable();
			listeners = {};
			shortcuts = {};
			$(document).add(node).unbind(&#x27;.&#x27;+this.namespace);
			self.trigger = function() { }
			node.children().remove();
			node.append(prevContent.contents()).removeClass(this.cssClass).attr(&#x27;style&#x27;, prevStyle);
			node[0].elfinder = null;
			if (syncInterval) {
				clearInterval(syncInterval);
			}
		}
	}
	
	/*************  init stuffs  ****************/
	
	// check jquery ui
	if (!($.fn.selectable &amp;&amp; $.fn.draggable &amp;&amp; $.fn.droppable)) {
		return alert(this.i18n(&#x27;errJqui&#x27;));
	}

	// check node
	if (!node.length) {
		return alert(this.i18n(&#x27;errNode&#x27;));
	}
	// check connector url
	if (!this.options.url) {
		return alert(this.i18n(&#x27;errURL&#x27;));
	}

	$.extend($.ui.keyCode, {
		&#x27;F1&#x27; : 112,
		&#x27;F2&#x27; : 113,
		&#x27;F3&#x27; : 114,
		&#x27;F4&#x27; : 115,
		&#x27;F5&#x27; : 116,
		&#x27;F6&#x27; : 117,
		&#x27;F7&#x27; : 118,
		&#x27;F8&#x27; : 119,
		&#x27;F9&#x27; : 120
	});
	
	this.dragUpload = false;
	this.xhrUpload  = (typeof XMLHttpRequestUpload != &#x27;undefined&#x27; || typeof XMLHttpRequestEventTarget != &#x27;undefined&#x27;) &amp;&amp; typeof File != &#x27;undefined&#x27; &amp;&amp; typeof FormData != &#x27;undefined&#x27;;
	
	// configure transport object
	this.transport = {}

	if (typeof(this.options.transport) == &#x27;object&#x27;) {
		this.transport = this.options.transport;
		if (typeof(this.transport.init) == &#x27;function&#x27;) {
			this.transport.init(this)
		}
	}
	
	if (typeof(this.transport.send) != &#x27;function&#x27;) {
		this.transport.send = function(opts) { return $.ajax(opts); }
	}
	
	if (this.transport.upload == &#x27;iframe&#x27;) {
		this.transport.upload = $.proxy(this.uploads.iframe, this);
	} else if (typeof(this.transport.upload) == &#x27;function&#x27;) {
		this.dragUpload = !!this.options.dragUploadAllow;
	} else if (this.xhrUpload &amp;&amp; !!this.options.dragUploadAllow) {
		this.transport.upload = $.proxy(this.uploads.xhr, this);
		this.dragUpload = true;
	} else {
		this.transport.upload = $.proxy(this.uploads.iframe, this);
	}

	/**
	 * Alias for this.trigger(&#x27;error&#x27;, {error : &#x27;message&#x27;})
	 *
	 * @param  String  error message
	 * @return elFinder
	 **/
	this.error = function() {
		var arg = arguments[0];
		return arguments.length == 1 &amp;&amp; typeof(arg) == &#x27;function&#x27;
			? self.bind(&#x27;error&#x27;, arg)
			: self.trigger(&#x27;error&#x27;, {error : arg});
	}
	
	// create bind/trigger aliases for build-in events
	$.each([&#x27;enable&#x27;, &#x27;disable&#x27;, &#x27;load&#x27;, &#x27;open&#x27;, &#x27;reload&#x27;, &#x27;select&#x27;,  &#x27;add&#x27;, &#x27;remove&#x27;, &#x27;change&#x27;, &#x27;dblclick&#x27;, &#x27;getfile&#x27;, &#x27;lockfiles&#x27;, &#x27;unlockfiles&#x27;, &#x27;dragstart&#x27;, &#x27;dragstop&#x27;, &#x27;search&#x27;, &#x27;searchend&#x27;, &#x27;viewchange&#x27;], function(i, name) {
		self[name] = function() {
			var arg = arguments[0];
			return arguments.length == 1 &amp;&amp; typeof(arg) == &#x27;function&#x27;
				? self.bind(name, arg)
				: self.trigger(name, $.isPlainObject(arg) ? arg : {});
		}
	});
	
	// bind core event handlers
	this
		.enable(function() {
			if (!enabled &amp;&amp; self.visible() &amp;&amp; self.ui.overlay.is(&#x27;:hidden&#x27;)) {
				enabled = true;
				$(&#x27;texarea:focus,input:focus,button&#x27;).blur();
				node.removeClass(&#x27;elfinder-disabled&#x27;);
			}
		})
		.disable(function() {
			prevEnabled = enabled;
			enabled = false;
			node.addClass(&#x27;elfinder-disabled&#x27;);
		})
		.open(function() {
			selected = [];
		})
		.select(function(e) {
			selected = $.map(e.data.selected || e.data.value|| [], function(hash) { return files[hash] ? hash : null; });
		})
		.error(function(e) { 
			var opts  = {
					cssClass  : &#x27;elfinder-dialog-error&#x27;,
					title     : self.i18n(self.i18n(&#x27;error&#x27;)),
					resizable : false,
					destroyOnClose : true,
					buttons   : {}
			};

			opts.buttons[self.i18n(self.i18n(&#x27;btnClose&#x27;))] = function() { $(this).elfinderdialog(&#x27;close&#x27;); };

			self.dialog(&#x27;&lt;span class=&quot;elfinder-dialog-icon elfinder-dialog-icon-error&quot;/&gt;&#x27;+self.i18n(e.data.error), opts);
		})
		.bind(&#x27;tree parents&#x27;, function(e) {
			cache(e.data.tree || []);
		})
		.bind(&#x27;tmb&#x27;, function(e) {
			$.each(e.data.images||[], function(hash, tmb) {
				if (files[hash]) {
					files[hash].tmb = tmb;
				}
			})
		})
		.add(function(e) {
			cache(e.data.added||[]);
		})
		.change(function(e) {
			$.each(e.data.changed||[], function(i, file) {
				var hash = file.hash;
				if ((files[hash].width &amp;&amp; !file.width) || (files[hash].height &amp;&amp; !file.height)) {
					files[hash].width = undefined;
					files[hash].height = undefined;
				}
				files[hash] = files[hash] ? $.extend(files[hash], file) : file;
			});
		})
		.remove(function(e) {
			var removed = e.data.removed||[],
				l       = removed.length, 
				rm      = function(hash) {
					var file = files[hash];
					if (file) {
						if (file.mime == &#x27;directory&#x27; &amp;&amp; file.dirs) {
							$.each(files, function(h, f) {
								f.phash == hash &amp;&amp; rm(h);
							});
						}
						delete files[hash];
					}
				};
		
			while (l--) {
				rm(removed[l]);
			}
			
		})
		.bind(&#x27;search&#x27;, function(e) {
			cache(e.data.files);
		})
		.bind(&#x27;rm&#x27;, function(e) {
			var play  = beeper.canPlayType &amp;&amp; beeper.canPlayType(&#x27;audio/wav; codecs=&quot;1&quot;&#x27;);
		
			play &amp;&amp; play != &#x27;&#x27; &amp;&amp; play != &#x27;no&#x27; &amp;&amp; $(beeper).html(&#x27;&lt;source src=&quot;./sounds/rm.wav&quot; type=&quot;audio/wav&quot;&gt;&#x27;)[0].play()
		})
		
		;

	// bind external event handlers
	$.each(this.options.handlers, function(event, callback) {
		self.bind(event, callback);
	});

	/**
	 * History object. Store visited folders
	 *
	 * @type Object
	 **/
	this.history = new this.history(this);
	
	// in getFileCallback set - change default actions on double click/enter/ctrl+enter
	if (typeof(this.options.getFileCallback) == &#x27;function&#x27; &amp;&amp; this.commands.getfile) {
		this.bind(&#x27;dblclick&#x27;, function(e) {
			e.preventDefault();
			self.exec(&#x27;getfile&#x27;).fail(function() {
				self.exec(&#x27;open&#x27;);
			});
		});
		this.shortcut({
			pattern     : &#x27;enter&#x27;,
			description : this.i18n(&#x27;cmdgetfile&#x27;),
			callback    : function() { self.exec(&#x27;getfile&#x27;).fail(function() { self.exec(self.OS == &#x27;mac&#x27; ? &#x27;rename&#x27; : &#x27;open&#x27;) }) }
		})
		.shortcut({
			pattern     : &#x27;ctrl+enter&#x27;,
			description : this.i18n(this.OS == &#x27;mac&#x27; ? &#x27;cmdrename&#x27; : &#x27;cmdopen&#x27;),
			callback    : function() { self.exec(self.OS == &#x27;mac&#x27; ? &#x27;rename&#x27; : &#x27;open&#x27;) }
		});
		
	} 

	/**
	 * Loaded commands
	 *
	 * @type Object
	 **/
	this._commands = {};
	
	if (!$.isArray(this.options.commands)) {
		this.options.commands = [];
	}
	// check required commands
	$.each([&#x27;open&#x27;, &#x27;reload&#x27;, &#x27;back&#x27;, &#x27;forward&#x27;, &#x27;up&#x27;, &#x27;home&#x27;, &#x27;info&#x27;, &#x27;quicklook&#x27;, &#x27;getfile&#x27;, &#x27;help&#x27;], function(i, cmd) {
		$.inArray(cmd, self.options.commands) === -1 &amp;&amp; self.options.commands.push(cmd);
	});

	// load commands
	$.each(this.options.commands, function(i, name) {
		var cmd = self.commands[name];
		if ($.isFunction(cmd) &amp;&amp; !self._commands[name]) {
			cmd.prototype = base;
			self._commands[name] = new cmd();
			self._commands[name].setup(name, self.options.commandsOptions[name]||{});
		}
	});
	
	// prepare node
	node.addClass(this.cssClass)
		.bind(mousedown, function() {
			!enabled &amp;&amp; self.enable();
		});
	
	/**
	 * UI nodes
	 *
	 * @type Object
	 **/
	this.ui = {
		// container for nav panel and current folder container
		workzone : $(&#x27;&lt;div/&gt;&#x27;).appendTo(node).elfinderworkzone(this),
		// container for folders tree / places
		navbar : $(&#x27;&lt;div/&gt;&#x27;).appendTo(node).elfindernavbar(this, this.options.uiOptions.navbar || {}),
		// contextmenu
		contextmenu : $(&#x27;&lt;div/&gt;&#x27;).appendTo(node).elfindercontextmenu(this),
		// overlay
		overlay : $(&#x27;&lt;div/&gt;&#x27;).appendTo(node).elfinderoverlay({
			show : function() { self.disable(); },
			hide : function() { prevEnabled &amp;&amp; self.enable(); }
		}),
		// current folder container
		cwd : $(&#x27;&lt;div/&gt;&#x27;).appendTo(node).elfindercwd(this, this.options.uiOptions.cwd || {}),
		// notification dialog window
		notify : this.dialog(&#x27;&#x27;, {
			cssClass  : &#x27;elfinder-dialog-notify&#x27;,
			position  : {top : &#x27;12px&#x27;, right : &#x27;12px&#x27;},
			resizable : false,
			autoOpen  : false,
			title     : &#x27;&amp;nbsp;&#x27;,
			width     : 280
		}),
		statusbar : $(&#x27;&lt;div class=&quot;ui-widget-header ui-helper-clearfix ui-corner-bottom elfinder-statusbar&quot;/&gt;&#x27;).hide().appendTo(node)
	}
	
	// load required ui
	$.each(this.options.ui || [], function(i, ui) {
		var name = &#x27;elfinder&#x27;+ui,
			opts = self.options.uiOptions[ui] || {};

		if (!self.ui[ui] &amp;&amp; $.fn[name]) {
			self.ui[ui] = $(&#x27;&lt;&#x27;+(opts.tag || &#x27;div&#x27;)+&#x27;/&gt;&#x27;).appendTo(node)[name](self, opts);
		}
	});
	


	// store instance in node
	node[0].elfinder = this;
	
	// make node resizable
	this.options.resizable 
	&amp;&amp; $.fn.resizable 
	&amp;&amp; node.resizable({
		handles   : &#x27;se&#x27;,
		minWidth  : 300,
		minHeight : 200
	});

	if (this.options.width) {
		width = this.options.width;
	}
	
	if (this.options.height) {
		height = parseInt(this.options.height);
	}
	
	// update size	
	self.resize(width, height);
	
	// attach events to document
	$(document)
		// disable elfinder on click outside elfinder
		.bind(&#x27;click.&#x27;+this.namespace, function(e) { enabled &amp;&amp; !$(e.target).closest(node).length &amp;&amp; self.disable(); })
		// exec shortcuts
		.bind(keydown+&#x27; &#x27;+keypress, execShortcut);
	
	// attach events to window
	self.options.useBrowserHistory &amp;&amp; $(window)
		.on(&#x27;popstate&#x27;, function(ev) {
			var target = ev.originalEvent.state &amp;&amp; ev.originalEvent.state.thash;
			target &amp;&amp; !$.isEmptyObject(self.files()) &amp;&amp; self.request({
				data   : {cmd  : &#x27;open&#x27;, target : target, onhistory : 1},
				notify : {type : &#x27;open&#x27;, cnt : 1, hideCnt : true},
				syncOnFail : true
			});
		});
	
	// send initial request and start to pray &gt;_&lt;
	this.trigger(&#x27;init&#x27;)
		.request({
			data        : {cmd : &#x27;open&#x27;, target : self.startDir(), init : 1, tree : this.ui.tree ? 1 : 0}, 
			preventDone : true,
			notify      : {type : &#x27;open&#x27;, cnt : 1, hideCnt : true},
			freeze      : true
		})
		.fail(function() {
			self.trigger(&#x27;fail&#x27;).disable().lastDir(&#x27;&#x27;);
			listeners = {};
			shortcuts = {};
			$(document).add(node).unbind(&#x27;.&#x27;+this.namespace);
			self.trigger = function() { };
		})
		.done(function(data) {
			self.load().debug(&#x27;api&#x27;, self.api);
			data = $.extend(true, {}, data);
			open(data);
			self.trigger(&#x27;open&#x27;, data);
		});
	
	// update ui&#x27;s size after init
	this.one(&#x27;load&#x27;, function() {
		node.trigger(&#x27;resize&#x27;);
		if (self.options.sync &gt; 1000) {
			syncInterval = setInterval(function() {
				self.sync();
			}, self.options.sync)
			
		}

	});

	// self.timeEnd(&#x27;load&#x27;); 

}

/**
 * Prototype
 * 
 * @type  Object
 */
elFinder.prototype = {
	
	res : function(type, id) {
		return this.resources[type] &amp;&amp; this.resources[type][id];
	}, 
	
	/**
	 * Internationalization object
	 * 
	 * @type  Object
	 */
	i18 : {
		en : {
			translator      : &#x27;&#x27;,
			language        : &#x27;English&#x27;,
			direction       : &#x27;ltr&#x27;,
			dateFormat      : &#x27;d.m.Y H:i&#x27;,
			fancyDateFormat : &#x27;$1 H:i&#x27;,
			messages        : {}
		},
		months : [&#x27;January&#x27;, &#x27;February&#x27;, &#x27;March&#x27;, &#x27;April&#x27;, &#x27;May&#x27;, &#x27;June&#x27;, &#x27;July&#x27;, &#x27;August&#x27;, &#x27;September&#x27;, &#x27;October&#x27;, &#x27;November&#x27;, &#x27;December&#x27;],
		monthsShort : [&#x27;Jan&#x27;, &#x27;Feb&#x27;, &#x27;Mar&#x27;, &#x27;Apr&#x27;, &#x27;May&#x27;, &#x27;Jun&#x27;, &#x27;Jul&#x27;, &#x27;Aug&#x27;, &#x27;Sep&#x27;, &#x27;Oct&#x27;, &#x27;Nov&#x27;, &#x27;Dec&#x27;],

		days : [&#x27;Sunday&#x27;, &#x27;Monday&#x27;, &#x27;Tuesday&#x27;, &#x27;Wednesday&#x27;, &#x27;Thursday&#x27;, &#x27;Friday&#x27;, &#x27;Saturday&#x27;],
		daysShort : [&#x27;Sun&#x27;, &#x27;Mon&#x27;, &#x27;Tue&#x27;, &#x27;Wed&#x27;, &#x27;Thu&#x27;, &#x27;Fri&#x27;, &#x27;Sat&#x27;]
	},
	
	/**
	 * File mimetype to kind mapping
	 * 
	 * @type  Object
	 */
	kinds : 	{
			&#x27;unknown&#x27;                       : &#x27;Unknown&#x27;,
			&#x27;directory&#x27;                     : &#x27;Folder&#x27;,
			&#x27;symlink&#x27;                       : &#x27;Alias&#x27;,
			&#x27;symlink-broken&#x27;                : &#x27;AliasBroken&#x27;,
			&#x27;application/x-empty&#x27;           : &#x27;TextPlain&#x27;,
			&#x27;application/postscript&#x27;        : &#x27;Postscript&#x27;,
			&#x27;application/vnd.ms-office&#x27;     : &#x27;MsOffice&#x27;,
			&#x27;application/vnd.ms-word&#x27;       : &#x27;MsWord&#x27;,
			&#x27;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#x27; : &#x27;MsWord&#x27;,
			&#x27;application/vnd.ms-word.document.macroEnabled.12&#x27;                        : &#x27;MsWord&#x27;,
			&#x27;application/vnd.openxmlformats-officedocument.wordprocessingml.template&#x27; : &#x27;MsWord&#x27;,
			&#x27;application/vnd.ms-word.template.macroEnabled.12&#x27;                        : &#x27;MsWord&#x27;,
			&#x27;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#x27;       : &#x27;MsWord&#x27;,
			&#x27;application/vnd.ms-excel&#x27;      : &#x27;MsExcel&#x27;,
			&#x27;application/vnd.ms-excel.sheet.macroEnabled.12&#x27;                          : &#x27;MsExcel&#x27;,
			&#x27;application/vnd.openxmlformats-officedocument.spreadsheetml.template&#x27;    : &#x27;MsExcel&#x27;,
			&#x27;application/vnd.ms-excel.template.macroEnabled.12&#x27;                       : &#x27;MsExcel&#x27;,
			&#x27;application/vnd.ms-excel.sheet.binary.macroEnabled.12&#x27;                   : &#x27;MsExcel&#x27;,
			&#x27;application/vnd.ms-excel.addin.macroEnabled.12&#x27;                          : &#x27;MsExcel&#x27;,
			&#x27;application/vnd.ms-powerpoint&#x27; : &#x27;MsPP&#x27;,
			&#x27;application/vnd.openxmlformats-officedocument.presentationml.presentation&#x27; : &#x27;MsPP&#x27;,
			&#x27;application/vnd.ms-powerpoint.presentation.macroEnabled.12&#x27;              : &#x27;MsPP&#x27;,
			&#x27;application/vnd.openxmlformats-officedocument.presentationml.slideshow&#x27;  : &#x27;MsPP&#x27;,
			&#x27;application/vnd.ms-powerpoint.slideshow.macroEnabled.12&#x27;                 : &#x27;MsPP&#x27;,
			&#x27;application/vnd.openxmlformats-officedocument.presentationml.template&#x27;   : &#x27;MsPP&#x27;,
			&#x27;application/vnd.ms-powerpoint.template.macroEnabled.12&#x27;                  : &#x27;MsPP&#x27;,
			&#x27;application/vnd.ms-powerpoint.addin.macroEnabled.12&#x27;                     : &#x27;MsPP&#x27;,
			&#x27;application/vnd.openxmlformats-officedocument.presentationml.slide&#x27;      : &#x27;MsPP&#x27;,
			&#x27;application/vnd.ms-powerpoint.slide.macroEnabled.12&#x27;                     : &#x27;MsPP&#x27;,
			&#x27;application/pdf&#x27;               : &#x27;PDF&#x27;,
			&#x27;application/xml&#x27;               : &#x27;XML&#x27;,
			&#x27;application/vnd.oasis.opendocument.text&#x27; : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.text-template&#x27;         : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.text-web&#x27;              : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.text-master&#x27;           : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.graphics&#x27;              : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.graphics-template&#x27;     : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.presentation&#x27;          : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.presentation-template&#x27; : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.spreadsheet&#x27;           : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.spreadsheet-template&#x27;  : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.chart&#x27;                 : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.formula&#x27;               : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.database&#x27;              : &#x27;OO&#x27;,
			&#x27;application/vnd.oasis.opendocument.image&#x27;                 : &#x27;OO&#x27;,
			&#x27;application/vnd.openofficeorg.extension&#x27;                  : &#x27;OO&#x27;,
			&#x27;application/x-shockwave-flash&#x27; : &#x27;AppFlash&#x27;,
			&#x27;application/flash-video&#x27;       : &#x27;Flash video&#x27;,
			&#x27;application/x-bittorrent&#x27;      : &#x27;Torrent&#x27;,
			&#x27;application/javascript&#x27;        : &#x27;JS&#x27;,
			&#x27;application/rtf&#x27;               : &#x27;RTF&#x27;,
			&#x27;application/rtfd&#x27;              : &#x27;RTF&#x27;,
			&#x27;application/x-font-ttf&#x27;        : &#x27;TTF&#x27;,
			&#x27;application/x-font-otf&#x27;        : &#x27;OTF&#x27;,
			&#x27;application/x-rpm&#x27;             : &#x27;RPM&#x27;,
			&#x27;application/x-web-config&#x27;      : &#x27;TextPlain&#x27;,
			&#x27;application/xhtml+xml&#x27;         : &#x27;HTML&#x27;,
			&#x27;application/docbook+xml&#x27;       : &#x27;DOCBOOK&#x27;,
			&#x27;application/x-awk&#x27;             : &#x27;AWK&#x27;,
			&#x27;application/x-gzip&#x27;            : &#x27;GZIP&#x27;,
			&#x27;application/x-bzip2&#x27;           : &#x27;BZIP&#x27;,
			&#x27;application/zip&#x27;               : &#x27;ZIP&#x27;,
			&#x27;application/x-zip&#x27;               : &#x27;ZIP&#x27;,
			&#x27;application/x-rar&#x27;             : &#x27;RAR&#x27;,
			&#x27;application/x-tar&#x27;             : &#x27;TAR&#x27;,
			&#x27;application/x-7z-compressed&#x27;   : &#x27;7z&#x27;,
			&#x27;application/x-jar&#x27;             : &#x27;JAR&#x27;,
			&#x27;text/plain&#x27;                    : &#x27;TextPlain&#x27;,
			&#x27;text/x-php&#x27;                    : &#x27;PHP&#x27;,
			&#x27;text/html&#x27;                     : &#x27;HTML&#x27;,
			&#x27;text/javascript&#x27;               : &#x27;JS&#x27;,
			&#x27;text/css&#x27;                      : &#x27;CSS&#x27;,
			&#x27;text/rtf&#x27;                      : &#x27;RTF&#x27;,
			&#x27;text/rtfd&#x27;                     : &#x27;RTF&#x27;,
			&#x27;text/x-c&#x27;                      : &#x27;C&#x27;,
			&#x27;text/x-csrc&#x27;                   : &#x27;C&#x27;,
			&#x27;text/x-chdr&#x27;                   : &#x27;CHeader&#x27;,
			&#x27;text/x-c++&#x27;                    : &#x27;CPP&#x27;,
			&#x27;text/x-c++src&#x27;                 : &#x27;CPP&#x27;,
			&#x27;text/x-c++hdr&#x27;                 : &#x27;CPPHeader&#x27;,
			&#x27;text/x-shellscript&#x27;            : &#x27;Shell&#x27;,
			&#x27;application/x-csh&#x27;             : &#x27;Shell&#x27;,
			&#x27;text/x-python&#x27;                 : &#x27;Python&#x27;,
			&#x27;text/x-java&#x27;                   : &#x27;Java&#x27;,
			&#x27;text/x-java-source&#x27;            : &#x27;Java&#x27;,
			&#x27;text/x-ruby&#x27;                   : &#x27;Ruby&#x27;,
			&#x27;text/x-perl&#x27;                   : &#x27;Perl&#x27;,
			&#x27;text/x-sql&#x27;                    : &#x27;SQL&#x27;,
			&#x27;text/xml&#x27;                      : &#x27;XML&#x27;,
			&#x27;text/x-comma-separated-values&#x27; : &#x27;CSV&#x27;,
			&#x27;image/x-ms-bmp&#x27;                : &#x27;BMP&#x27;,
			&#x27;image/jpeg&#x27;                    : &#x27;JPEG&#x27;,
			&#x27;image/gif&#x27;                     : &#x27;GIF&#x27;,
			&#x27;image/png&#x27;                     : &#x27;PNG&#x27;,
			&#x27;image/tiff&#x27;                    : &#x27;TIFF&#x27;,
			&#x27;image/x-targa&#x27;                 : &#x27;TGA&#x27;,
			&#x27;image/vnd.adobe.photoshop&#x27;     : &#x27;PSD&#x27;,
			&#x27;image/xbm&#x27;                     : &#x27;XBITMAP&#x27;,
			&#x27;image/pxm&#x27;                     : &#x27;PXM&#x27;,
			&#x27;audio/mpeg&#x27;                    : &#x27;AudioMPEG&#x27;,
			&#x27;audio/midi&#x27;                    : &#x27;AudioMIDI&#x27;,
			&#x27;audio/ogg&#x27;                     : &#x27;AudioOGG&#x27;,
			&#x27;audio/mp4&#x27;                     : &#x27;AudioMPEG4&#x27;,
			&#x27;audio/x-m4a&#x27;                   : &#x27;AudioMPEG4&#x27;,
			&#x27;audio/wav&#x27;                     : &#x27;AudioWAV&#x27;,
			&#x27;audio/x-mp3-playlist&#x27;          : &#x27;AudioPlaylist&#x27;,
			&#x27;video/x-dv&#x27;                    : &#x27;VideoDV&#x27;,
			&#x27;video/mp4&#x27;                     : &#x27;VideoMPEG4&#x27;,
			&#x27;video/mpeg&#x27;                    : &#x27;VideoMPEG&#x27;,
			&#x27;video/x-msvideo&#x27;               : &#x27;VideoAVI&#x27;,
			&#x27;video/quicktime&#x27;               : &#x27;VideoMOV&#x27;,
			&#x27;video/x-ms-wmv&#x27;                : &#x27;VideoWM&#x27;,
			&#x27;video/x-flv&#x27;                   : &#x27;VideoFlash&#x27;,
			&#x27;video/x-matroska&#x27;              : &#x27;VideoMKV&#x27;,
			&#x27;video/ogg&#x27;                     : &#x27;VideoOGG&#x27;
		},
	
	/**
	 * Ajax request data validation rules
	 * 
	 * @type  Object
	 */
	rules : {
		defaults : function(data) {
			if (!data
			|| (data.added &amp;&amp; !$.isArray(data.added))
			||  (data.removed &amp;&amp; !$.isArray(data.removed))
			||  (data.changed &amp;&amp; !$.isArray(data.changed))) {
				return false;
			}
			return true;
		},
		open    : function(data) { return data &amp;&amp; data.cwd &amp;&amp; data.files &amp;&amp; $.isPlainObject(data.cwd) &amp;&amp; $.isArray(data.files); },
		tree    : function(data) { return data &amp;&amp; data.tree &amp;&amp; $.isArray(data.tree); },
		parents : function(data) { return data &amp;&amp; data.tree &amp;&amp; $.isArray(data.tree); },
		tmb     : function(data) { return data &amp;&amp; data.images &amp;&amp; ($.isPlainObject(data.images) || $.isArray(data.images)); },
		upload  : function(data) { return data &amp;&amp; ($.isPlainObject(data.added) || $.isArray(data.added));},
		search  : function(data) { return data &amp;&amp; data.files &amp;&amp; $.isArray(data.files)}
	},

	

	
	/**
	 * Commands costructors
	 *
	 * @type Object
	 */
	commands : {},
	
	parseUploadData : function(text) {
		var data;
		
		if (!$.trim(text)) {
			return {error : [&#x27;errResponse&#x27;, &#x27;errDataEmpty&#x27;]};
		}
		
		try {
			data = $.parseJSON(text);
		} catch (e) {
			return {error : [&#x27;errResponse&#x27;, &#x27;errDataNotJSON&#x27;]}
		}
		
		if (!this.validResponse(&#x27;upload&#x27;, data)) {
			return {error : [&#x27;errResponse&#x27;]};
		}
		data = this.normalize(data);
		data.removed = $.map(data.added||[], function(f) { return f.hash; })
		return data;
		
	},
	
	iframeCnt : 0,
	
	uploads : {
		// check droped contents
		checkFile : function(data, fm) {
			if (!!data.checked || data.type == &#x27;files&#x27;) {
				return data.files;
			} else if (data.type == &#x27;data&#x27;) {
				var dfrd = $.Deferred(),
				files = [],
				paths = [],
				dirctorys = [],
				entries = [],
				processing = 0,
				
				readEntries = function(dirReader) {
					var toArray = function(list) {
						return Array.prototype.slice.call(list || []);
					};
					var readFile = function(fileEntry, callback) {
						var dfrd = $.Deferred();
						if (typeof fileEntry == &#x27;undefined&#x27;) {
							dfrd.reject(&#x27;empty&#x27;);
						} else if (fileEntry.isFile) {
							fileEntry.file(function (file) {
								dfrd.resolve(file);
							}, function(e){
								dfrd.reject();
							});
						} else {
							dfrd.reject(&#x27;dirctory&#x27;);
						}
						return dfrd.promise();
					};
			
					dirReader.readEntries(function (results) {
						if (!results.length) {
							var len = entries.length - 1;
							var read = function(i) {
								readFile(entries[i]).done(function(file){
									if (! (fm.OS == &#x27;win&#x27; &amp;&amp; file.name.match(/^(?:desktop\.ini|thumbs\.db)$/i))
											&amp;&amp;
										! (fm.OS == &#x27;mac&#x27; &amp;&amp; file.name.match(/^\.ds_store$/i))) {
										paths.push(entries[i].fullPath);
										files.push(file);
									}
								}).fail(function(e){
									if (e == &#x27;dirctory&#x27;) {
										// dirctory
										dirctorys.push(entries[i]);
									} else if (e == &#x27;empty&#x27;) {
										// dirctory is empty
									} else {
										// why fail?
									}
								}).always(function(){
									processing--;
									if (i &lt; len) {
										processing++;
										read(++i);
									}
								});
							};
							processing++;
							read(0);
							processing--;
						} else {
							entries = entries.concat(toArray(results));
							readEntries(dirReader);
						}
					});
				},
				
				doScan = function(items, isEntry) {
					var dirReader, entry;
					entries = [];
					var length = items.length;
					for (var i = 0; i &lt; length; i++) {
						if (! isEntry) {
							entry = !!items[i].getAsEntry? items[i].getAsEntry() : items[i].webkitGetAsEntry();
						} else {
							entry = items[i];
						}
						if (entry) {
							if (entry.isFile) {
								paths.push(&#x27;&#x27;);
								files.push(data.files.items[i].getAsFile());
							} else if (entry.isDirectory) {
								if (processing &gt; 0) {
									dirctorys.push(entry);
								} else {
									processing = 0;
									dirReader = entry.createReader();
									processing++;
									readEntries(dirReader);
								}
							}
						}
					}
				};
				
				doScan(data.files.items);
				
				setTimeout(function wait() {
					if (processing &gt; 0) {
						setTimeout(wait, 10);
					} else {
						if (dirctorys.length &gt; 0) {
							doScan([dirctorys.shift()], true);
							setTimeout(wait, 10);
						} else {
							dfrd.resolve([files, paths]);
						}
					}
				}, 10);
				
				return dfrd.promise();
			} else {
				var ret = [];
				var regex;
				var str = data.files[0];
				if (data.type == &#x27;html&#x27;) {
					regex = /&lt;img[^&gt;]+src=[&quot;&#x27;]?([^&quot;&#x27;&gt; ]+)/ig;
					var m = [];
					var url = &#x27;&#x27;;
					var links;
					while (m = regex.exec(str)) {
						url = m[1].replace(/&amp;amp;/g, &#x27;&amp;&#x27;);
						if (url.match(/^http|data:/) &amp;&amp; $.inArray(url, ret) == -1) ret.push(url);
					}
					links = str.match(/&lt;\/a&gt;/i);
					if (links &amp;&amp; links.length == 1) {
						regex = /&lt;a[^&gt;]+href=[&quot;&#x27;]?([^&quot;&#x27;&gt; ]+)((?:.|\s)+)&lt;\/a&gt;/i;
						if (m = regex.exec(str)) {
							if (! m[2].match(/&lt;img/i)) {
								url = m[1].replace(/&amp;amp;/g, &#x27;&amp;&#x27;);
								if (url.match(/^http/) &amp;&amp; $.inArray(url, ret) == -1) ret.push(url);
							}
						}
					}
				} else {
					regex = /(http[^&lt;&gt;&quot;{}|\\^\[\]&#x60;\s]+)/ig;
					while (m = regex.exec(str)) {
						url = m[1].replace(/&amp;amp;/g, &#x27;&amp;&#x27;);
						if ($.inArray(url, ret) == -1) ret.push(url);
					}
				}
				return ret;
			}
		},
		// upload transport using iframe
		iframe : function(data, fm) { 
			var self   = fm ? fm : this,
				input  = data.input? data.input : false,
				files  = !input ? self.uploads.checkFile(data, self) : false,
				dfrd   = $.Deferred()
					.fail(function(error) {
						error &amp;&amp; self.error(error);
					})
					.done(function(data) {
						data.warning &amp;&amp; self.error(data.warning);
						data.removed &amp;&amp; self.remove(data);
						data.added   &amp;&amp; self.add(data);
						data.changed &amp;&amp; self.change(data);
						self.trigger(&#x27;upload&#x27;, data);
						data.sync &amp;&amp; self.sync();
					}),
				name = &#x27;iframe-&#x27;+self.namespace+(++self.iframeCnt),
				form = $(&#x27;&lt;form action=&quot;&#x27;+self.uploadURL+&#x27;&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; encoding=&quot;multipart/form-data&quot; target=&quot;&#x27;+name+&#x27;&quot; style=&quot;display:none&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;cmd&quot; value=&quot;upload&quot; /&gt;&lt;/form&gt;&#x27;),
				msie = this.UA.IE,
				// clear timeouts, close notification dialog, remove form/iframe
				onload = function() {
					abortto  &amp;&amp; clearTimeout(abortto);
					notifyto &amp;&amp; clearTimeout(notifyto);
					notify   &amp;&amp; self.notify({type : &#x27;upload&#x27;, cnt : -cnt});
					
					setTimeout(function() {
						msie &amp;&amp; $(&#x27;&lt;iframe src=&quot;javascript:false;&quot;/&gt;&#x27;).appendTo(form);
						form.remove();
						iframe.remove();
					}, 100);
				},
				iframe = $(&#x27;&lt;iframe src=&quot;&#x27;+(msie ? &#x27;javascript:false;&#x27; : &#x27;about:blank&#x27;)+&#x27;&quot; name=&quot;&#x27;+name+&#x27;&quot; style=&quot;position:absolute;left:-1000px;top:-1000px&quot; /&gt;&#x27;)
					.bind(&#x27;load&#x27;, function() {
						iframe.unbind(&#x27;load&#x27;)
							.bind(&#x27;load&#x27;, function() {
								var data = self.parseUploadData(iframe.contents().text());
								
								onload();
								data.error ? dfrd.reject(data.error) : dfrd.resolve(data);
							});
							
							// notify dialog
							notifyto = setTimeout(function() {
								notify = true;
								self.notify({type : &#x27;upload&#x27;, cnt : cnt});
							}, self.options.notifyDelay);
							
							// emulate abort on timeout
							if (self.options.iframeTimeout &gt; 0) {
								abortto = setTimeout(function() {
									onload();
									dfrd.reject([errors.connect, errors.timeout]);
								}, self.options.iframeTimeout);
							}
							
							form.submit();
					}),
				cnt, notify, notifyto, abortto
				
				;

			if (files &amp;&amp; files.length) {
				$.each(files, function(i, val) {
					form.append(&#x27;&lt;input type=&quot;hidden&quot; name=&quot;upload[]&quot; value=&quot;&#x27;+val+&#x27;&quot;/&gt;&#x27;);
				});
				cnt = 1;
			} else if (input &amp;&amp; $(input).is(&#x27;:file&#x27;) &amp;&amp; $(input).val()) {
				form.append(input);
				cnt = input.files ? input.files.length : 1;
			} else {
				return dfrd.reject();
			}
			
			form.append(&#x27;&lt;input type=&quot;hidden&quot; name=&quot;&#x27;+(self.newAPI ? &#x27;target&#x27; : &#x27;current&#x27;)+&#x27;&quot; value=&quot;&#x27;+self.cwd().hash+&#x27;&quot;/&gt;&#x27;)
				.append(&#x27;&lt;input type=&quot;hidden&quot; name=&quot;html&quot; value=&quot;1&quot;/&gt;&#x27;)
				.append($(input).attr(&#x27;name&#x27;, &#x27;upload[]&#x27;));
			
			$.each(self.options.onlyMimes||[], function(i, mime) {
				form.append(&#x27;&lt;input type=&quot;hidden&quot; name=&quot;mimes[]&quot; value=&quot;&#x27;+mime+&#x27;&quot;/&gt;&#x27;);
			});
			
			$.each(self.options.customData, function(key, val) {
				form.append(&#x27;&lt;input type=&quot;hidden&quot; name=&quot;&#x27;+key+&#x27;&quot; value=&quot;&#x27;+val+&#x27;&quot;/&gt;&#x27;);
			});
			
			form.appendTo(&#x27;body&#x27;);
			iframe.appendTo(&#x27;body&#x27;);
			
			return dfrd;
		},
		// upload transport using XMLHttpRequest
		xhr : function(data, fm) { 
			var self   = fm ? fm : this,
				dfrd   = $.Deferred()
					.fail(function(error) {
						error &amp;&amp; self.error(error);
					})
					.done(function(data) {
						data.warning &amp;&amp; self.error(data.warning);
						data.removed &amp;&amp; self.remove(data);
						data.added   &amp;&amp; self.add(data);
						data.changed &amp;&amp; self.change(data);
	 					self.trigger(&#x27;upload&#x27;, data);
						data.sync &amp;&amp; self.sync();
					})
					.always(function() {
						notifyto &amp;&amp; clearTimeout(notifyto);
						! data.checked &amp;&amp; notify &amp;&amp; self.notify({type : &#x27;upload&#x27;, cnt : -cnt, progress : 100*cnt});
					}),
				xhr         = new XMLHttpRequest(),
				formData    = new FormData(),
				isDataType  = (data.type == &#x27;data&#x27;),
				files       = data.input ? data.input.files : self.uploads.checkFile(data, self), 
				cnt         = data.checked? (isDataType? files[0].length : files.length) : files.length,
				loaded      = 5,
				notify      = false,
				startNotify = function() {
					return setTimeout(function() {
						notify = true;
						self.notify({type : &#x27;upload&#x27;, cnt : cnt, progress : loaded*cnt});
					}, self.options.notifyDelay);
				},
				notifyto, notifyto2;
			
			if (!isDataType &amp;&amp; !cnt) {
				return dfrd.reject();
			}
			
			xhr.addEventListener(&#x27;error&#x27;, function() {
				dfrd.reject(&#x27;errConnect&#x27;);
			}, false);
			
			xhr.addEventListener(&#x27;abort&#x27;, function() {
				dfrd.reject([&#x27;errConnect&#x27;, &#x27;errAbort&#x27;]);
			}, false);
			
			xhr.addEventListener(&#x27;load&#x27;, function() {
				var status = xhr.status, data;
				
				if (status &gt; 500) {
					return dfrd.reject(&#x27;errResponse&#x27;);
				}
				if (status != 200) {
					return dfrd.reject(&#x27;errConnect&#x27;);
				}
				if (xhr.readyState != 4) {
					return dfrd.reject([&#x27;errConnect&#x27;, &#x27;errTimeout&#x27;]); // am i right?
				}
				if (!xhr.responseText) {
					return dfrd.reject([&#x27;errResponse&#x27;, &#x27;errDataEmpty&#x27;]);
				}

				data = self.parseUploadData(xhr.responseText);
				data.error ? dfrd.reject(data.error) : dfrd.resolve(data);
			}, false);
			
			xhr.upload.addEventListener(&#x27;progress&#x27;, function(e) {
				var prev = loaded, curr;

				if (e.lengthComputable) {
					
					curr = parseInt(e.loaded*100 / e.total);

					// to avoid strange bug in safari (not in chrome) with drag&amp;drop.
					// bug: macos finder opened in any folder,
					// reset safari cache (option+command+e), reload elfinder page,
					// drop file from finder
					// on first attempt request starts (progress callback called ones) but never ends.
					// any next drop - successfull.
					if (!data.checked &amp;&amp; curr &gt; 0 &amp;&amp; !notifyto) {
						notifyto = startNotify();
					}
					
					if (curr - prev &gt; 4) {
						loaded = curr;
						(data.checked || notify) &amp;&amp; self.notify({type : &#x27;upload&#x27;, cnt : 0, progress : (loaded - prev)*cnt});
					}
				}
			}, false);
			
			var send = function(files, paths){
				var size = 0, fcnt = 1, sfiles = [], c = 0, total = cnt, maxFileSize;
				if (! data.checked) {
					maxFileSize = fm.option(&#x27;uploadMaxSize&#x27;)? fm.option(&#x27;uploadMaxSize&#x27;) : fm.uplMaxSize;
					for (var i=0; i &lt; files.length; i++) {
						if (maxFileSize &amp;&amp; files[i].size &gt;= maxFileSize) {
							self.error(self.i18n(&#x27;errUploadFile&#x27;, files[i].name) + &#x27; &#x27; + self.i18n(&#x27;errUploadFileSize&#x27;));
							continue;
						}
						if ((fm.uplMaxSize &amp;&amp; size + files[i].size &gt;= fm.uplMaxSize) || fcnt &gt; fm.uplMaxFile) {
							size = 0;
							fcnt = 1;
							c++;
						}
						if (typeof sfiles[c] == &#x27;undefined&#x27;) {
							sfiles[c] = [];
							if (isDataType) {
								sfiles[c][0] = [];
								sfiles[c][1] = [];
							}
						}
						if (isDataType) {
							sfiles[c][0].push(files[i]);
							sfiles[c][1].push(paths[i]);
						} else {
							sfiles[c].push(files[i]);
						}
						size += files[i].size;
						fcnt++;
					}
					
					if (sfiles.length == 0) {
						data.checked = true;
						return false;
					}
					
					if (sfiles.length &gt; 1) {
						notifyto = startNotify();
						for (var i=0; i &lt; sfiles.length; i++) {
							fm.exec(&#x27;upload&#x27;, {type: data.type, files: sfiles[i], checked: true}).always(function() {
								if (notify) {
									var _cnt = (isDataType? this[0] : this).length;
									total -= _cnt;
									if (total &lt; 1) {
										notifyto &amp;&amp; clearTimeout(notifyto);
										self.notify({type : &#x27;upload&#x27;, cnt : -cnt, progress : 100 * cnt});
									}
								}
							}.bind(sfiles[i]));
						}
						return false;
					}
					
					if (isDataType) {
						files = sfiles[0][0];
						paths = sfiles[0][1];
					} else {
						files = sfiles[0];
					}
				}
				
				xhr.open(&#x27;POST&#x27;, self.uploadURL, true);
				formData.append(&#x27;cmd&#x27;, &#x27;upload&#x27;);
				formData.append(self.newAPI ? &#x27;target&#x27; : &#x27;current&#x27;, self.cwd().hash);
				$.each(self.options.customData, function(key, val) {
					formData.append(key, val);
				});
				$.each(self.options.onlyMimes, function(i, mime) {
					formData.append(&#x27;mimes[&#x27;+i+&#x27;]&#x27;, mime);
				});
				
				$.each(files, function(i, file) {
					formData.append(&#x27;upload[]&#x27;, file);
				});
				
				if (isDataType) {
					$.each(paths, function(i, path) {
						formData.append(&#x27;upload_path[]&#x27;, path);
					});
				}
				
				xhr.onreadystatechange = function() {
					if (xhr.readyState == 4 &amp;&amp; xhr.status == 0) {
						// ff bug while send zero sized file
						// for safari - send directory
						dfrd.reject([&#x27;errConnect&#x27;, &#x27;errAbort&#x27;]);
					}
				}
				
				xhr.send(formData);
				
				return true;
			};
			
			if (! isDataType) {
				if (! send(files)) {
					dfrd.reject();
				}
			} else {
				if (!! data.checked) {
					send(files[0], files[1]);
				} else {
					notifyto2 = setTimeout(function() {
						self.notify({type : &#x27;readdir&#x27;, cnt : 1, hideCnt: true});
					}, self.options.notifyDelay);
					files.done(function(result){
						notifyto2 &amp;&amp; clearTimeout(notifyto2);
						self.notify({type : &#x27;readdir&#x27;, cnt : -1});
						cnt = result[0].length;
						send(result[0], result[1]);
					}).fail(function(){
						dfrd.reject();
					});
				}
			}

			if (!isDataType &amp;&amp; !data.checked &amp;&amp; (!this.UA.Safari || !data.files)) {
				notifyto = startNotify();
			}
			
			return dfrd;
		}
	},
	
	
	/**
	 * Bind callback to event(s) The callback is executed at most once per event.
	 * To bind to multiply events at once, separate events names by space
	 *
	 * @param  String    event name
	 * @param  Function  callback
	 * @return elFinder
	 */
	one : function(event, callback) {
		var self = this,
			h    = $.proxy(callback, function(event) {
				setTimeout(function() {self.unbind(event.type, h);}, 3);
				return callback.apply(this, arguments);
			});
		return this.bind(event, h);
	},
	
	/**
	 * Set/get data into/from localStorage
	 *
	 * @param  String       key
	 * @param  String|void  value
	 * @return String
	 */
	localStorage : function(key, val) {
		var s = window.localStorage;

		key = &#x27;elfinder-&#x27;+key+this.id;
		
		if (val === null) {
			console.log(&#x27;remove&#x27;, key)
			return s.removeItem(key);
		}
		
		if (val !== void(0)) {
			try {
				s.setItem(key, val);
			} catch (e) {
				s.clear();
				s.setItem(key, val);
			}
		}

		return s.getItem(key);
	},
	
	/**
	 * Get/set cookie
	 *
	 * @param  String       cookie name
	 * @param  String|void  cookie value
	 * @return String
	 */
	cookie : function(name, value) {
		var d, o, c, i;

		name = &#x27;elfinder-&#x27;+name+this.id;

		if (value === void(0)) {
			if (document.cookie &amp;&amp; document.cookie != &#x27;&#x27;) {
				c = document.cookie.split(&#x27;;&#x27;);
				name += &#x27;=&#x27;;
				for (i=0; i&lt;c.length; i++) {
					c[i] = $.trim(c[i]);
					if (c[i].substring(0, name.length) == name) {
						return decodeURIComponent(c[i].substring(name.length));
					}
				}
			}
			return &#x27;&#x27;;
		}

		o = $.extend({}, this.options.cookie);
		if (value === null) {
			value = &#x27;&#x27;;
			o.expires = -1;
		}
		if (typeof(o.expires) == &#x27;number&#x27;) {
			d = new Date();
			d.setTime(d.getTime()+(o.expires * 86400000));
			o.expires = d;
		}
		document.cookie = name+&#x27;=&#x27;+encodeURIComponent(value)+&#x27;; expires=&#x27;+o.expires.toUTCString()+(o.path ? &#x27;; path=&#x27;+o.path : &#x27;&#x27;)+(o.domain ? &#x27;; domain=&#x27;+o.domain : &#x27;&#x27;)+(o.secure ? &#x27;; secure&#x27; : &#x27;&#x27;);
		return value;
	},
	
	/**
	 * Get start directory (by location.hash or last opened directory)
	 * 
	 * @return String
	 */
	startDir : function() {
		var locHash = window.location.hash;
		if (locHash &amp;&amp; locHash.match(/^#elf_/)) {
			return locHash.replace(/^#elf_/, &#x27;&#x27;);
		} else {
			return this.lastDir();
		}
	},
	
	/**
	 * Get/set last opened directory
	 * 
	 * @param  String|undefined  dir hash
	 * @return String
	 */
	lastDir : function(hash) { 
		return this.options.rememberLastDir ? this.storage(&#x27;lastdir&#x27;, hash) : &#x27;&#x27;;
	},
	
	/**
	 * Node for escape html entities in texts
	 * 
	 * @type jQuery
	 */
	_node : $(&#x27;&lt;span/&gt;&#x27;),
	
	/**
	 * Replace not html-safe symbols to html entities
	 * 
	 * @param  String  text to escape
	 * @return String
	 */
	escape : function(name) {
		return this._node.text(name).html();
	},
	
	/**
	 * Cleanup ajax data.
	 * For old api convert data into new api format
	 * 
	 * @param  String  command name
	 * @param  Object  data from backend
	 * @return Object
	 */
	normalize : function(data) {
		var filter = function(file) { 
		
			if (file &amp;&amp; file.hash &amp;&amp; file.name &amp;&amp; file.mime) {
				if (file.mime == &#x27;application/x-empty&#x27;) {
					file.mime = &#x27;text/plain&#x27;;
				}
				return file;
			}
			return null;
			return file &amp;&amp; file.hash &amp;&amp; file.name &amp;&amp; file.mime ? file : null; 
		};
		

		if (data.files) {
			data.files = $.map(data.files, filter);
		} 
		if (data.tree) {
			data.tree = $.map(data.tree, filter);
		}
		if (data.added) {
			data.added = $.map(data.added, filter);
		}
		if (data.changed) {
			data.changed = $.map(data.changed, filter);
		}
		if (data.api) {
			data.init = true;
		}
		return data;
	},
	
	/**
	 * Update sort options
	 *
	 * @param {String} sort type
	 * @param {String} sort order
	 * @param {Boolean} show folder first
	 */
	setSort : function(type, order, stickFolders) {
		this.storage(&#x27;sortType&#x27;, (this.sortType = this.sortRules[type] ? type : &#x27;name&#x27;));
		this.storage(&#x27;sortOrder&#x27;, (this.sortOrder = /asc|desc/.test(order) ? order : &#x27;asc&#x27;));
		this.storage(&#x27;sortStickFolders&#x27;, (this.sortStickFolders = !!stickFolders) ? 1 : &#x27;&#x27;);
		this.trigger(&#x27;sortchange&#x27;);
	},
	
	_sortRules : {
		name : function(file1, file2) { return file1.name.toLowerCase().localeCompare(file2.name.toLowerCase()); },
		size : function(file1, file2) { 
			var size1 = parseInt(file1.size) || 0,
				size2 = parseInt(file2.size) || 0;
				
			return size1 == size2 ? 0 : size1 &gt; size2 ? 1 : -1;
			return (parseInt(file1.size) || 0) &gt; (parseInt(file2.size) || 0) ? 1 : -1; },
		kind : function(file1, file2) { return file1.mime.localeCompare(file2.mime); },
		date : function(file1, file2) { 
			var date1 = file1.ts || file1.date,
				date2 = file2.ts || file2.date;

			return date1 == date2 ? 0 : date1 &gt; date2 ? 1 : -1
		}
	},
	
	/**
	 * Compare files based on elFinder.sort
	 *
	 * @param  Object  file
	 * @param  Object  file
	 * @return Number
	 */
	compare : function(file1, file2) {
		var self  = this,
			type  = self.sortType,
			asc   = self.sortOrder == &#x27;asc&#x27;,
			stick = self.sortStickFolders,
			rules = self.sortRules,
			sort  = rules[type],
			d1    = file1.mime == &#x27;directory&#x27;,
			d2    = file2.mime == &#x27;directory&#x27;,
			res;
			
		if (stick) {
			if (d1 &amp;&amp; !d2) {
				return -1;
			} else if (!d1 &amp;&amp; d2) {
				return 1;
			}
		}
		
		res = asc ? sort(file1, file2) : sort(file2, file1);
		
		return type != &#x27;name&#x27; &amp;&amp; res == 0
			? res = asc ? rules.name(file1, file2) : rules.name(file2, file1)
			: res;
	},
	
	/**
	 * Sort files based on config
	 *
	 * @param  Array  files
	 * @return Array
	 */
	sortFiles : function(files) {
		return files.sort(this.compare);
	},
	
	/**
	 * Open notification dialog 
	 * and append/update message for required notification type.
	 *
	 * @param  Object  options
	 * @example  
	 * this.notify({
	 *    type : &#x27;copy&#x27;,
	 *    msg : &#x27;Copy files&#x27;, // not required for known types @see this.notifyType
	 *    cnt : 3,
	 *    hideCnt : false, // true for not show count
	 *    progress : 10 // progress bar percents (use cnt : 0 to update progress bar)
	 * })
	 * @return elFinder
	 */
	notify : function(opts) {
		var type     = opts.type,
			msg      = this.messages[&#x27;ntf&#x27;+type] ? this.i18n(&#x27;ntf&#x27;+type) : this.i18n(&#x27;ntfsmth&#x27;),
			ndialog  = this.ui.notify,
			notify   = ndialog.children(&#x27;.elfinder-notify-&#x27;+type),
			ntpl     = &#x27;&lt;div class=&quot;elfinder-notify elfinder-notify-{type}&quot;&gt;&lt;span class=&quot;elfinder-dialog-icon elfinder-dialog-icon-{type}&quot;/&gt;&lt;span class=&quot;elfinder-notify-msg&quot;&gt;{msg}&lt;/span&gt; &lt;span class=&quot;elfinder-notify-cnt&quot;/&gt;&lt;div class=&quot;elfinder-notify-progressbar&quot;&gt;&lt;div class=&quot;elfinder-notify-progress&quot;/&gt;&lt;/div&gt;&lt;/div&gt;&#x27;,
			delta    = opts.cnt,
			progress = opts.progress &gt;= 0 ? opts.progress : 0,
			cnt, total, prc;

		if (!type) {
			return this;
		}
		
		if (!notify.length) {
			notify = $(ntpl.replace(/\{type\}/g, type).replace(/\{msg\}/g, msg))
				.appendTo(ndialog)
				.data(&#x27;cnt&#x27;, 0);

			if (progress) {
				notify.data({progress : 0, total : 0});
			}
		}

		cnt = delta + parseInt(notify.data(&#x27;cnt&#x27;));
		
		if (cnt &gt; 0) {
			!opts.hideCnt &amp;&amp; notify.children(&#x27;.elfinder-notify-cnt&#x27;).text(&#x27;(&#x27;+cnt+&#x27;)&#x27;);
			ndialog.is(&#x27;:hidden&#x27;) &amp;&amp; ndialog.elfinderdialog(&#x27;open&#x27;);
			notify.data(&#x27;cnt&#x27;, cnt);
			
			if (progress
			&amp;&amp; (total = notify.data(&#x27;total&#x27;)) &gt;= 0
			&amp;&amp; (prc = notify.data(&#x27;progress&#x27;)) &gt;= 0) {

				total    = delta + parseInt(notify.data(&#x27;total&#x27;));
				prc      = progress + prc;
				progress = parseInt(prc/total);
				notify.data({progress : prc, total : total});
				
				ndialog.find(&#x27;.elfinder-notify-progress&#x27;)
					.animate({
						width : (progress &lt; 100 ? progress : 100)+&#x27;%&#x27;
					}, 20);
			}
			
		} else {
			notify.remove();
			!ndialog.children().length &amp;&amp; ndialog.elfinderdialog(&#x27;close&#x27;);
		}
		
		return this;
	},
	
	/**
	 * Open confirmation dialog 
	 *
	 * @param  Object  options
	 * @example  
	 * this.confirm({
	 *    title : &#x27;Remove files&#x27;,
	 *    text  : &#x27;Here is question text&#x27;,
	 *    accept : {  // accept callback - required
	 *      label : &#x27;Continue&#x27;,
	 *      callback : function(applyToAll) { fm.log(&#x27;Ok&#x27;) }
	 *    },
	 *    cancel : { // cancel callback - required
	 *      label : &#x27;Cancel&#x27;,
	 *      callback : function() { fm.log(&#x27;Cancel&#x27;)}
	 *    },
	 *    reject : { // reject callback - optionally
	 *      label : &#x27;No&#x27;,
	 *      callback : function(applyToAll) { fm.log(&#x27;No&#x27;)}
	 *   },
	 *   all : true  // display checkbox &quot;Apply to all&quot;
	 * })
	 * @return elFinder
	 */
	confirm : function(opts) {
		var complete = false,
			options = {
				cssClass  : &#x27;elfinder-dialog-confirm&#x27;,
				modal     : true,
				resizable : false,
				title     : this.i18n(opts.title || &#x27;confirmReq&#x27;),
				buttons   : {},
				close     : function() { 
					!complete &amp;&amp; opts.cancel.callback();
					$(this).elfinderdialog(&#x27;destroy&#x27;);
				}
			},
			apply = this.i18n(&#x27;apllyAll&#x27;),
			label, checkbox;

		
		if (opts.reject) {
			options.buttons[this.i18n(opts.reject.label)] = function() {
				opts.reject.callback(!!(checkbox &amp;&amp; checkbox.prop(&#x27;checked&#x27;)))
				complete = true;
				$(this).elfinderdialog(&#x27;close&#x27;)
			};
		}
		
		options.buttons[this.i18n(opts.accept.label)] = function() {
			opts.accept.callback(!!(checkbox &amp;&amp; checkbox.prop(&#x27;checked&#x27;)))
			complete = true;
			$(this).elfinderdialog(&#x27;close&#x27;)
		};
		
		options.buttons[this.i18n(opts.cancel.label)] = function() {
			$(this).elfinderdialog(&#x27;close&#x27;)
		};
		
		if (opts.all) {
			if (opts.reject) {
				options.width = 370;
			}
			options.create = function() {
				checkbox = $(&#x27;&lt;input type=&quot;checkbox&quot; /&gt;&#x27;);
				$(this).next().children().before($(&#x27;&lt;label&gt;&#x27;+apply+&#x27;&lt;/label&gt;&#x27;).prepend(checkbox));
			}
			
			options.open = function() {
				var pane = $(this).next(),
					width = parseInt(pane.children(&#x27;:first&#x27;).outerWidth() + pane.children(&#x27;:last&#x27;).outerWidth());

				if (width &gt; parseInt(pane.width())) {
					$(this).closest(&#x27;.elfinder-dialog&#x27;).width(width+30);
				}
			}
		}
		
		return this.dialog(&#x27;&lt;span class=&quot;elfinder-dialog-icon elfinder-dialog-icon-confirm&quot;/&gt;&#x27; + this.i18n(opts.text), options);
	},
	
	/**
	 * Create unique file name in required dir
	 * 
	 * @param  String  file name
	 * @param  String  parent dir hash
	 * @return String
	 */
	uniqueName : function(prefix, phash) {
		var i = 0, ext = &#x27;&#x27;, p, name;
		
		prefix = this.i18n(prefix); 
		phash = phash || this.cwd().hash;

		if ((p = prefix.indexOf(&#x27;.txt&#x27;)) != -1) {
			ext    = &#x27;.txt&#x27;;
			prefix = prefix.substr(0, p);
		}
		
		name   = prefix+ext;
		
		if (!this.fileByName(name, phash)) {
			return name;
		}
		while (i &lt; 10000) {
			name = prefix + &#x27; &#x27; + (++i) + ext;
			if (!this.fileByName(name, phash)) {
				return name;
			}
		}
		return prefix + Math.random() + ext;
	},
	
	/**
	 * Return message translated onto current language
	 *
	 * @param  String|Array  message[s]
	 * @return String
	 **/
	i18n : function() {
		var self = this,
			messages = this.messages, 
			input    = [],
			ignore   = [], 
			message = function(m) {
				var file;
				if (m.indexOf(&#x27;#&#x27;) === 0) {
					if ((file = self.file(m.substr(1)))) {
						return file.name;
					}
				}
				return m;
			},
			i, j, m;
			
		for (i = 0; i&lt; arguments.length; i++) {
			m = arguments[i];
			
			if (typeof m == &#x27;string&#x27;) {
				input.push(message(m));
			} else if ($.isArray(m)) {
				for (j = 0; j &lt; m.length; j++) {
					if (typeof m[j] == &#x27;string&#x27;) {
						input.push(message(m[j]));
					}
				}
			}
		}
		
		for (i = 0; i &lt; input.length; i++) {
			// dont translate placeholders
			if ($.inArray(i, ignore) !== -1) {
				continue;
			}
			m = input[i];
			// translate message
			m = messages[m] || m;
			// replace placeholders in message
			m = m.replace(/\$(\d+)/g, function(match, placeholder) {
				placeholder = i + parseInt(placeholder);
				if (placeholder &gt; 0 &amp;&amp; input[placeholder]) {
					ignore.push(placeholder)
				}
				return input[placeholder] || &#x27;&#x27;;
			});

			input[i] = m;
		}

		return $.map(input, function(m, i) { return $.inArray(i, ignore) === -1 ? m : null; }).join(&#x27;&lt;br&gt;&#x27;);
	},
	
	/**
	 * Convert mimetype into css classes
	 * 
	 * @param  String  file mimetype
	 * @return String
	 */
	mime2class : function(mime) {
		var prefix = &#x27;elfinder-cwd-icon-&#x27;;
		
		mime = mime.split(&#x27;/&#x27;);
		
		return prefix+mime[0]+(mime[0] != &#x27;image&#x27; &amp;&amp; mime[1] ? &#x27; &#x27;+prefix+mime[1].replace(/(\.|\+)/g, &#x27;-&#x27;) : &#x27;&#x27;);
	},
	
	/**
	 * Return localized kind of file
	 * 
	 * @param  Object|String  file or file mimetype
	 * @return String
	 */
	mime2kind : function(f) {
		var mime = typeof(f) == &#x27;object&#x27; ? f.mime : f, kind;
		
		if (f.alias) {
			kind = &#x27;Alias&#x27;;
		} else if (this.kinds[mime]) {
			kind = this.kinds[mime];
		} else {
			if (mime.indexOf(&#x27;text&#x27;) === 0) {
				kind = &#x27;Text&#x27;;
			} else if (mime.indexOf(&#x27;image&#x27;) === 0) {
				kind = &#x27;Image&#x27;;
			} else if (mime.indexOf(&#x27;audio&#x27;) === 0) {
				kind = &#x27;Audio&#x27;;
			} else if (mime.indexOf(&#x27;video&#x27;) === 0) {
				kind = &#x27;Video&#x27;;
			} else if (mime.indexOf(&#x27;application&#x27;) === 0) {
				kind = &#x27;App&#x27;;
			} else {
				kind = mime;
			}
		}
		
		return this.messages[&#x27;kind&#x27;+kind] ? this.i18n(&#x27;kind&#x27;+kind) : mime;
		
		var mime = typeof(f) == &#x27;object&#x27; ? f.mime : f,
			kind = this.kinds[mime]||&#x27;unknown&#x27;;

		if (f.alias) {
			kind = &#x27;Alias&#x27;;
		} else if (kind == &#x27;unknown&#x27;) {
			if (mime.indexOf(&#x27;text&#x27;) === 0) {
				kind = &#x27;Text&#x27;;
			} else if (mime.indexOf(&#x27;image&#x27;) === 0) {
				kind = &#x27;Image&#x27;;
			} else if (mime.indexOf(&#x27;audio&#x27;) === 0) {
				kind = &#x27;Audio&#x27;;
			} else if (mime.indexOf(&#x27;video&#x27;) === 0) {
				kind = &#x27;Video&#x27;;
			} else if (mime.indexOf(&#x27;application&#x27;) === 0) {
				kind = &#x27;Application&#x27;;
			}
		}
		
		return this.i18n(kind);
	},
	
	/**
	 * Return localized date
	 * 
	 * @param  Object  file object
	 * @return String
	 */
	formatDate : function(file, ts) {
		var self = this, 
			ts   = ts || file.ts, 
			i18  = self.i18,
			date, format, output, d, dw, m, y, h, g, i, s;

		if (self.options.clientFormatDate &amp;&amp; ts &gt; 0) {

			date = new Date(ts*1000);
			
			h  = date[self.getHours]();
			g  = h &gt; 12 ? h - 12 : h;
			i  = date[self.getMinutes]();
			s  = date[self.getSeconds]();
			d  = date[self.getDate]();
			dw = date[self.getDay]();
			m  = date[self.getMonth]() + 1;
			y  = date[self.getFullYear]();
			
			format = ts &gt;= this.yesterday 
				? this.fancyFormat 
				: this.dateFormat;

			output = format.replace(/[a-z]/gi, function(val) {
				switch (val) {
					case &#x27;d&#x27;: return d &gt; 9 ? d : &#x27;0&#x27;+d;
					case &#x27;j&#x27;: return d;
					case &#x27;D&#x27;: return self.i18n(i18.daysShort[dw]);
					case &#x27;l&#x27;: return self.i18n(i18.days[dw]);
					case &#x27;m&#x27;: return m &gt; 9 ? m : &#x27;0&#x27;+m;
					case &#x27;n&#x27;: return m;
					case &#x27;M&#x27;: return self.i18n(i18.monthsShort[m-1]);
					case &#x27;F&#x27;: return self.i18n(i18.months[m-1]);
					case &#x27;Y&#x27;: return y;
					case &#x27;y&#x27;: return (&#x27;&#x27;+y).substr(2);
					case &#x27;H&#x27;: return h &gt; 9 ? h : &#x27;0&#x27;+h;
					case &#x27;G&#x27;: return h;
					case &#x27;g&#x27;: return g;
					case &#x27;h&#x27;: return g &gt; 9 ? g : &#x27;0&#x27;+g;
					case &#x27;a&#x27;: return h &gt; 12 ? &#x27;pm&#x27; : &#x27;am&#x27;;
					case &#x27;A&#x27;: return h &gt; 12 ? &#x27;PM&#x27; : &#x27;AM&#x27;;
					case &#x27;i&#x27;: return i &gt; 9 ? i : &#x27;0&#x27;+i;
					case &#x27;s&#x27;: return s &gt; 9 ? s : &#x27;0&#x27;+s;
				}
				return val;
			});
			
			return ts &gt;= this.yesterday
				? output.replace(&#x27;$1&#x27;, this.i18n(ts &gt;= this.today ? &#x27;Today&#x27; : &#x27;Yesterday&#x27;))
				: output;
		} else if (file.date) {
			return file.date.replace(/([a-z]+)\s/i, function(a1, a2) { return self.i18n(a2)+&#x27; &#x27;; });
		}
		
		return self.i18n(&#x27;dateUnknown&#x27;);
	},
	
	/**
	 * Return css class marks file permissions
	 * 
	 * @param  Object  file 
	 * @return String
	 */
	perms2class : function(o) {
		var c = &#x27;&#x27;;
		
		if (!o.read &amp;&amp; !o.write) {
			c = &#x27;elfinder-na&#x27;;
		} else if (!o.read) {
			c = &#x27;elfinder-wo&#x27;;
		} else if (!o.write) {
			c = &#x27;elfinder-ro&#x27;;
		}
		return c;
	},
	
	/**
	 * Return localized string with file permissions
	 * 
	 * @param  Object  file
	 * @return String
	 */
	formatPermissions : function(f) {
		var p  = [];
			
		f.read &amp;&amp; p.push(this.i18n(&#x27;read&#x27;));
		f.write &amp;&amp; p.push(this.i18n(&#x27;write&#x27;));	

		return p.length ? p.join(&#x27; &#x27;+this.i18n(&#x27;and&#x27;)+&#x27; &#x27;) : this.i18n(&#x27;noaccess&#x27;);
	},
	
	/**
	 * Return formated file size
	 * 
	 * @param  Number  file size
	 * @return String
	 */
	formatSize : function(s) {
		var n = 1, u = &#x27;b&#x27;;
		
		if (s == &#x27;unknown&#x27;) {
			return this.i18n(&#x27;unknown&#x27;);
		}
		
		if (s &gt; 1073741824) {
			n = 1073741824;
			u = &#x27;GB&#x27;;
		} else if (s &gt; 1048576) {
			n = 1048576;
			u = &#x27;MB&#x27;;
		} else if (s &gt; 1024) {
			n = 1024;
			u = &#x27;KB&#x27;;
		}
		s = s/n;
		return (s &gt; 0 ? n &gt;= 1048576 ? s.toFixed(2) : Math.round(s) : 0) +&#x27; &#x27;+u;
	},
	
	
	navHash2Id : function(hash) {
		return &#x27;nav-&#x27;+hash;
	},
	
	navId2Hash : function(id) {
		return typeof(id) == &#x27;string&#x27; ? id.substr(4) : false;
	},
	
	log : function(m) { window.console &amp;&amp; window.console.log &amp;&amp; window.console.log(m); return this; },
	
	debug : function(type, m) {
		var d = this.options.debug;

		if (d == &#x27;all&#x27; || d === true || ($.isArray(d) &amp;&amp; $.inArray(type, d) != -1)) {
			window.console &amp;&amp; window.console.log &amp;&amp; window.console.log(&#x27;elfinder debug: [&#x27;+type+&#x27;] [&#x27;+this.id+&#x27;]&#x27;, m);
		} 
		return this;
	},
	time : function(l) { window.console &amp;&amp; window.console.time &amp;&amp; window.console.time(l); },
	timeEnd : function(l) { window.console &amp;&amp; window.console.timeEnd &amp;&amp; window.console.timeEnd(l); }
	

}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
