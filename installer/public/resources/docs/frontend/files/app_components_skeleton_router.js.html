<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app\components\skeleton\router.js - umi-cms-3</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="umi-cms-3"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ApplicationRoute.html">ApplicationRoute</a></li>
            
                <li><a href="../classes/ComponentController.html">ComponentController</a></li>
            
                <li><a href="../classes/dialogelfinder - open elFinder in dialog window.html">dialogelfinder - open elFinder in dialog window</a></li>
            
                <li><a href="../classes/DS.ManyArray.html">DS.ManyArray</a></li>
            
                <li><a href="../classes/elFinder - file manager for web.html">elFinder - file manager for web</a></li>
            
                <li><a href="../classes/elFinder command &quot;archive&quot;
Archive selected files.html">elFinder command &quot;archive&quot;
Archive selected files</a></li>
            
                <li><a href="../classes/elFinder command &quot;back&quot;
Open last visited folder.html">elFinder command &quot;back&quot;
Open last visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;copy&quot;.
Put files in filemanager clipboard..html">elFinder command &quot;copy&quot;.
Put files in filemanager clipboard.</a></li>
            
                <li><a href="../classes/elFinder command &quot;download&quot;. 
Download selected files.
Only for new api.html">elFinder command &quot;download&quot;. 
Download selected files.
Only for new api</a></li>
            
                <li><a href="../classes/elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;.html">elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;</a></li>
            
                <li><a href="../classes/elFinder command &quot;edit&quot;. 
Edit text file in dialog window.html">elFinder command &quot;edit&quot;. 
Edit text file in dialog window</a></li>
            
                <li><a href="../classes/elFinder command &quot;extract&quot;
Extract files from archive.html">elFinder command &quot;extract&quot;
Extract files from archive</a></li>
            
                <li><a href="../classes/elFinder command &quot;forward&quot;
Open next visited folder.html">elFinder command &quot;forward&quot;
Open next visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc..html">elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc.</a></li>
            
                <li><a href="../classes/elFinder command &quot;help&quot;
&quot;About&quot; dialog.html">elFinder command &quot;help&quot;
&quot;About&quot; dialog</a></li>
            
                <li><a href="../classes/elFinder command &quot;info&quot;. 
Display dialog with file properties..html">elFinder command &quot;info&quot;. 
Display dialog with file properties.</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkdir&quot;
Create new folder.html">elFinder command &quot;mkdir&quot;
Create new folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkfile&quot;
Create new empty file.html">elFinder command &quot;mkfile&quot;
Create new empty file</a></li>
            
                <li><a href="../classes/elFinder command &quot;netmount&quot;
Mount network volume with user credentials..html">elFinder command &quot;netmount&quot;
Mount network volume with user credentials.</a></li>
            
                <li><a href="../classes/elFinder command &quot;open&quot;
Enter folder or open files in new windows.html">elFinder command &quot;open&quot;
Enter folder or open files in new windows</a></li>
            
                <li><a href="../classes/elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created.html">elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created</a></li>
            
                <li><a href="../classes/elFinder command &quot;quicklook&quot;
Fast preview for some files types.html">elFinder command &quot;quicklook&quot;
Fast preview for some files types</a></li>
            
                <li><a href="../classes/elFinder command &quot;reload&quot;
Sync files and folders.html">elFinder command &quot;reload&quot;
Sync files and folders</a></li>
            
                <li><a href="../classes/elFinder command &quot;rename&quot;. 
Rename selected file..html">elFinder command &quot;rename&quot;. 
Rename selected file.</a></li>
            
                <li><a href="../classes/elFinder command &quot;resize&quot;
Open dialog to resize image.html">elFinder command &quot;resize&quot;
Open dialog to resize image</a></li>
            
                <li><a href="../classes/elFinder command &quot;rm&quot;
Delete files.html">elFinder command &quot;rm&quot;
Delete files</a></li>
            
                <li><a href="../classes/elFinder command &quot;search&quot;
Find files.html">elFinder command &quot;search&quot;
Find files</a></li>
            
                <li><a href="../classes/elFinder command &quot;sort&quot;
Change sort files rule.html">elFinder command &quot;sort&quot;
Change sort files rule</a></li>
            
                <li><a href="../classes/elFinder command &quot;up&quot;
Go into parent directory.html">elFinder command &quot;up&quot;
Go into parent directory</a></li>
            
                <li><a href="../classes/elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop.html">elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop</a></li>
            
                <li><a href="../classes/elFinder command &quot;view&quot;
Change current directory view (icons/list).html">elFinder command &quot;view&quot;
Change current directory view (icons/list)</a></li>
            
                <li><a href="../classes/elFinder contextmenu.html">elFinder contextmenu</a></li>
            
                <li><a href="../classes/elFinder dialog.html">elFinder dialog</a></li>
            
                <li><a href="../classes/elFinder folders tree.html">elFinder folders tree</a></li>
            
                <li><a href="../classes/elFinder places/favorites ui.html">elFinder places/favorites ui</a></li>
            
                <li><a href="../classes/elFinder toolbar.html">elFinder toolbar</a></li>
            
                <li><a href="../classes/elFinder toolbar button menu with sort variants..html">elFinder toolbar button menu with sort variants.</a></li>
            
                <li><a href="../classes/elFinder toolbar button to switch current directory view..html">elFinder toolbar button to switch current directory view.</a></li>
            
                <li><a href="../classes/elFinder toolbar button widget.
If command has variants - create menu.html">elFinder toolbar button widget.
If command has variants - create menu</a></li>
            
                <li><a href="../classes/elFinder toolbar search button widget..html">elFinder toolbar search button widget.</a></li>
            
                <li><a href="../classes/elFinder toolbar&#x27;s button tor upload file.html">elFinder toolbar&#x27;s button tor upload file</a></li>
            
                <li><a href="../classes/elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder.html">elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder</a></li>
            
                <li><a href="../classes/elFinder ui
Display number of files/selected files and its size in statusbar.html">elFinder ui
Display number of files/selected files and its size in statusbar</a></li>
            
                <li><a href="../classes/elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods.html">elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods</a></li>
            
                <li><a href="../classes/elfindernav - elFinder container for diretories tree and places.html">elfindernav - elFinder container for diretories tree and places</a></li>
            
                <li><a href="../classes/elfinderworkzone - elFinder container for nav and current directory.html">elfinderworkzone - elFinder container for nav and current directory</a></li>
            
                <li><a href="../classes/IndexRoute.html">IndexRoute</a></li>
            
                <li><a href="../classes/Inflector.inflector.html">Inflector.inflector</a></li>
            
                <li><a href="../classes/map.html">map</a></li>
            
                <li><a href="../classes/UmiRESTAdapter.html">UmiRESTAdapter</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Router.html">Router</a></li>
            
                <li><a href="../modules/UMI.html">UMI</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app\components\skeleton\router.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
define([], function(){
    &#x27;use strict&#x27;;
    return function(UMI){
        /**
         @module UMI
         @submodule Router
         **/
        UMI.Router.reopen({
            location: &#x27;history&#x27;,
            rootURL: window.UmiSettings.baseURL
        });

        /**
         @class map
         @constructor
         */
        UMI.Router.map(function(){
            this.resource(&#x27;module&#x27;, {path: &#x27;/:module&#x27;}, function(){
                this.resource(&#x27;component&#x27;, {path: &#x27;/:component&#x27;}, function(){
                    this.resource(&#x27;action&#x27;, {path: &#x27;/:action&#x27;}, function(){
                        this.resource(&#x27;context&#x27;, {path: &#x27;/:context&#x27;});
                    });
                    this.route(&#x27;search&#x27;);
                });
            });
            this.route(&#x27;logout&#x27;, {path: &#x27;/auth/logout&#x27;});
        });

        //		UMI.ErrorState = Ember.Mixin.create({//TODO: Обрабатывать все типы ошибок, и разные роуты
        //			actions: {
        //				error: function(error, originRoute){
        //					this.transitionTo(&#x27;error&#x27;, &#x27;error&#x27;);
        //				}
        //			}
        //		});

        /**
         * @class ApplicationRoute
         * @extends Ember.Route
         * @uses Utils.modelsFactory
         */
        UMI.ApplicationRoute = Ember.Route.extend({
            /**
             Инициализирует модели данных, модули и компоненты для Dock.

             @method model
             @return
             **/
            model: function(){
                var self = this;
                var baseResource = UmiSettings.baseURL + &#x27;/api/settings&#x27;;
                return $.getJSON(baseResource).then(function(results){
                    var result = results.result;
                    if(result.collections){
                        UMI.Utils.modelsFactory(result.collections);
                    }
                    if(result.resources){
                        UMI.Utils.setModelsResources(result.resources);
                    }
                    if(result.records){
                        var model;
                        for(model in result.records){
                            if(result.records.hasOwnProperty(model)){
                                self.store.pushMany(model, result.records[model]);
                            }
                        }
                    }

                    if(result.modules){
                        self.controllerFor(&#x27;dock&#x27;).set(&#x27;modules&#x27;, result);
                    }
                }, function(error){
                    throw new Error(&#x27;Не получен ресурс приложения &#x27; + baseResource + &#x27;.&#x27; + error);
                });
            },
            actions: {
                /**
                 * Метод вызывается каждый раз при смене роута в приложении.
                 * При переходе на роут &#x60;logout&#x60; выполняется abort для перехода,
                 * приложение становится неактивным и происходит смена шаблона на шаблон авторизации.
                 * @event willTransition
                 * @param {Object} transition
                 */
                willTransition: function(transition){
                    if(transition.targetName === &#x27;logout&#x27;){
                        transition.abort();
                        var applicationLayout = document.querySelector(&#x27;.umi-main-view&#x27;);
                        var maskLayout = document.createElement(&#x27;div&#x27;);
                        maskLayout.className = &#x27;auth-mask&#x27;;
                        maskLayout = document.body.appendChild(maskLayout);
                        $(applicationLayout).addClass(&#x27;off&#x27;);
                        $.post(&#x27;/admin/api/users/user/logout.json&#x27;);
                        require([&#x27;auth/main&#x27;], function(auth){
                            auth();
                            $(applicationLayout).addClass(&#x27;fade-out&#x27;);
                            Ember.run.later(&#x27;&#x27;, function(){
                                UMI.reset();
                                UMI.deferReadiness();
                                maskLayout.parentNode.removeChild(maskLayout);
                            }, 2000);
                        });
                    }
                }
            }
        });

        /**
         * @class IndexRoute
         * @extends Ember.Route
         */
        UMI.IndexRoute = Ember.Route.extend({
            /**
             Выполняет редирект на роут &#x60;Module&#x60;.
             @method redirect
             @return
             **/
            redirect: function(model, transition){
                if(transition.targetName === this.routeName){
                    var firstChild = this.controllerFor(&#x27;dock&#x27;).get(&#x27;content.firstObject&#x27;);
                    return this.transitionTo(&#x27;module&#x27;, &#x27;news&#x27;);//firstChild.get(&#x27;name&#x27;));
                }
            }
        });

        /**
         * @class IndexRoute
         * @extends Ember.Route
         */
        UMI.ModuleRoute = Ember.Route.extend({
            model: function(params){
                var modules = this.controllerFor(&#x27;dock&#x27;).get(&#x27;content&#x27;);
                var module = modules.findBy(&#x27;name&#x27;, params.module);
                // некрасивое решение
                this.controllerFor(&#x27;dock&#x27;).set(&#x27;activeModule&#x27;, module.get(&#x27;name&#x27;));
                modules.setEach(&#x27;isActive&#x27;, false);
                // Для добавления класса active вкладке модуля в dock добавим атрибут isActive
                module.set(&#x27;isActive&#x27;, true);
                return module;
            },
            redirect: function(model, transition){
                if(transition.targetName === this.routeName + &#x27;.index&#x27;){
                    var firstChild = model.get(&#x27;components.firstObject&#x27;);
                    return this.transitionTo(&#x27;component&#x27;, firstChild.get(&#x27;name&#x27;));
                }
            },
            serialize: function(model){
                return {module: model.get(&#x27;slug&#x27;)};
            }
        });

        UMI.ComponentRoute = Ember.Route.extend({
            /**
             * @method model
             * @param params
             * @param transition
             * @returns {*}
             */
            model: function(params, transition){
                var self = this;
                var components = this.modelFor(&#x27;module&#x27;).get(&#x27;components&#x27;);
                var model = components.findBy(&#x27;name&#x27;, transition.params.component.component);
                var componentResource = window.UmiSettings.baseApiURL + &#x27;/&#x27; + transition.params.module.module + &#x27;/&#x27; + transition.params.component.component + &#x27;/settings&#x27;;
                return Ember.$.get(componentResource).then(function(results){
                    if(results.result.error){
                        throw &#x27;Ресурс компонента не найден&#x27;;
                    }
                    var componentController = self.controllerFor(&#x27;component&#x27;);
                    var settings = results.result.settings;
                    var tree = settings.controls.findBy(&#x27;name&#x27;, &#x27;tree&#x27;);
                    componentController.set(&#x27;hasTree&#x27;, !!tree);
                    if(!!tree){
                        /**
                         * Колекция для дерева
                         */
                        var treeControl = self.controllerFor(&#x27;treeControl&#x27;);
                        treeControl.set(&#x27;collections&#x27;, [{&#x27;type&#x27;: model.get(&#x27;collection&#x27;), &#x27;displayName&#x27;: tree.displayName}]);
                        treeControl.set(&#x27;routeParams&#x27;, transition.params);
                    }
                    /**
                     * Режимы
                     */
                    var controls = settings.controls;
                    var context = settings.layout;
                    componentController.set(&#x27;controls&#x27;, controls);
                    componentController.set(&#x27;context&#x27;, context);
                    componentController.set(&#x27;selectedContext&#x27;, transition.params.context ? transition.params.context.context : &#x27;root&#x27;);
                    return model;
                }, function(error){
                    throw new Error(&#x27;Не получен ресурс компонета &#x27; + componentResource + &#x27;.&#x27; + error);
                });
            },
            redirect: function(model, transition){
                if(transition.targetName === this.routeName + &#x27;.index&#x27;){
                    var defaultAction = this.controllerFor(&#x27;component&#x27;).get(&#x27;contentControls.firstObject.name&#x27;);
                    return this.transitionTo(&#x27;action&#x27;, defaultAction);
                }
            },
            serialize: function(model){
                return {component: model.get(&#x27;name&#x27;)};
            }
        });

        UMI.ActionRoute = Ember.Route.extend({
            model: function(params){
                var modes = this.controllerFor(&#x27;component&#x27;).get(&#x27;contentControls&#x27;);
                return modes.findBy(&#x27;name&#x27;, params.action);
            },
            redirect: function(model, transition){
                if(transition.targetName === this.routeName + &#x27;.index&#x27;){
                    var self = this;
                    var contextId = this.controllerFor(&#x27;component&#x27;).get(&#x27;selectedContext&#x27;);
                    return self.transitionTo(&#x27;context&#x27;, contextId);
                }
            },
            serialize: function(model){
                if(model){
                    return {action: model.get(&#x27;name&#x27;)};
                }
            }
        });

        UMI.ContextRoute = Ember.Route.extend({
            model: function(params, transition){
                var self = this;
                var model;
                var routeData = {};
                var collectionName = self.modelFor(&#x27;component&#x27;).get(&#x27;collection&#x27;);
                var oldContext = this.controllerFor(&#x27;component&#x27;).get(&#x27;selectedContext&#x27;);
                this.controllerFor(&#x27;component&#x27;).set(&#x27;selectedContext&#x27;, params.context);
                /**
                 * Редирект на Action если контекст не имеет action
                 */
                var activeAction = this.modelFor(&#x27;action&#x27;);
                var firstAction = this.controllerFor(&#x27;component&#x27;).get(&#x27;contentControls.firstObject&#x27;);
                if(oldContext !== params.context &amp;&amp; firstAction.get(&#x27;name&#x27;) !== activeAction.get(&#x27;name&#x27;)){
                    return this.transitionTo(&#x27;action&#x27;, firstAction.get(&#x27;name&#x27;));
                }
                if(params.context === &#x27;root&#x27;){
                    var RootModel = Ember.Object.extend({
                        children: function(){
                            return self.store.find(collectionName, {&#x27;filters[parent]&#x27;: &#x27;null()&#x27;});
                        }.property()
                    });
                    model = RootModel.create({&#x27;id&#x27;: &#x27;root&#x27;});
                } else{
                    model = this.store.find(collectionName, params.context);
                }
                routeData.object = model;
                /**
                 * Раскрытие текущей ветки в дереве
                 */
                this.controllerFor(&#x27;treeControl&#x27;).set(&#x27;activeContext&#x27;, model);
                /**
                 * Мета информация для action
                 */
                var actionResource = window.UmiSettings.baseApiURL + &#x27;/&#x27; + transition.params.module.module + &#x27;/&#x27; + transition.params.component.component + &#x27;/&#x27; + this.modelFor(&#x27;component&#x27;).get(&#x27;collection&#x27;)  + &#x27;/&#x27; + transition.params.action.action;
                if(transition.params.action.action === &#x27;form&#x27;){
                    return Ember.$.get(actionResource).then(function(results){
                        var viewSettings = {};
                        viewSettings[transition.params.action.action] = results.result[transition.params.action.action];
                        routeData.viewSettings = viewSettings;
                        return routeData;
                    }, function(error){
                        throw new Error(&#x27;Не получена мета информация для action form &#x27; + actionResource + &#x27;.&#x27; + error);
                    });
                }
                // Временное решение для таблицы
                if(transition.params.action.action === &#x27;children&#x27;){
                    return Ember.$.getJSON(&#x27;/resources/modules/news/categories/children/resources.json&#x27;).then(function(results){
                        routeData.viewSettings = results.settings;
                        return routeData;
                    });
                }
                return routeData;
            },
            serialize: function(routeData){
                if(routeData.object){
                    return {context: routeData.object.get(&#x27;id&#x27;)};
                }
            },
            renderTemplate: function(){
                var templateType = this.modelFor(&#x27;action&#x27;).get(&#x27;name&#x27;);
                this.render(templateType);
            }
        });

        UMI.SearchRoute = Ember.Route.extend({
            model: function(params){
            }
        });
    };
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
