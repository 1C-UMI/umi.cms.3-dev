<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app\components\tree\views.js - umi-cms-3</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="umi-cms-3"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ApplicationRoute.html">ApplicationRoute</a></li>
            
                <li><a href="../classes/ComponentController.html">ComponentController</a></li>
            
                <li><a href="../classes/dialogelfinder - open elFinder in dialog window.html">dialogelfinder - open elFinder in dialog window</a></li>
            
                <li><a href="../classes/DS.ManyArray.html">DS.ManyArray</a></li>
            
                <li><a href="../classes/elFinder - file manager for web.html">elFinder - file manager for web</a></li>
            
                <li><a href="../classes/elFinder command &quot;archive&quot;
Archive selected files.html">elFinder command &quot;archive&quot;
Archive selected files</a></li>
            
                <li><a href="../classes/elFinder command &quot;back&quot;
Open last visited folder.html">elFinder command &quot;back&quot;
Open last visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;copy&quot;.
Put files in filemanager clipboard..html">elFinder command &quot;copy&quot;.
Put files in filemanager clipboard.</a></li>
            
                <li><a href="../classes/elFinder command &quot;download&quot;. 
Download selected files.
Only for new api.html">elFinder command &quot;download&quot;. 
Download selected files.
Only for new api</a></li>
            
                <li><a href="../classes/elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;.html">elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;</a></li>
            
                <li><a href="../classes/elFinder command &quot;edit&quot;. 
Edit text file in dialog window.html">elFinder command &quot;edit&quot;. 
Edit text file in dialog window</a></li>
            
                <li><a href="../classes/elFinder command &quot;extract&quot;
Extract files from archive.html">elFinder command &quot;extract&quot;
Extract files from archive</a></li>
            
                <li><a href="../classes/elFinder command &quot;forward&quot;
Open next visited folder.html">elFinder command &quot;forward&quot;
Open next visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc..html">elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc.</a></li>
            
                <li><a href="../classes/elFinder command &quot;help&quot;
&quot;About&quot; dialog.html">elFinder command &quot;help&quot;
&quot;About&quot; dialog</a></li>
            
                <li><a href="../classes/elFinder command &quot;info&quot;. 
Display dialog with file properties..html">elFinder command &quot;info&quot;. 
Display dialog with file properties.</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkdir&quot;
Create new folder.html">elFinder command &quot;mkdir&quot;
Create new folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkfile&quot;
Create new empty file.html">elFinder command &quot;mkfile&quot;
Create new empty file</a></li>
            
                <li><a href="../classes/elFinder command &quot;netmount&quot;
Mount network volume with user credentials..html">elFinder command &quot;netmount&quot;
Mount network volume with user credentials.</a></li>
            
                <li><a href="../classes/elFinder command &quot;open&quot;
Enter folder or open files in new windows.html">elFinder command &quot;open&quot;
Enter folder or open files in new windows</a></li>
            
                <li><a href="../classes/elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created.html">elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created</a></li>
            
                <li><a href="../classes/elFinder command &quot;quicklook&quot;
Fast preview for some files types.html">elFinder command &quot;quicklook&quot;
Fast preview for some files types</a></li>
            
                <li><a href="../classes/elFinder command &quot;reload&quot;
Sync files and folders.html">elFinder command &quot;reload&quot;
Sync files and folders</a></li>
            
                <li><a href="../classes/elFinder command &quot;rename&quot;. 
Rename selected file..html">elFinder command &quot;rename&quot;. 
Rename selected file.</a></li>
            
                <li><a href="../classes/elFinder command &quot;resize&quot;
Open dialog to resize image.html">elFinder command &quot;resize&quot;
Open dialog to resize image</a></li>
            
                <li><a href="../classes/elFinder command &quot;rm&quot;
Delete files.html">elFinder command &quot;rm&quot;
Delete files</a></li>
            
                <li><a href="../classes/elFinder command &quot;search&quot;
Find files.html">elFinder command &quot;search&quot;
Find files</a></li>
            
                <li><a href="../classes/elFinder command &quot;sort&quot;
Change sort files rule.html">elFinder command &quot;sort&quot;
Change sort files rule</a></li>
            
                <li><a href="../classes/elFinder command &quot;up&quot;
Go into parent directory.html">elFinder command &quot;up&quot;
Go into parent directory</a></li>
            
                <li><a href="../classes/elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop.html">elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop</a></li>
            
                <li><a href="../classes/elFinder command &quot;view&quot;
Change current directory view (icons/list).html">elFinder command &quot;view&quot;
Change current directory view (icons/list)</a></li>
            
                <li><a href="../classes/elFinder contextmenu.html">elFinder contextmenu</a></li>
            
                <li><a href="../classes/elFinder dialog.html">elFinder dialog</a></li>
            
                <li><a href="../classes/elFinder folders tree.html">elFinder folders tree</a></li>
            
                <li><a href="../classes/elFinder places/favorites ui.html">elFinder places/favorites ui</a></li>
            
                <li><a href="../classes/elFinder toolbar.html">elFinder toolbar</a></li>
            
                <li><a href="../classes/elFinder toolbar button menu with sort variants..html">elFinder toolbar button menu with sort variants.</a></li>
            
                <li><a href="../classes/elFinder toolbar button to switch current directory view..html">elFinder toolbar button to switch current directory view.</a></li>
            
                <li><a href="../classes/elFinder toolbar button widget.
If command has variants - create menu.html">elFinder toolbar button widget.
If command has variants - create menu</a></li>
            
                <li><a href="../classes/elFinder toolbar search button widget..html">elFinder toolbar search button widget.</a></li>
            
                <li><a href="../classes/elFinder toolbar&#x27;s button tor upload file.html">elFinder toolbar&#x27;s button tor upload file</a></li>
            
                <li><a href="../classes/elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder.html">elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder</a></li>
            
                <li><a href="../classes/elFinder ui
Display number of files/selected files and its size in statusbar.html">elFinder ui
Display number of files/selected files and its size in statusbar</a></li>
            
                <li><a href="../classes/elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods.html">elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods</a></li>
            
                <li><a href="../classes/elfindernav - elFinder container for diretories tree and places.html">elfindernav - elFinder container for diretories tree and places</a></li>
            
                <li><a href="../classes/elfinderworkzone - elFinder container for nav and current directory.html">elfinderworkzone - elFinder container for nav and current directory</a></li>
            
                <li><a href="../classes/IndexRoute.html">IndexRoute</a></li>
            
                <li><a href="../classes/Inflector.inflector.html">Inflector.inflector</a></li>
            
                <li><a href="../classes/map.html">map</a></li>
            
                <li><a href="../classes/UmiRESTAdapter.html">UmiRESTAdapter</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Router.html">Router</a></li>
            
                <li><a href="../modules/UMI.html">UMI</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app\components\tree\views.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
define([&#x27;App&#x27;], function(UMI){
    &#x27;use strict&#x27;;
    return function(){

        UMI.TreeItemView = Ember.View.extend({
            tagName: &#x27;div&#x27;,
            classNames: [&#x27;umi-item&#x27;],
            classNameBindings: [&#x27;root&#x27;, &#x27;inActive&#x27;, &#x27;active&#x27;],
            root: function(){
                return this.get(&#x27;model.id&#x27;) === &#x27;root&#x27;;
            }.property(&#x27;root&#x27;),
            inActive: function(){
                return !this.get(&#x27;model.active&#x27;);
            }.property(&#x27;active&#x27;),
            active: function(){
                return this.get(&#x27;controller.controllers.treeControl.activeContext.id&#x27;) === this.get(&#x27;model.id&#x27;);
            }.property(&#x27;controller.controllers.treeControl.activeContext.id&#x27;)
        });

        UMI.TreeControlView = Ember.View.extend({
            tagName: &#x27;div&#x27;,
            classNames: [&#x27;row&#x27;, &#x27;s-full-height&#x27;],
            didInsertElement: function(){
                //Выпадающее меню
                $(&#x27;.umi-tree&#x27;).on(&#x27;mousedown&#x27;, &#x27;.umi-tree-drop-down-toggler&#x27;, function(){
                    event.stopPropagation();
                    $(&#x27;.umi-tree-drop-down&#x27;).remove();

                    var x = $(this).offset().left - 133;
                    var y = $(this).offset().top + 24;

                    $(this).append(document.querySelector(&#x27;#umi-tree-menu&#x27;).innerHTML);
                    $(&#x27;.umi-tree-drop-down&#x27;).offset({top: y, left: x});
                });

                //Скрытие выпадающего меню при клике вне его области
                $(&#x27;html&#x27;).on(&#x27;mousedown&#x27;, function(){
//                    console.log(&#x27;Это событие будет всегда вызываться, делай unbind&#x27;);
                    //Нужно просто перенести внутрь вызова .umi-tree-drop-down. Но я сделаю это после того как ты наиграешься с открытием по наведению.
                    $(&#x27;.umi-tree-drop-down&#x27;).remove();
                });

                $(&#x27;.umi-tree-drop-down&#x27;).mousedown(function(event){
                    event.stopPropagation();
                });


                //Переключение табов в выпадающем меню
                $(&#x27;.umi-tree&#x27;).on(&#x27;mousedown&#x27;, &#x27;.umi-tree-tab&#x27;, function(event){
                    event.stopPropagation();
                    $(&#x27;.umi-tree-tab, .umi-tree-tab-content&#x27;).removeClass(&#x27;active&#x27;);
                    $(this).addClass(&#x27;active&#x27;);

                    var i = $(this).index(&#x27;.umi-tree-drop-down .umi-tree-tab&#x27;);
                    $(&#x27;.umi-tree-tab-content&#x27;).eq(i).addClass(&#x27;active&#x27;);
                });

                var self = this;
                var dragAndDrop = function(event, el){
                    var draggableNode = el.parentNode.parentNode;
                    var placeholder = document.createElement(&#x27;li&#x27;);
                    var ghost = document.createElement(&#x27;span&#x27;);
                    // Смещение призрака относительно курсора
                    var ghostPositionOffset = 2;

                    $(&#x27;html&#x27;).addClass(&#x27;s-unselectable&#x27;);
                    // Для компонента tree класс выставлюющий потомкам cursor=default
                    self.$().addClass(&#x27;drag-inside&#x27;);
                    // Добавим плейсхолдер на место перемещаемой ноды
                    placeholder.className = &#x27;umi-tree-placeholder&#x27;;
                    placeholder.setAttribute(&#x27;data-id&#x27;, el.parentNode.parentNode.getAttribute(&#x27;data-id&#x27;));
                    $(draggableNode).addClass(&#x27;hide&#x27;);
                    placeholder = draggableNode.parentNode.insertBefore(placeholder, draggableNode);

                    // Добавим призрак
                    ghost.className = &#x27;umi-tree-ghost&#x27;;
                    ghost.innerHTML = &#x27;&lt;i class=&quot;&#x27; + el.className + &#x27;&quot;&gt;&lt;/i&gt;&#x27; + $(el.parentNode).children(&#x27;a&#x27;).text();
                    ghost = document.body.appendChild(ghost);

                    /**
                     * Устанавливает позицию призрака
                     * */
                    var ghostPosition = function(event){
                        ghost.style.top = event.pageY + ghostPositionOffset + &#x27;px&#x27;;
                        ghost.style.left = event.pageX + ghostPositionOffset + &#x27;px&#x27;;
                    };
                    ghostPosition(event);

                    /**
                     * Возвращает соседний элемент определеного типа
                     *
                     * @param {Object} Элемент для которого нужно найти следующих соседей
                     * @param {string} Тип элемента который требуется найти
                     * @returns {Object|Null} Возвращаем найденный элемент
                     * */
                    function findNextSubling(element, type){
                        type = type.toUpperCase();
                        var nextElement = element.nextElementSibling;
                        while(nextElement &amp;&amp; nextElement.tagName !== type){
                            nextElement = nextElement.nextElementSibling;
                        }
                        return nextElement;
                    }

                    var delayBeforeExpand;
                    $(document).on(&#x27;mousemove&#x27;, &#x27;body, .umi-tree-ghost&#x27;, function(event){
                        if(delayBeforeExpand){
                            clearTimeout(delayBeforeExpand);
                        }
                        ghostPosition(event);
                        var nextElement;
                        var hoverElement;
                        var elemHeight;
                        var elemPositionTop;
                        // Вычисляем элемент под курсором мыши
                        var elem = document.elementFromPoint(event.clientX, event.clientY);

                        // Расскороем ноду имеющую потомков
                        var setExpanded = function(node){
                            // Предполагаем что div всегда будет первым потомком в li
                            // но та к делать не круто
                            Ember.View.views[node.firstElementChild.id].get(&#x27;controller&#x27;).set(&#x27;isExpanded&#x27;, true);
                        };
                        // Проверим находимся мы над деревом или нет
                        if($(elem).closest(&#x27;.umi-tree&#x27;).length){
                            hoverElement = $(elem).closest(&#x27;li&#x27;)[0];
                            // Устанавливаем плэйсхолдер рядом с элементом
                            if(hoverElement &amp;&amp; hoverElement !== placeholder &amp;&amp; !$(hoverElement).hasClass(&#x27;root&#x27;)){
                                elemHeight = hoverElement.offsetHeight;
                                elemPositionTop = hoverElement.getBoundingClientRect().top;
                                // Помещаем плэйсхолдер:
                                // 1) после ноды - Если позиция курсора на ноде ниже ~70% её высоты
                                // 2) перед нодой - Если позиция курсора на ноде выше ~30% её высоты
                                // 3) При наведении на центр необходимо раскрыть ноду если есть потомки
                                //    или спросить пользователя о ....
                                if(event.clientY &gt; elemPositionTop + parseInt(elemHeight * 0.7, 10)){
                                    placeholder = placeholder.parentNode.removeChild(placeholder);
                                    nextElement = findNextSubling(hoverElement, &#x27;li&#x27;);
                                    if(nextElement){
                                        placeholder = hoverElement.parentNode.insertBefore(placeholder, nextElement);
                                    } else{
                                        placeholder = hoverElement.parentNode.appendChild(placeholder);
                                    }
                                } else if(event.clientY &lt; elemPositionTop + parseInt(elemHeight * 0.4, 10)){
                                    placeholder = placeholder.parentNode.removeChild(placeholder);
                                    placeholder = hoverElement.parentNode.insertBefore(placeholder, hoverElement);
                                } else{
                                    delayBeforeExpand = setTimeout(function(){
                                        setExpanded(hoverElement);
                                    }, 500);
                                }
                            }
                        }
                    });

                    $(document).on(&#x27;mouseup&#x27;, function(event){
                        var elem = document.elementFromPoint(event.clientX, event.clientY);
                        var prevSiblingId = null;
                        var list = $(elem).closest(&#x27;.umi-tree-list&#x27;)[0];

                        // Удаляем обработчик события
                        $(document).off(&#x27;mousemove&#x27;, &#x27;body, .umi-tree-ghost&#x27;);
                        $(document).off(&#x27;mouseup&#x27;);
                        //Удаление призрака
                        ghost.parentNode.removeChild(ghost);

                        // Если курсор над плейсхолдером считаем что перемещение удачное
                        if(list &amp;&amp; !$(list).hasClass(&#x27;umi-tree&#x27;)){
                            /**
                             * Находим предыдущего соседа
                             */
                            (function findPrevSibling(el){
                                var sibling = el.previousElementSibling;
                                if(sibling &amp;&amp; ($(sibling).hasClass(&#x27;hide&#x27;) || sibling.tagName !== &#x27;LI&#x27;)){
                                    findPrevSibling(sibling);
                                } else{
                                    prevSiblingId = sibling ? sibling.getAttribute(&#x27;data-id&#x27;) : null;
                                }
                            }(placeholder));

                            var nextSibling = [];
                            /**
                             * Фильтр элементов списка
                             */
                            (function findNextSibling(element){
                                var sibling = element.nextElementSibling;
                                if(sibling){
                                    if($(sibling).hasClass(&#x27;hide&#x27;) || sibling.tagName !== &#x27;LI&#x27;){
                                        findNextSibling(sibling);
                                    } else{
                                        nextSibling.push(sibling.getAttribute(&#x27;data-id&#x27;));
                                    }
                                }
                            }(placeholder));
                            var parentId = list.getAttribute(&#x27;data-parent-id&#x27;);
                            self.get(&#x27;controller&#x27;).send(&#x27;updateSortOrder&#x27;, placeholder.getAttribute(&#x27;data-id&#x27;), parentId, prevSiblingId, nextSibling);
                        }
                        // Удаление плэйсхолдера
                        if(placeholder.parentNode){
                            placeholder.parentNode.removeChild(placeholder);
                        }
                        $(draggableNode).removeClass(&#x27;hide&#x27;);
                        $(&#x27;html&#x27;).removeClass(&#x27;s-unselectable&#x27;);
                    });
                };
                var timeoutForDrag;
                this.$().on(&#x27;mousedown&#x27;, &#x27;.icon.move&#x27;, function(event){
                    if(event.originalEvent.which !== 1){
                        return;
                    }
                    var el = this;
                    timeoutForDrag = setTimeout(function(){
                        dragAndDrop(event, el);
                    }, 200);
                });
                this.$().on(&#x27;mouseup&#x27;, &#x27;.icon.move&#x27;, function(){
                    if(timeoutForDrag){
                        clearTimeout(timeoutForDrag);
                    }
                });
            }
        });
    };
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
