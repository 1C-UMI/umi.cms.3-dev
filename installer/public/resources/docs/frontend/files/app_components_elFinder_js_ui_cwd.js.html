<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app\components\elFinder\js\ui\cwd.js - umi-cms-3</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="umi-cms-3"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ApplicationRoute.html">ApplicationRoute</a></li>
            
                <li><a href="../classes/ComponentController.html">ComponentController</a></li>
            
                <li><a href="../classes/dialogelfinder - open elFinder in dialog window.html">dialogelfinder - open elFinder in dialog window</a></li>
            
                <li><a href="../classes/DS.ManyArray.html">DS.ManyArray</a></li>
            
                <li><a href="../classes/elFinder - file manager for web.html">elFinder - file manager for web</a></li>
            
                <li><a href="../classes/elFinder command &quot;archive&quot;
Archive selected files.html">elFinder command &quot;archive&quot;
Archive selected files</a></li>
            
                <li><a href="../classes/elFinder command &quot;back&quot;
Open last visited folder.html">elFinder command &quot;back&quot;
Open last visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;copy&quot;.
Put files in filemanager clipboard..html">elFinder command &quot;copy&quot;.
Put files in filemanager clipboard.</a></li>
            
                <li><a href="../classes/elFinder command &quot;download&quot;. 
Download selected files.
Only for new api.html">elFinder command &quot;download&quot;. 
Download selected files.
Only for new api</a></li>
            
                <li><a href="../classes/elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;.html">elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;</a></li>
            
                <li><a href="../classes/elFinder command &quot;edit&quot;. 
Edit text file in dialog window.html">elFinder command &quot;edit&quot;. 
Edit text file in dialog window</a></li>
            
                <li><a href="../classes/elFinder command &quot;extract&quot;
Extract files from archive.html">elFinder command &quot;extract&quot;
Extract files from archive</a></li>
            
                <li><a href="../classes/elFinder command &quot;forward&quot;
Open next visited folder.html">elFinder command &quot;forward&quot;
Open next visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc..html">elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc.</a></li>
            
                <li><a href="../classes/elFinder command &quot;help&quot;
&quot;About&quot; dialog.html">elFinder command &quot;help&quot;
&quot;About&quot; dialog</a></li>
            
                <li><a href="../classes/elFinder command &quot;info&quot;. 
Display dialog with file properties..html">elFinder command &quot;info&quot;. 
Display dialog with file properties.</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkdir&quot;
Create new folder.html">elFinder command &quot;mkdir&quot;
Create new folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkfile&quot;
Create new empty file.html">elFinder command &quot;mkfile&quot;
Create new empty file</a></li>
            
                <li><a href="../classes/elFinder command &quot;netmount&quot;
Mount network volume with user credentials..html">elFinder command &quot;netmount&quot;
Mount network volume with user credentials.</a></li>
            
                <li><a href="../classes/elFinder command &quot;open&quot;
Enter folder or open files in new windows.html">elFinder command &quot;open&quot;
Enter folder or open files in new windows</a></li>
            
                <li><a href="../classes/elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created.html">elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created</a></li>
            
                <li><a href="../classes/elFinder command &quot;quicklook&quot;
Fast preview for some files types.html">elFinder command &quot;quicklook&quot;
Fast preview for some files types</a></li>
            
                <li><a href="../classes/elFinder command &quot;reload&quot;
Sync files and folders.html">elFinder command &quot;reload&quot;
Sync files and folders</a></li>
            
                <li><a href="../classes/elFinder command &quot;rename&quot;. 
Rename selected file..html">elFinder command &quot;rename&quot;. 
Rename selected file.</a></li>
            
                <li><a href="../classes/elFinder command &quot;resize&quot;
Open dialog to resize image.html">elFinder command &quot;resize&quot;
Open dialog to resize image</a></li>
            
                <li><a href="../classes/elFinder command &quot;rm&quot;
Delete files.html">elFinder command &quot;rm&quot;
Delete files</a></li>
            
                <li><a href="../classes/elFinder command &quot;search&quot;
Find files.html">elFinder command &quot;search&quot;
Find files</a></li>
            
                <li><a href="../classes/elFinder command &quot;sort&quot;
Change sort files rule.html">elFinder command &quot;sort&quot;
Change sort files rule</a></li>
            
                <li><a href="../classes/elFinder command &quot;up&quot;
Go into parent directory.html">elFinder command &quot;up&quot;
Go into parent directory</a></li>
            
                <li><a href="../classes/elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop.html">elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop</a></li>
            
                <li><a href="../classes/elFinder command &quot;view&quot;
Change current directory view (icons/list).html">elFinder command &quot;view&quot;
Change current directory view (icons/list)</a></li>
            
                <li><a href="../classes/elFinder contextmenu.html">elFinder contextmenu</a></li>
            
                <li><a href="../classes/elFinder dialog.html">elFinder dialog</a></li>
            
                <li><a href="../classes/elFinder folders tree.html">elFinder folders tree</a></li>
            
                <li><a href="../classes/elFinder places/favorites ui.html">elFinder places/favorites ui</a></li>
            
                <li><a href="../classes/elFinder toolbar.html">elFinder toolbar</a></li>
            
                <li><a href="../classes/elFinder toolbar button menu with sort variants..html">elFinder toolbar button menu with sort variants.</a></li>
            
                <li><a href="../classes/elFinder toolbar button to switch current directory view..html">elFinder toolbar button to switch current directory view.</a></li>
            
                <li><a href="../classes/elFinder toolbar button widget.
If command has variants - create menu.html">elFinder toolbar button widget.
If command has variants - create menu</a></li>
            
                <li><a href="../classes/elFinder toolbar search button widget..html">elFinder toolbar search button widget.</a></li>
            
                <li><a href="../classes/elFinder toolbar&#x27;s button tor upload file.html">elFinder toolbar&#x27;s button tor upload file</a></li>
            
                <li><a href="../classes/elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder.html">elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder</a></li>
            
                <li><a href="../classes/elFinder ui
Display number of files/selected files and its size in statusbar.html">elFinder ui
Display number of files/selected files and its size in statusbar</a></li>
            
                <li><a href="../classes/elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods.html">elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods</a></li>
            
                <li><a href="../classes/elfindernav - elFinder container for diretories tree and places.html">elfindernav - elFinder container for diretories tree and places</a></li>
            
                <li><a href="../classes/elfinderworkzone - elFinder container for nav and current directory.html">elfinderworkzone - elFinder container for nav and current directory</a></li>
            
                <li><a href="../classes/IndexRoute.html">IndexRoute</a></li>
            
                <li><a href="../classes/Inflector.inflector.html">Inflector.inflector</a></li>
            
                <li><a href="../classes/map.html">map</a></li>
            
                <li><a href="../classes/UmiRESTAdapter.html">UmiRESTAdapter</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Router.html">Router</a></li>
            
                <li><a href="../modules/UMI.html">UMI</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app\components\elFinder\js\ui\cwd.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&quot;use strict&quot;;
/**
 * elFinder current working directory ui.
 *
 * @author Dmitry (dio) Levashov
 **/
$.fn.elfindercwd = function(fm, options) {
	
	this.not(&#x27;.elfinder-cwd&#x27;).each(function() {
		// fm.time(&#x27;cwdLoad&#x27;);
		
		var 
			list = fm.viewType == &#x27;list&#x27;,

			undef = &#x27;undefined&#x27;,
			/**
			 * Select event full name
			 *
			 * @type String
			 **/
			evtSelect = &#x27;select.&#x27;+fm.namespace,
			
			/**
			 * Unselect event full name
			 *
			 * @type String
			 **/
			evtUnselect = &#x27;unselect.&#x27;+fm.namespace,
			
			/**
			 * Disable event full name
			 *
			 * @type String
			 **/
			evtDisable = &#x27;disable.&#x27;+fm.namespace,
			
			/**
			 * Disable event full name
			 *
			 * @type String
			 **/
			evtEnable = &#x27;enable.&#x27;+fm.namespace,
			
			c = &#x27;class&#x27;,
			/**
			 * File css class
			 *
			 * @type String
			 **/
			clFile       = fm.res(c, &#x27;cwdfile&#x27;),
			
			/**
			 * Selected css class
			 *
			 * @type String
			 **/
			fileSelector = &#x27;.&#x27;+clFile,
			
			/**
			 * Selected css class
			 *
			 * @type String
			 **/
			clSelected = &#x27;ui-selected&#x27;,
			
			/**
			 * Disabled css class
			 *
			 * @type String
			 **/
			clDisabled = fm.res(c, &#x27;disabled&#x27;),
			
			/**
			 * Draggable css class
			 *
			 * @type String
			 **/
			clDraggable = fm.res(c, &#x27;draggable&#x27;),
			
			/**
			 * Droppable css class
			 *
			 * @type String
			 **/
			clDroppable = fm.res(c, &#x27;droppable&#x27;),
			
			/**
			 * Hover css class
			 *
			 * @type String
			 **/
			clHover     = fm.res(c, &#x27;hover&#x27;), 

			/**
			 * Hover css class
			 *
			 * @type String
			 **/
			clDropActive = fm.res(c, &#x27;adroppable&#x27;),

			/**
			 * Css class for temporary nodes (for mkdir/mkfile) commands
			 *
			 * @type String
			 **/
			clTmp = clFile+&#x27;-tmp&#x27;,

			/**
			 * Number of thumbnails to load in one request (new api only)
			 *
			 * @type Number
			 **/
			tmbNum = fm.options.loadTmbs &gt; 0 ? fm.options.loadTmbs : 5,
			
			/**
			 * Current search query.
			 *
			 * @type String
			 */
			query = &#x27;&#x27;,
			
			lastSearch = [],

			/**
			 * File templates
			 *
			 * @type Object
			 **/
			templates = {
				icon : &#x27;&lt;div id=&quot;{hash}&quot; class=&quot;&#x27;+clFile+&#x27; {permsclass} {dirclass} ui-corner-all&quot; title=&quot;{tooltip}&quot;&gt;&lt;div class=&quot;elfinder-cwd-file-wrapper ui-corner-all&quot;&gt;&lt;div class=&quot;elfinder-cwd-icon {mime} ui-corner-all&quot; unselectable=&quot;on&quot; {style}/&gt;{marker}&lt;/div&gt;&lt;div class=&quot;elfinder-cwd-filename&quot; title=&quot;{name}&quot;&gt;{name}&lt;/div&gt;&lt;/div&gt;&#x27;,
				row  : &#x27;&lt;tr id=&quot;{hash}&quot; class=&quot;&#x27;+clFile+&#x27; {permsclass} {dirclass}&quot; title=&quot;{tooltip}&quot;&gt;&lt;td&gt;&lt;div class=&quot;elfinder-cwd-file-wrapper&quot;&gt;&lt;span class=&quot;elfinder-cwd-icon {mime}&quot;/&gt;{marker}&lt;span class=&quot;elfinder-cwd-filename&quot;&gt;{name}&lt;/span&gt;&lt;/div&gt;&lt;/td&gt;&lt;td&gt;{perms}&lt;/td&gt;&lt;td&gt;{date}&lt;/td&gt;&lt;td&gt;{size}&lt;/td&gt;&lt;td&gt;{kind}&lt;/td&gt;&lt;/tr&gt;&#x27;
			},
			
			permsTpl = fm.res(&#x27;tpl&#x27;, &#x27;perms&#x27;),
			
			symlinkTpl = fm.res(&#x27;tpl&#x27;, &#x27;symlink&#x27;),
			
			/**
			 * Template placeholders replacement rules
			 *
			 * @type Object
			 **/
			replacement = {
				permsclass : function(f) {
					return fm.perms2class(f);
				},
				perms : function(f) {
					return fm.formatPermissions(f);
				},
				dirclass : function(f) {
					return f.mime == &#x27;directory&#x27; ? &#x27;directory&#x27; : &#x27;&#x27;;
				},
				mime : function(f) {
					return fm.mime2class(f.mime);
				},
				size : function(f) {
					return fm.formatSize(f.size);
				},
				date : function(f) {
					return fm.formatDate(f);
				},
				kind : function(f) {
					return fm.mime2kind(f);
				},
				marker : function(f) {
					return (f.alias || f.mime == &#x27;symlink-broken&#x27; ? symlinkTpl : &#x27;&#x27;)+(!f.read || !f.write ? permsTpl : &#x27;&#x27;);
				},
				tooltip : function(f) {
					var title = fm.formatDate(f) + (f.size &gt; 0 ? &#x27; (&#x27;+fm.formatSize(f.size)+&#x27;)&#x27; : &#x27;&#x27;);
					return f.tooltip? fm.escape(f.tooltip).replace(/&quot;/g, &#x27;&amp;quot;&#x27;).replace(/\r/g, &#x27;&amp;#13;&#x27;) + &#x27;&amp;#13;&#x27; + title : title;
				}
			},
			
			/**
			 * Return file html
			 *
			 * @param  Object  file info
			 * @return String
			 **/
			itemhtml = function(f) {
				f.name = fm.escape(f.name);
				return templates[list ? &#x27;row&#x27; : &#x27;icon&#x27;]
						.replace(/\{([a-z]+)\}/g, function(s, e) { 
							return replacement[e] ? replacement[e](f) : (f[e] ? f[e] : &#x27;&#x27;); 
						});
			},
			
			/**
			 * Flag. Required for msie to avoid unselect files on dragstart
			 *
			 * @type Boolean
			 **/
			selectLock = false,
			
			/**
			 * Move selection to prev/next file
			 *
			 * @param String  move direction
			 * @param Boolean append to current selection
			 * @return void
			 * @rise select			
			 */
			select = function(keyCode, append) {
				var code     = $.ui.keyCode,
					prev     = keyCode == code.LEFT || keyCode == code.UP,
					sel      = cwd.find(&#x27;[id].&#x27;+clSelected),
					selector = prev ? &#x27;first:&#x27; : &#x27;last&#x27;,
					s, n, sib, top, left;

				function sibling(n, direction) {
					return n[direction+&#x27;All&#x27;](&#x27;[id]:not(.&#x27;+clDisabled+&#x27;):not(.elfinder-cwd-parent):first&#x27;);
				}
				
				if (sel.length) {
					s = sel.filter(prev ? &#x27;:first&#x27; : &#x27;:last&#x27;);
					sib = sibling(s, prev ? &#x27;prev&#x27; : &#x27;next&#x27;);
					
					if (!sib.length) {
						// there is no sibling on required side - do not move selection
						n = s;
					} else if (list || keyCode == code.LEFT || keyCode == code.RIGHT) {
						// find real prevoius file
						n = sib;
					} else {
						// find up/down side file in icons view
						top = s.position().top;
						left = s.position().left;

						n = s;
						if (prev) {
							do {
								n = n.prev(&#x27;[id]&#x27;);
							} while (n.length &amp;&amp; !(n.position().top &lt; top &amp;&amp; n.position().left &lt;= left));

							if (n.is(&#x27;.&#x27;+clDisabled)) {
								n = sibling(n, &#x27;next&#x27;);
							}
						} else {
							do {
								n = n.next(&#x27;[id]&#x27;);
							} while (n.length &amp;&amp; !(n.position().top &gt; top &amp;&amp; n.position().left &gt;= left));
							
							if (n.is(&#x27;.&#x27;+clDisabled)) {
								n = sibling(n, &#x27;prev&#x27;);
							}
							// there is row before last one - select last file
							if (!n.length) {
								sib = cwd.find(&#x27;[id]:not(.&#x27;+clDisabled+&#x27;):last&#x27;);
								if (sib.position().top &gt; top) {
									n = sib;
								}
							}
						}
					}
					// !append &amp;&amp; unselectAll();
				} else {
					// there are no selected file - select first/last one
					n = cwd.find(&#x27;[id]:not(.&#x27;+clDisabled+&#x27;):not(.elfinder-cwd-parent):&#x27;+(prev ? &#x27;last&#x27; : &#x27;first&#x27;));
				}
				
				if (n &amp;&amp; n.length &amp;&amp; !n.is(&#x27;.elfinder-cwd-parent&#x27;)) {
					if (append) {
						// append new files to selected
						n = s.add(s[prev ? &#x27;prevUntil&#x27; : &#x27;nextUntil&#x27;](&#x27;#&#x27;+n.attr(&#x27;id&#x27;))).add(n);
					} else {
						// unselect selected files
						sel.trigger(evtUnselect);
					}
					// select file(s)
					n.trigger(evtSelect);
					// set its visible
					scrollToView(n.filter(prev ? &#x27;:first&#x27; : &#x27;:last&#x27;));
					// update cache/view
					trigger();
				}
			},
			
			selectedFiles = [],
			
			selectFile = function(hash) {
				cwd.find(&#x27;#&#x27;+hash).trigger(evtSelect);
			},
			
			selectAll = function() {
				var phash = fm.cwd().hash;

				cwd.find(&#x27;[id]:not(.&#x27;+clSelected+&#x27;):not(.elfinder-cwd-parent)&#x27;).trigger(evtSelect); 
				selectedFiles = $.map(fm.files(), function(f) { return f.phash == phash ? f.hash : null ;});
				trigger();
			},
			
			/**
			 * Unselect all files
			 *
			 * @return void
			 */
			unselectAll = function() {
				selectedFiles = [];
				cwd.find(&#x27;[id].&#x27;+clSelected).trigger(evtUnselect); 
				trigger();
			},
			
			/**
			 * Return selected files hashes list
			 *
			 * @return Array
			 */
			selected = function() {
				return selectedFiles;
			},
			
			/**
			 * Fire elfinder &quot;select&quot; event and pass selected files to it
			 *
			 * @return void
			 */
			trigger = function() {
				fm.trigger(&#x27;select&#x27;, {selected : selectedFiles});
			},
			
			/**
			 * Scroll file to set it visible
			 *
			 * @param DOMElement  file/dir node
			 * @return void
			 */
			scrollToView = function(o) {
				var ftop    = o.position().top,
					fheight = o.outerHeight(true),
					wtop    = wrapper.scrollTop(),
					wheight = wrapper.innerHeight();

				if (ftop + fheight &gt; wtop + wheight) {
					wrapper.scrollTop(parseInt(ftop + fheight - wheight));
				} else if (ftop &lt; wtop) {
					wrapper.scrollTop(ftop);
				}
			},
			
			/**
			 * Files we get from server but not show yet
			 *
			 * @type Array
			 **/
			buffer = [],
			
			/**
			 * Return index of elements with required hash in buffer 
			 *
			 * @param String  file hash
			 * @return Number
			 */
			index = function(hash) {
				var l = buffer.length;
				
				while (l--) {
					if (buffer[l].hash == hash) {
						return l;
					}
				}
				return -1;
			},
			
			/**
			 * Scroll event name
			 *
			 * @type String
			 **/
			scrollEvent = &#x27;scroll.&#x27;+fm.namespace,

			/**
			 * Cwd scroll event handler.
			 * Lazy load - append to cwd not shown files
			 *
			 * @return void
			 */
			render = function() {
				var html  = [],  
					dirs  = false, 
					ltmb  = [],
					atmb  = {},
					last  = cwd.find(&#x27;[id]:last&#x27;),
					top   = !last.length,
					place = list ? cwd.children(&#x27;table&#x27;).children(&#x27;tbody&#x27;) : cwd,
					files;

				if (!buffer.length) {
					return wrapper.unbind(scrollEvent);
				}
				
				while ((!last.length || last.position().top &lt;= wrapper.height() + wrapper.scrollTop() + fm.options.showThreshold)
					&amp;&amp; (files = buffer.splice(0, fm.options.showFiles)).length) {
					
					html = $.map(files, function(f) {
						if (f.hash &amp;&amp; f.name) {
							if (f.mime == &#x27;directory&#x27;) {
								dirs = true;
							}
							if (f.tmb) {
								f.tmb === 1 ? ltmb.push(f.hash) : (atmb[f.hash] = f.tmb);
							} 
							return itemhtml(f);
						}
						return null;
					});

					place.append(html.join(&#x27;&#x27;));
					last = cwd.find(&#x27;[id]:last&#x27;);
					// scroll top on dir load to avoid scroll after page reload
					top &amp;&amp; cwd.scrollTop(0);
					
				}

				// load/attach thumbnails
				attachThumbnails(atmb);
				ltmb.length &amp;&amp; loadThumbnails(ltmb);

				// make directory droppable
				dirs &amp;&amp; makeDroppable();
				
				if (selectedFiles.length) {
					place.find(&#x27;[id]:not(.&#x27;+clSelected+&#x27;):not(.elfinder-cwd-parent)&#x27;).each(function() {
						var id = this.id;
						
						$.inArray(id, selectedFiles) !== -1 &amp;&amp; $(this).trigger(evtSelect);
					});
				}
				
			},
			
			/**
			 * Droppable options for cwd.
			 * Do not add class on childs file over
			 *
			 * @type Object
			 */
			droppable = $.extend({}, fm.droppable, {
				over : function(e, ui) { 
					var hash = fm.cwd().hash;
					$.each(ui.helper.data(&#x27;files&#x27;), function(i, h) {
						if (fm.file(h).phash == hash) {
							cwd.removeClass(clDropActive);
							return false;
						}
					});
				}
			}),
			
			/**
			 * Make directory droppable
			 *
			 * @return void
			 */
			makeDroppable = function() {
				setTimeout(function() {
					cwd.find(&#x27;.directory:not(.&#x27;+clDroppable+&#x27;,.elfinder-na,.elfinder-ro)&#x27;).droppable(fm.droppable);
				}, 20);
			},
			
			/**
			 * Preload required thumbnails and on load add css to files.
			 * Return false if required file is not visible yet (in buffer) -
			 * required for old api to stop loading thumbnails.
			 *
			 * @param  Object  file hash -&gt; thumbnail map
			 * @return Boolean
			 */
			attachThumbnails = function(images) {
				var url = fm.option(&#x27;tmbUrl&#x27;),
					ret = true, 
					ndx;
				
				$.each(images, function(hash, tmb) {
					var node = cwd.find(&#x27;#&#x27;+hash);

					if (node.length) {

						(function(node, tmb) {
							$(&#x27;&lt;img/&gt;&#x27;)
								.load(function() { node.find(&#x27;.elfinder-cwd-icon&#x27;).css(&#x27;background&#x27;, &quot;url(&#x27;&quot;+tmb+&quot;&#x27;) center center no-repeat&quot;); })
								.attr(&#x27;src&#x27;, tmb);
						})(node, url+tmb);
					} else {
						ret = false;
						if ((ndx = index(hash)) != -1) {
							buffer[ndx].tmb = tmb;
						}
					}
				});
				return ret;
			},
			
			/**
			 * Load thumbnails from backend.
			 *
			 * @param  Array|Boolean  files hashes list for new api | true for old api
			 * @return void
			 */
			loadThumbnails = function(files) {
				var tmbs = [];
				
				if (fm.oldAPI) {
					fm.request({
						data : {cmd : &#x27;tmb&#x27;, current : fm.cwd().hash},
						preventFail : true
						})
						.done(function(data) {
							if (attachThumbnails(data.images||[]) &amp;&amp; data.tmb) {
								loadThumbnails();
							}
						});
					return;
				} 

				tmbs = tmbs = files.splice(0, tmbNum);
				if (tmbs.length) {
					fm.request({
						data : {cmd : &#x27;tmb&#x27;, targets : tmbs},
						preventFail : true
					})
					.done(function(data) {
						if (attachThumbnails(data.images||[])) {
							loadThumbnails(files);
						}
					});
				}
			},
			
			/**
			 * Add new files to cwd/buffer
			 *
			 * @param  Array  new files
			 * @return void
			 */
			add = function(files) {
				var place    = list ? cwd.find(&#x27;tbody&#x27;) : cwd,
					l        = files.length, 
					ltmb     = [],
					atmb     = {},
					dirs     = false,
					findNode = function(file) {
						var pointer = cwd.find(&#x27;[id]:first&#x27;), file2;

						while (pointer.length) {
							file2 = fm.file(pointer.attr(&#x27;id&#x27;));
							if (!pointer.is(&#x27;.elfinder-cwd-parent&#x27;) &amp;&amp; file2 &amp;&amp; fm.compare(file, file2) &lt; 0) {
								return pointer;
							}
							pointer = pointer.next(&#x27;[id]&#x27;);
						}
					},
					findIndex = function(file) {
						var l = buffer.length, i;
						
						for (i =0; i &lt; l; i++) {
							if (fm.compare(file, buffer[i]) &lt; 0) {
								return i;
							}
						}
						return l || -1;
					},
					file, hash, node, ndx;

				
				while (l--) {
					file = files[l];
					hash = file.hash;
					
					if (cwd.find(&#x27;#&#x27;+hash).length) {
						continue;
					}
					
					if ((node = findNode(file)) &amp;&amp; node.length) {
						node.before(itemhtml(file)); 
					} else if ((ndx = findIndex(file)) &gt;= 0) {
						buffer.splice(ndx, 0, file);
					} else {
						place.append(itemhtml(file));
					}
					
					if (cwd.find(&#x27;#&#x27;+hash).length) {
						if (file.mime == &#x27;directory&#x27;) {
							dirs = true;
						} else if (file.tmb) {
							file.tmb === 1 ? ltmb.push(hash) : (atmb[hash] = file.tmb);
						}
					}
				}
				
				attachThumbnails(atmb);
				ltmb.length &amp;&amp; loadThumbnails(ltmb);
				dirs &amp;&amp; makeDroppable();
			},
			
			/**
			 * Remove files from cwd/buffer
			 *
			 * @param  Array  files hashes
			 * @return void
			 */
			remove = function(files) {
				var l = files.length, hash, n, ndx;
				
				while (l--) {
					hash = files[l];
					if ((n = cwd.find(&#x27;#&#x27;+hash)).length) {
						try {
							n.detach();
						} catch(e) {
							fm.debug(&#x27;error&#x27;, e);
						}
					} else if ((ndx = index(hash)) != -1) {
						buffer.splice(ndx, 1);
					}
				}
			},
			
			msg = {
				name : fm.i18n(&#x27;name&#x27;),
				perm : fm.i18n(&#x27;perms&#x27;),
				mod  : fm.i18n(&#x27;modify&#x27;),
				size : fm.i18n(&#x27;size&#x27;),
				kind : fm.i18n(&#x27;kind&#x27;)
			},
			
			/**
			 * Update directory content
			 *
			 * @param  Array  files
			 * @return void
			 */
			content = function(files, any) {
				var phash = fm.cwd().hash; 
				// console.log(files)
				
				unselectAll();
				
				try {
					// to avoid problem with draggable
					cwd.children(&#x27;table,&#x27;+fileSelector).remove();
				} catch (e) {
					cwd.html(&#x27;&#x27;);
				}

				cwd.removeClass(&#x27;elfinder-cwd-view-icons elfinder-cwd-view-list&#x27;)
					.addClass(&#x27;elfinder-cwd-view-&#x27;+(list ? &#x27;list&#x27; :&#x27;icons&#x27;));

				wrapper[list ? &#x27;addClass&#x27; : &#x27;removeClass&#x27;](&#x27;elfinder-cwd-wrapper-list&#x27;);

				list &amp;&amp; cwd.html(&#x27;&lt;table&gt;&lt;thead&gt;&lt;tr class=&quot;ui-state-default&quot;&gt;&lt;td &gt;&#x27;+msg.name+&#x27;&lt;/td&gt;&lt;td&gt;&#x27;+msg.perm+&#x27;&lt;/td&gt;&lt;td&gt;&#x27;+msg.mod+&#x27;&lt;/td&gt;&lt;td&gt;&#x27;+msg.size+&#x27;&lt;/td&gt;&lt;td&gt;&#x27;+msg.kind+&#x27;&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody/&gt;&lt;/table&gt;&#x27;);
		
				buffer = $.map(files, function(f) { return any || f.phash == phash ? f : null; });
				
				buffer = fm.sortFiles(buffer);
		
				wrapper.bind(scrollEvent, render).trigger(scrollEvent);
		
				phash = fm.cwd().phash;
				
				if (options.oldSchool &amp;&amp; phash &amp;&amp; !query) {
					var parent = $.extend(true, {}, fm.file(phash), {name : &#x27;..&#x27;, mime : &#x27;directory&#x27;});
					parent = $(itemhtml(parent))
						.addClass(&#x27;elfinder-cwd-parent&#x27;)
						.bind(&#x27;mousedown click mouseup touchstart touchmove touchend dblclick mouseenter&#x27;, function(e) {
						//.bind(&#x27;mousedown click mouseup dblclick mouseenter&#x27;, function(e) {
							e.preventDefault();
							e.stopPropagation();
						})
						.dblclick(function() {
							fm.exec(&#x27;open&#x27;, this.id);
						});

					(list ? cwd.find(&#x27;tbody&#x27;) : cwd).prepend(parent);
				}
				
			},
			
			/**
			 * CWD node itself
			 *
			 * @type JQuery
			 **/
			cwd = $(this)
				.addClass(&#x27;ui-helper-clearfix elfinder-cwd&#x27;)
				.attr(&#x27;unselectable&#x27;, &#x27;on&#x27;)
				// fix ui.selectable bugs and add shift+click support 
				.delegate(fileSelector, &#x27;click.&#x27;+fm.namespace, function(e) {
					var p    = this.id ? $(this) : $(this).parents(&#x27;[id]:first&#x27;), 
						prev = p.prevAll(&#x27;.&#x27;+clSelected+&#x27;:first&#x27;),
						next = p.nextAll(&#x27;.&#x27;+clSelected+&#x27;:first&#x27;),
						pl   = prev.length,
						nl   = next.length,
						sib;

					e.stopImmediatePropagation();

					if (e.shiftKey &amp;&amp; (pl || nl)) {
						sib = pl ? p.prevUntil(&#x27;#&#x27;+prev.attr(&#x27;id&#x27;)) : p.nextUntil(&#x27;#&#x27;+next.attr(&#x27;id&#x27;));
						sib.add(p).trigger(evtSelect);
					} else if (e.ctrlKey || e.metaKey) {
						p.trigger(p.is(&#x27;.&#x27;+clSelected) ? evtUnselect : evtSelect);
					} else {
						if ($(this).data(&#x27;touching&#x27;) &amp;&amp; p.is(&#x27;.&#x27;+clSelected)) {
							$(this).data(&#x27;touching&#x27;, null);
							fm.dblclick({file : this.id});
							unselectAll();
						} else {
							unselectAll();
							p.trigger(evtSelect);
						}
					}

					trigger();
				})
				// call fm.open()
				.delegate(fileSelector, &#x27;dblclick.&#x27;+fm.namespace, function(e) {
					fm.dblclick({file : this.id});
				})
				// for touch device
				.delegate(fileSelector, &#x27;touchstart.&#x27;+fm.namespace, function(e) {
					$(this).data(&#x27;touching&#x27;, true);
					var p = this.id ? $(this) : $(this).parents(&#x27;[id]:first&#x27;),
					  sel = p.prevAll(&#x27;.&#x27;+clSelected+&#x27;:first&#x27;).length +
					        p.nextAll(&#x27;.&#x27;+clSelected+&#x27;:first&#x27;).length;
					$(this).data(&#x27;longtap&#x27;, setTimeout(function(){
						// long tap
						p.trigger(p.is(&#x27;.&#x27;+clSelected) ? evtUnselect : evtSelect);
						trigger();
						if (sel == 0 &amp;&amp; p.is(&#x27;.&#x27;+clSelected)) {
							p.trigger(&#x27;click&#x27;);
							trigger();
						} 
					}, 500));
				})
				.delegate(fileSelector, &#x27;touchmove.&#x27;+fm.namespace+&#x27; touchend.&#x27;+fm.namespace, function(e) {
					clearTimeout($(this).data(&#x27;longtap&#x27;));
				})
				// attach draggable
				.delegate(fileSelector, &#x27;mouseenter.&#x27;+fm.namespace, function(e) {
					var $this = $(this),
						target = list ? $this : $this.children();

					if (!$this.is(&#x27;.&#x27;+clTmp) &amp;&amp; !target.is(&#x27;.&#x27;+clDraggable+&#x27;,.&#x27;+clDisabled)) {
						target.draggable(fm.draggable);
					}
				})
				// add hover class to selected file
				.delegate(fileSelector, evtSelect, function(e) {
					var $this = $(this), 
						id    = $this.attr(&#x27;id&#x27;);
					
					if (!selectLock &amp;&amp; !$this.is(&#x27;.&#x27;+clDisabled)) {
						$this.addClass(clSelected).children().addClass(clHover);
						if ($.inArray(id, selectedFiles) === -1) {
							selectedFiles.push(id);
						}
					}
				})
				// remove hover class from unselected file
				.delegate(fileSelector, evtUnselect, function(e) {
					var $this = $(this), 
						id    = $this.attr(&#x27;id&#x27;),
						ndx;
					
					if (!selectLock) {
						$(this).removeClass(clSelected).children().removeClass(clHover);
						ndx = $.inArray(id, selectedFiles);
						if (ndx !== -1) {
							selectedFiles.splice(ndx, 1);
						}
					}
					
				})
				// disable files wich removing or moving
				.delegate(fileSelector, evtDisable, function() {
					var $this  = $(this).removeClass(clSelected).addClass(clDisabled), 
						target = (list ? $this : $this.children()).removeClass(clHover);
					
					$this.is(&#x27;.&#x27;+clDroppable) &amp;&amp; $this.droppable(&#x27;disable&#x27;);
					target.is(&#x27;.&#x27;+clDraggable) &amp;&amp; target.draggable(&#x27;disable&#x27;);
					!list &amp;&amp; target.removeClass(clDisabled);
				})
				// if any files was not removed/moved - unlock its
				.delegate(fileSelector, evtEnable, function() {
					var $this  = $(this).removeClass(clDisabled), 
						target = list ? $this : $this.children();
					
					$this.is(&#x27;.&#x27;+clDroppable) &amp;&amp; $this.droppable(&#x27;enable&#x27;);	
					target.is(&#x27;.&#x27;+clDraggable) &amp;&amp; target.draggable(&#x27;enable&#x27;);
				})
				.delegate(fileSelector, &#x27;scrolltoview&#x27;, function() {
					scrollToView($(this));
				})
				.delegate(fileSelector, &#x27;mouseenter.&#x27;+fm.namespace+&#x27; mouseleave.&#x27;+fm.namespace, function(e) {
					fm.trigger(&#x27;hover&#x27;, {hash : $(this).attr(&#x27;id&#x27;), type : e.type});
					$(this).toggleClass(&#x27;ui-state-hover&#x27;);
				})
				.bind(&#x27;contextmenu.&#x27;+fm.namespace, function(e) {
					var file = $(e.target).closest(&#x27;.&#x27;+clFile);
					
					if (file.length) {
						e.stopPropagation();
						e.preventDefault();
						if (!file.is(&#x27;.&#x27;+clDisabled)) {
							if (!file.is(&#x27;.&#x27;+clSelected)) {
								// cwd.trigger(&#x27;unselectall&#x27;);
								unselectAll();
								file.trigger(evtSelect);
								trigger();
							}
							fm.trigger(&#x27;contextmenu&#x27;, {
								&#x27;type&#x27;    : &#x27;files&#x27;,
								&#x27;targets&#x27; : fm.selected(),
								&#x27;x&#x27;       : e.clientX,
								&#x27;y&#x27;       : e.clientY
							});

						}
						
					}
					// e.preventDefault();
					
					
				})
				// unselect all on cwd click
				.bind(&#x27;click.&#x27;+fm.namespace, function(e) {
					!e.shiftKey &amp;&amp; !e.ctrlKey &amp;&amp; !e.metaKey &amp;&amp; unselectAll();
				})
				
				// make files selectable
				.selectable({
					filter     : fileSelector,
					stop       : trigger,
					delay      : 250,
					selected   : function(e, ui) { $(ui.selected).trigger(evtSelect); },
					unselected : function(e, ui) { $(ui.unselected).trigger(evtUnselect); }
				})
				// make cwd itself droppable for folders from nav panel
				.droppable(droppable)
				// prepend fake file/dir
				.bind(&#x27;create.&#x27;+fm.namespace, function(e, file) {
					var parent = list ? cwd.find(&#x27;tbody&#x27;) : cwd,
						p = parent.find(&#x27;.elfinder-cwd-parent&#x27;),
						file = $(itemhtml(file)).addClass(clTmp);
						
					unselectAll();

					if (p.length) {
						p.after(file);
					} else {
						parent.prepend(file);
					}
					
					cwd.scrollTop(0);
				})
				// unselect all selected files
				.bind(&#x27;unselectall&#x27;, unselectAll)
				.bind(&#x27;selectfile&#x27;, function(e, id) {
					cwd.find(&#x27;#&#x27;+id).trigger(evtSelect);
					trigger();
				}),
			wrapper = $(&#x27;&lt;div class=&quot;elfinder-cwd-wrapper&quot;/&gt;&#x27;)
				.bind(&#x27;contextmenu&#x27;, function(e) {
					e.preventDefault();
					fm.trigger(&#x27;contextmenu&#x27;, {
						&#x27;type&#x27;    : &#x27;cwd&#x27;,
						&#x27;targets&#x27; : [fm.cwd().hash],
						&#x27;x&#x27;       : e.clientX,
						&#x27;y&#x27;       : e.clientY
					});
					
				}),
			
			resize = function() {
				var h = 0;

				wrapper.siblings(&#x27;.elfinder-panel:visible&#x27;).each(function() {
					h += $(this).outerHeight(true);
				});

				wrapper.height(wz.height() - h);
			},
			
			// elfinder node
			parent = $(this).parent().resize(resize),
			// workzone node
			wz = parent.children(&#x27;.elfinder-workzone&#x27;).append(wrapper.append(this))
			;
			
		
		if (fm.dragUpload) {
			wrapper[0].addEventListener(&#x27;dragenter&#x27;, function(e) {
				e.preventDefault();
				e.stopPropagation();
				
				wrapper.addClass(clDropActive);
			}, false);

			wrapper[0].addEventListener(&#x27;dragleave&#x27;, function(e) {
				e.preventDefault();
				e.stopPropagation();
				e.target == cwd[0] &amp;&amp; wrapper.removeClass(clDropActive);
			}, false);

			wrapper[0].addEventListener(&#x27;dragover&#x27;, function(e) {
				e.preventDefault();
				e.stopPropagation();
			}, false);

			wrapper[0].addEventListener(&#x27;drop&#x27;, function(e) {
			  	e.preventDefault();
				wrapper.removeClass(clDropActive);
				var file = false;
				var type = &#x27;&#x27;;
				var data = null;
				try{
					data = e.dataTransfer.getData(&#x27;text/html&#x27;);
				} catch(e) {}
				if (data) {
					file = [ data ];
					type = &#x27;html&#x27;;
				} else if (data = e.dataTransfer.getData(&#x27;text&#x27;)) {
					file = [ data ];
					type = &#x27;text&#x27;;
				} else if (e.dataTransfer &amp;&amp; e.dataTransfer.items &amp;&amp;  e.dataTransfer.items.length) {
					file = e.dataTransfer;
					type = &#x27;data&#x27;;
				} else if (e.dataTransfer &amp;&amp; e.dataTransfer.files &amp;&amp;  e.dataTransfer.files.length) {
					file = e.dataTransfer.files;
					type = &#x27;files&#x27;;
				}
				if (file) {
					fm.exec(&#x27;upload&#x27;, {files : file, type : type});
				}
			}, false);
		}

		fm
			.bind(&#x27;open&#x27;, function(e) {
				content(e.data.files);
			})
			.bind(&#x27;search&#x27;, function(e) {
				lastSearch = e.data.files;
				content(lastSearch, true);
			})
			.bind(&#x27;searchend&#x27;, function() {
				lastSearch = [];
				if (query) {
					query = &#x27;&#x27;;
					content(fm.files());
				}
			})
			.bind(&#x27;searchstart&#x27;, function(e) {
				query = e.data.query;
			})
			.bind(&#x27;sortchange&#x27;, function() {
				content(query ? lastSearch : fm.files(), !!query);
			})
			.bind(&#x27;viewchange&#x27;, function() {
				var sel = fm.selected(),
					l   = fm.storage(&#x27;view&#x27;) == &#x27;list&#x27;;
				
				if (l != list) {
					list = l;
					content(fm.files());

					$.each(sel, function(i, h) {
						selectFile(h);
					});
					trigger();
				}
				resize();
			})
			.add(function(e) {
				var phash = fm.cwd().hash,
					files = query
						? $.map(e.data.added || [], function(f) { return f.name.indexOf(query) === -1 ? null : f ;})
						: $.map(e.data.added || [], function(f) { return f.phash == phash ? f : null; })
						;
				add(files);
			})
			.change(function(e) {
				var phash = fm.cwd().hash,
					sel   = fm.selected(),
					files;

				if (query) {
					$.each(e.data.changed || [], function(i, file) {
						remove([file.hash]);
						if (file.name.indexOf(query) !== -1) {
							add([file]);
							$.inArray(file.hash, sel) !== -1 &amp;&amp; selectFile(file.hash);
						}
					});
				} else {
					$.each($.map(e.data.changed || [], function(f) { return f.phash == phash ? f : null; }), function(i, file) {
						remove([file.hash]);
						add([file]);
						$.inArray(file.hash, sel) !== -1 &amp;&amp; selectFile(file.hash);
					});
				}
				
				trigger();
			})
			.remove(function(e) {
				remove(e.data.removed || []);
				trigger();
			})
			// fix cwd height if it less then wrapper
			.bind(&#x27;open add search searchend&#x27;, function() {
				cwd.css(&#x27;height&#x27;, &#x27;auto&#x27;);

				if (cwd.outerHeight(true) &lt; wrapper.height()) {
					cwd.height(wrapper.height() - (cwd.outerHeight(true) - cwd.height()) - 2);
				} 
			})
			// select dragged file if no selected, disable selectable
			.dragstart(function(e) {
				var target = $(e.data.target),
					oe     = e.data.originalEvent;

				if (target.is(fileSelector)) {
					
					if (!target.is(&#x27;.&#x27;+clSelected)) {
						!(oe.ctrlKey || oe.metaKey || oe.shiftKey) &amp;&amp; unselectAll();
						target.trigger(evtSelect);
						trigger();
					}
					cwd.droppable(&#x27;disable&#x27;);
				}
				
				cwd.selectable(&#x27;disable&#x27;).removeClass(clDisabled);
				selectLock = true;
			})
			// enable selectable
			.dragstop(function() {
				cwd.selectable(&#x27;enable&#x27;).droppable(&#x27;enable&#x27;);
				selectLock = false;
			})
			.bind(&#x27;lockfiles unlockfiles&#x27;, function(e) {
				var event = e.type == &#x27;lockfiles&#x27; ? evtDisable : evtEnable,
					files = e.data.files || [], 
					l     = files.length;
				
				while (l--) {
					cwd.find(&#x27;#&#x27;+files[l]).trigger(event);
				}
				trigger();
			})
			// select new files after some actions
			.bind(&#x27;mkdir mkfile duplicate upload rename archive extract&#x27;, function(e) {
				var phash = fm.cwd().hash, files;
				
				unselectAll();

				$.each(e.data.added || [], function(i, file) { 
					file &amp;&amp; file.phash == phash &amp;&amp; selectFile(file.hash);
				});
				trigger();
			})
			.shortcut({
				pattern     :&#x27;ctrl+a&#x27;, 
				description : &#x27;selectall&#x27;,
				callback    : selectAll
			})
			.shortcut({
				pattern     : &#x27;left right up down shift+left shift+right shift+up shift+down&#x27;,
				description : &#x27;selectfiles&#x27;,
				type        : &#x27;keydown&#x27; , //fm.UA.Firefox || fm.UA.Opera ? &#x27;keypress&#x27; : &#x27;keydown&#x27;,
				callback    : function(e) { select(e.keyCode, e.shiftKey); }
			})
			.shortcut({
				pattern     : &#x27;home&#x27;,
				description : &#x27;selectffile&#x27;,
				callback    : function(e) { 
					unselectAll();
					scrollToView(cwd.find(&#x27;[id]:first&#x27;).trigger(evtSelect));
					trigger();
				}
			})
			.shortcut({
				pattern     : &#x27;end&#x27;,
				description : &#x27;selectlfile&#x27;,
				callback    : function(e) { 
					unselectAll();
					scrollToView(cwd.find(&#x27;[id]:last&#x27;).trigger(evtSelect)) ;
					trigger();
				}
			});
		
	});
	
	// fm.timeEnd(&#x27;cwdLoad&#x27;)
	
	return this;
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
