<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app\components\tree\controllers.js - umi-cms-3</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="umi-cms-3"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ApplicationRoute.html">ApplicationRoute</a></li>
            
                <li><a href="../classes/ComponentController.html">ComponentController</a></li>
            
                <li><a href="../classes/dialogelfinder - open elFinder in dialog window.html">dialogelfinder - open elFinder in dialog window</a></li>
            
                <li><a href="../classes/DS.ManyArray.html">DS.ManyArray</a></li>
            
                <li><a href="../classes/elFinder - file manager for web.html">elFinder - file manager for web</a></li>
            
                <li><a href="../classes/elFinder command &quot;archive&quot;
Archive selected files.html">elFinder command &quot;archive&quot;
Archive selected files</a></li>
            
                <li><a href="../classes/elFinder command &quot;back&quot;
Open last visited folder.html">elFinder command &quot;back&quot;
Open last visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;copy&quot;.
Put files in filemanager clipboard..html">elFinder command &quot;copy&quot;.
Put files in filemanager clipboard.</a></li>
            
                <li><a href="../classes/elFinder command &quot;download&quot;. 
Download selected files.
Only for new api.html">elFinder command &quot;download&quot;. 
Download selected files.
Only for new api</a></li>
            
                <li><a href="../classes/elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;.html">elFinder command &quot;duplicate&quot;
Create file/folder copy with suffix &quot;copy Number&quot;</a></li>
            
                <li><a href="../classes/elFinder command &quot;edit&quot;. 
Edit text file in dialog window.html">elFinder command &quot;edit&quot;. 
Edit text file in dialog window</a></li>
            
                <li><a href="../classes/elFinder command &quot;extract&quot;
Extract files from archive.html">elFinder command &quot;extract&quot;
Extract files from archive</a></li>
            
                <li><a href="../classes/elFinder command &quot;forward&quot;
Open next visited folder.html">elFinder command &quot;forward&quot;
Open next visited folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc..html">elFinder command &quot;getfile&quot;. 
Return selected files info into outer callback.
For use elFinder with wysiwyg editors etc.</a></li>
            
                <li><a href="../classes/elFinder command &quot;help&quot;
&quot;About&quot; dialog.html">elFinder command &quot;help&quot;
&quot;About&quot; dialog</a></li>
            
                <li><a href="../classes/elFinder command &quot;info&quot;. 
Display dialog with file properties..html">elFinder command &quot;info&quot;. 
Display dialog with file properties.</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkdir&quot;
Create new folder.html">elFinder command &quot;mkdir&quot;
Create new folder</a></li>
            
                <li><a href="../classes/elFinder command &quot;mkfile&quot;
Create new empty file.html">elFinder command &quot;mkfile&quot;
Create new empty file</a></li>
            
                <li><a href="../classes/elFinder command &quot;netmount&quot;
Mount network volume with user credentials..html">elFinder command &quot;netmount&quot;
Mount network volume with user credentials.</a></li>
            
                <li><a href="../classes/elFinder command &quot;open&quot;
Enter folder or open files in new windows.html">elFinder command &quot;open&quot;
Enter folder or open files in new windows</a></li>
            
                <li><a href="../classes/elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created.html">elFinder command &quot;paste&quot;
Paste filesfrom clipboard into directory.
If files pasted in its parent directory - files duplicates will created</a></li>
            
                <li><a href="../classes/elFinder command &quot;quicklook&quot;
Fast preview for some files types.html">elFinder command &quot;quicklook&quot;
Fast preview for some files types</a></li>
            
                <li><a href="../classes/elFinder command &quot;reload&quot;
Sync files and folders.html">elFinder command &quot;reload&quot;
Sync files and folders</a></li>
            
                <li><a href="../classes/elFinder command &quot;rename&quot;. 
Rename selected file..html">elFinder command &quot;rename&quot;. 
Rename selected file.</a></li>
            
                <li><a href="../classes/elFinder command &quot;resize&quot;
Open dialog to resize image.html">elFinder command &quot;resize&quot;
Open dialog to resize image</a></li>
            
                <li><a href="../classes/elFinder command &quot;rm&quot;
Delete files.html">elFinder command &quot;rm&quot;
Delete files</a></li>
            
                <li><a href="../classes/elFinder command &quot;search&quot;
Find files.html">elFinder command &quot;search&quot;
Find files</a></li>
            
                <li><a href="../classes/elFinder command &quot;sort&quot;
Change sort files rule.html">elFinder command &quot;sort&quot;
Change sort files rule</a></li>
            
                <li><a href="../classes/elFinder command &quot;up&quot;
Go into parent directory.html">elFinder command &quot;up&quot;
Go into parent directory</a></li>
            
                <li><a href="../classes/elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop.html">elFinder command &quot;upload&quot;
Upload files using iframe or XMLHttpRequest &amp; FormData.
Dialog allow to send files using drag and drop</a></li>
            
                <li><a href="../classes/elFinder command &quot;view&quot;
Change current directory view (icons/list).html">elFinder command &quot;view&quot;
Change current directory view (icons/list)</a></li>
            
                <li><a href="../classes/elFinder contextmenu.html">elFinder contextmenu</a></li>
            
                <li><a href="../classes/elFinder dialog.html">elFinder dialog</a></li>
            
                <li><a href="../classes/elFinder folders tree.html">elFinder folders tree</a></li>
            
                <li><a href="../classes/elFinder places/favorites ui.html">elFinder places/favorites ui</a></li>
            
                <li><a href="../classes/elFinder toolbar.html">elFinder toolbar</a></li>
            
                <li><a href="../classes/elFinder toolbar button menu with sort variants..html">elFinder toolbar button menu with sort variants.</a></li>
            
                <li><a href="../classes/elFinder toolbar button to switch current directory view..html">elFinder toolbar button to switch current directory view.</a></li>
            
                <li><a href="../classes/elFinder toolbar button widget.
If command has variants - create menu.html">elFinder toolbar button widget.
If command has variants - create menu</a></li>
            
                <li><a href="../classes/elFinder toolbar search button widget..html">elFinder toolbar search button widget.</a></li>
            
                <li><a href="../classes/elFinder toolbar&#x27;s button tor upload file.html">elFinder toolbar&#x27;s button tor upload file</a></li>
            
                <li><a href="../classes/elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder.html">elFinder ui
Display current folder path in statusbar.
Click on folder name in path - open folder</a></li>
            
                <li><a href="../classes/elFinder ui
Display number of files/selected files and its size in statusbar.html">elFinder ui
Display number of files/selected files and its size in statusbar</a></li>
            
                <li><a href="../classes/elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods.html">elFinder.history
Store visited folders
and provide &quot;back&quot; and &quot;forward&quot; methods</a></li>
            
                <li><a href="../classes/elfindernav - elFinder container for diretories tree and places.html">elfindernav - elFinder container for diretories tree and places</a></li>
            
                <li><a href="../classes/elfinderworkzone - elFinder container for nav and current directory.html">elfinderworkzone - elFinder container for nav and current directory</a></li>
            
                <li><a href="../classes/IndexRoute.html">IndexRoute</a></li>
            
                <li><a href="../classes/Inflector.inflector.html">Inflector.inflector</a></li>
            
                <li><a href="../classes/map.html">map</a></li>
            
                <li><a href="../classes/UmiRESTAdapter.html">UmiRESTAdapter</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Router.html">Router</a></li>
            
                <li><a href="../modules/UMI.html">UMI</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: app\components\tree\controllers.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
define([&#x27;App&#x27;], function(UMI){
    &#x27;use strict&#x27;;
    return function(){

        UMI.TreeControlController = Ember.ObjectController.extend({
            /**
             Query params для текущего роута &#x27;Component&#x27;
             @property routeParams
             @type Object
             @default null
             */
            routeParams: null,
            /**
             Массив коллекций объектов
             @property collections
             @type Object
             @default null
             @example
                [{type: &quot;newsRubric&quot;, name: &quot;Новостные рубрики&quot;}]
             */
            collections: null,
            /**
             Возвращает корневой элемент
             @property root
             @type Object
             @return
             */
            root: function(){
                var results = [];
                var collections = this.get(&#x27;collections&#x27;);
                for(var i =0; i &lt; collections.length; i++){
                    var root = Ember.Object.create(collections[i]);
                    root.set(&#x27;root&#x27;, true);
                    root.set(&#x27;hasChildren&#x27;, true);
                    root.set(&#x27;id&#x27;, &#x27;root&#x27;);
                    root.set(&#x27;active&#x27;, true);
                    root.reopen({
                        childCount: function(){
                            return this.get(&#x27;children.length&#x27;);
                        }.property(&#x27;children.length&#x27;)
                    });
                    var nodes = this.store.find(root.get(&#x27;type&#x27;), {&#x27;filters[parent]&#x27;: &#x27;null()&#x27;, &#x27;fields&#x27;: &#x27;displayName,order,active,childCount,children,parent&#x27;});
                    var children = Ember.ArrayProxy.createWithMixins(Ember.SortableMixin, {
                        content: nodes,
                        sortProperties: [&#x27;order&#x27;, &#x27;id&#x27;],
                        sortAscending: true
                    });
                    root.set(&#x27;children&#x27;, children);
                    results.push(root);
                }
                return results;
            }.property(&#x27;collections&#x27;, &#x27;root.childCount&#x27;),
            filters: function(){
                return [
                    {
                        &quot;title&quot;: &quot;Показывать неактивные страницы&quot;,
                        &quot;property&quot;: &quot;active&quot;,
                        &quot;checked&quot;: &quot;checked&quot;,
                        &quot;name&quot;: &quot;inactive&quot;
                    }
                ];
            }.property(),
            hideFilters: {},
            /**
             Активный контекст
             */
            activeContext: null,
            actions: {
                filter: function(name, element){

                },
                /**
                 Сохранение результата drag and drop
                 @method updateSortOrder
                 @param String id ID перемещаемого объекта
                 @param String id ID нового родителя перемещаемого объекта
                 @param String id ID элемента после которого вставлен перемещаемый объект
                 @param Array Массив nextSibling следующие обьекты за перемещаемым объектом
                 */
                updateSortOrder: function(id, parentId, prevSiblingId, nextSibling){
                    var self = this;
                    var type = this.get(&#x27;collections&#x27;)[0].type;//TODO: а как же несколько коллекций?
                    var ids = nextSibling || [];
                    var moveParams = {};
                    var resource;
                    var sibling;
                    var node;
                    var parent;
                    var oldParentId;
                    var models = this.store.all(type);

                    node = models.findBy(&#x27;id&#x27;, id);
                    moveParams.object = {
                        &#x27;id&#x27;: node.get(&#x27;id&#x27;),
                        &#x27;version&#x27;: node.get(&#x27;version&#x27;)
                    };
                    oldParentId = node.get(&#x27;parent.id&#x27;) || &#x27;root&#x27;;


                    if(parentId &amp;&amp; parentId !== &#x27;root&#x27;){
                        parent = models.findBy(&#x27;id&#x27;, parentId);
                        moveParams.branch = {
                            &#x27;id&#x27;: parent.get(&#x27;id&#x27;),
                            &#x27;version&#x27;: parent.get(&#x27;version&#x27;)
                        };
                    }
                    if(prevSiblingId){
                        sibling = models.findBy(&#x27;id&#x27;, prevSiblingId);
                        moveParams.sibling = {
                            &#x27;id&#x27;: sibling.get(&#x27;id&#x27;),
                            &#x27;version&#x27;: sibling.get(&#x27;version&#x27;)
                        };
                    }

                    resource = [window.UmiSettings.baseApiURL];
                    resource.push(self.get(&#x27;routeParams&#x27;).module.module);
                    resource.push(self.get(&#x27;routeParams&#x27;).component.component);
                    resource.push(type);
                    resource.push(&#x27;move&#x27;);
                    resource = resource.join(&#x27;/&#x27;);
                    $.ajax({&#x27;type&#x27;: &#x27;POST&#x27;, &#x27;url&#x27;: resource, &#x27;data&#x27;: JSON.stringify(moveParams), &#x27;dataType&#x27;: &#x27;json&#x27;, &#x27;contentType&#x27;: &#x27;application/json&#x27;}).then(
                        function(){
                            ids.push(id);
                            var parentsUpdateRelation = [];
                            if(parentId !== oldParentId){
                                if(parentId &amp;&amp; parentId !== &#x27;root&#x27;){
                                    ids.push(parentId);
                                    parentsUpdateRelation.push(parentId);
                                }
                                if(oldParentId &amp;&amp; oldParentId !== &#x27;root&#x27;){
                                    ids.push(oldParentId);
                                    parentsUpdateRelation.push(oldParentId);
                                }
                            }
                            self.store.findByIds(type, ids).then(function(nodes){
                                nodes.invoke(&#x27;reload&#x27;);
                                var parent;
                                var promises = [];
                                for(var i = 0; i &lt; parentsUpdateRelation.length; i++){
                                    parent = models.findBy(&#x27;id&#x27;, parentsUpdateRelation[i]);
                                    parent.get(&#x27;children&#x27;).then(function(children){
                                        promises.push(children.reloadLinks());
                                    });
                                }

                                if(parentId === &#x27;root&#x27; || oldParentId === &#x27;root&#x27;){
                                    //TODO: Зачем загружать заново элементы которые уже есть?
                                    self.incrementProperty(&#x27;root.childCount&#x27;);
                                }
                            });
                        }
                    );
                }
            }
        });

        UMI.TreeItemController = Ember.ObjectController.extend({
            isLoaded: false,
            sortedChildren: function(){
                return Ember.ArrayProxy.createWithMixins(Ember.SortableMixin, {
                    content: this.get(&#x27;children&#x27;),
                    sortProperties: [&#x27;order&#x27;, &#x27;id&#x27;],
                    sortAscending: true
                });
            }.property(&#x27;children&#x27;),
            visible: function(){
                var counter = 0;
                var filters = this.get(&#x27;filters&#x27;);
                var filter;
                var model = this.get(&#x27;model&#x27;);
                for(filter in filters){
                    if(model.get(filter) === filters[filter]){
                        ++counter;
                    }
                }
                return (counter ? false : true);
            }.property(&#x27;model&#x27;, &#x27;filters&#x27;),
            filters: Ember.computed.alias(&quot;controllers.treeControl.hideFilters&quot;),
            needs: &#x27;treeControl&#x27;,
            isExpanded: function(){
                var activeContext = this.get(&#x27;controllers.treeControl.activeContext&#x27;);
                if(this.get(&#x27;id&#x27;) === &#x27;root&#x27;){
                    return true;
                } else{
                    if(activeContext.get(&#x27;id&#x27;) === &#x27;root&#x27;){
                        return false;
                    }
                    var contains = activeContext.get(&#x27;mpath&#x27;).contains(parseFloat(this.get(&#x27;id&#x27;)));
                    if(contains &amp;&amp; activeContext.get(&#x27;id&#x27;) !== this.get(&#x27;id&#x27;)){
                        return true;
                    } else{
                        return false;
                    }
                }
            }.property(&#x27;root&#x27;),
            actions: {
                expanded: function(){
                    this.set(&#x27;isExpanded&#x27;, !this.get(&#x27;isExpanded&#x27;));
                },
                fastAction: function(){
                    this.transitionToRoute(&#x27;context&#x27;, &#x27;add&#x27;);
                }
            }
        });
    };
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
